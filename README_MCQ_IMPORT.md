# MCQ Import Process for Heroku

This document outlines the process for importing MCQs from local JSON files to the Heroku application.

## Overview

The import process involves:

1. Creating a Django management command on Heroku
2. Uploading MCQ files to Heroku
3. Processing MCQs in batches to avoid timeouts
4. Setting verified answers as correct answers
5. Including explanation sections
6. Categorizing by subspecialty

## Prerequisites

- Heroku CLI installed and authenticated
- Access to the Heroku application (radiant-gorge-35079)
- Source MCQ files in JSON format

## Project Structure

The following files have been created to facilitate the import:

- `/mcq/management/commands/import_mcqs_heroku.py`: Django management command for importing MCQs
- `/import_mcqs_heroku.sh`: Shell script to upload and run the import command
- `/deploy_heroku_command.sh`: Script to deploy the management command to Heroku
- `/import_all_mcqs.sh`: Script to import all MCQs from a source directory
- `/HEROKU_MCQ_IMPORT.md`: Detailed documentation for the import process

## Step-by-Step Import Process

### 1. Deploy the Management Command to Heroku

First, deploy the Django management command to Heroku:

```bash
./deploy_heroku_command.sh
```

This script:
- Creates necessary directories on Heroku
- Uploads the management command
- Creates required __init__.py files

### 2. Import MCQs

You can import MCQs in two ways:

#### A. Import a Single File

```bash
./import_mcqs_heroku.sh path/to/mcq_file.json
```

Options:
- `--batch-size SIZE`: Number of MCQs to process in each batch (default: 50)
- `--sleep SECONDS`: Seconds to sleep between batches (default: 2)
- `--update`: Update existing MCQs if found
- `--dry-run`: Run without saving to database
- `--admin-username USERNAME`: Admin username for creating MCQs (default: admin)
- `--start-index INDEX`: Start processing from this index (default: 0)
- `--end-index INDEX`: Stop processing at this index (default: all)

#### B. Import All Files from Source Directory

```bash
./import_all_mcqs.sh
```

This script:
- Processes all JSON files in the source directory
- Uses optimized batch settings
- Creates a detailed log file
- Pauses between files to avoid Heroku timeouts

Options:
- `--source-dir DIR`: Source directory containing JSON files
- Same options as `import_mcqs_heroku.sh` for batch size, sleep, etc.

## Field Mapping

The import process maps fields as follows:

- `verified_answer` → `correct_answer` (prioritized if available)
- `subspecialty` or `primary_category` → `subspecialty`
- `explanation_sections` → `explanation_sections` (preserved as JSON)
- `verification_reasoning` → `explanation_sections.option_analysis`
- Filename (e.g., "RITE-2022") → `exam_type` and `exam_year`

## Troubleshooting

### Heroku Timeout Errors

If you encounter timeouts:
1. Reduce batch size: `--batch-size 10`
2. Increase sleep time: `--sleep 5`
3. Process files in smaller chunks using `--start-index` and `--end-index`

### Authentication Issues

If you encounter authentication errors:
1. Run `heroku login` to authenticate
2. Verify you have access to the app: `heroku apps:info -a radiant-gorge-35079`

### Import Failures

If imports fail:
1. Check the log file for error messages
2. Try a dry run first: `--dry-run`
3. Verify the JSON file format
4. Check if admin user exists on Heroku

## Monitoring

To monitor the import process:
1. Check the log file generated by `import_all_mcqs.sh`
2. View the Heroku logs: `heroku logs -t -a radiant-gorge-35079-2b52ba172c1e`
3. Check the Django admin interface for imported MCQs

## Post-Import Verification

After importing, verify the data:
1. Check total MCQ count on Heroku: `heroku run "python manage.py shell -c 'from mcq.models import MCQ; print(MCQ.objects.count())'" -a radiant-gorge-35079`
2. Verify subspecialty distribution: `heroku run "python manage.py shell -c 'from mcq.models import MCQ; from collections import Counter; print(Counter(MCQ.objects.values_list(\"subspecialty\", flat=True)))'" -a radiant-gorge-35079`
3. Manually check a few MCQs on the website to ensure verified answers are set correctly

## Source MCQs

The source MCQs are located in:
```
/Users/tariqalmatrudi/Documents/MCQs for the board/Previous MCQs/json explained
```

These MCQs have:
- Verified answers based on expert review
- Structured explanation sections
- Subspecialty categorization
- Exam type and year metadata

## Features Implemented

- ✅ Verified answers used as correct answers
- ✅ Verification reasoning added to explanation sections
- ✅ Structured explanation sections implemented
- ✅ Proper subspecialty mapping
- ✅ Exam type and year metadata included
- ✅ Transaction protection for database integrity
- ✅ Validation and detailed reporting

## Support

If you encounter any issues or have questions, please refer to:
- HEROKU_MCQ_IMPORT.md for detailed instructions
- README_MCQ_IMPORT.md (this file) for an overview of the process
- The log files for error messages