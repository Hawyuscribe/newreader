{% extends "mcq/base.html" %}
{% load static %}
{% load drive_filters %}
{% load exam_type_filters %}
{% load mcq_filters %}

{% block title %}MCQ #{{ mcq.question_number }} - Neurology MCQ Reader{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/modal_fix.css' %}">
<style>
    .option {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
    }
    .option-correct {
        background-color: rgba(40, 167, 69, 0.2);
        border-left: 5px solid #28a745;
    }
    .option-selected {
        background-color: rgba(0, 123, 255, 0.2);
        border-left: 5px solid #007bff;
    }
    .option-incorrect {
        background-color: rgba(220, 53, 69, 0.2);
        border-left: 5px solid #dc3545;
    }
    
    /* Strikethrough styling for eliminated options */
    .option-eliminated .form-check-label {
        text-decoration: line-through !important;
        opacity: 0.6 !important;
        color: #6c757d !important;
    }
    
    .option-eliminated {
        background-color: rgba(108, 117, 125, 0.1) !important;
        border-left: 3px solid #6c757d !important;
        transition: all 0.3s ease;
    }
    
    /* Clickable option styling */
    .option .form-check-label {
        cursor: default;
        user-select: none;
        transition: all 0.2s ease;
    }
    
    .option-text-content {
        display: inline;
        padding: 2px 4px;
        border-radius: 3px;
        transition: background-color 0.2s ease;
    }
    
    .option-text-content:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    /* Strikethrough mode active styling */
    .strikethrough-mode-active .option-text-content {
        cursor: pointer !important;
    }
    
    .strikethrough-mode-active .option-text-content:hover {
        background-color: rgba(108, 117, 125, 0.1);
        text-decoration: line-through;
        opacity: 0.8;
    }
    
    #explanation {
        display: none;
    }
    .flashcard-panel {
        margin-bottom: 20px;
    }
    .note-panel {
        margin-bottom: 20px;
    }
    .hidden {
        display: none;
    }
    
    /* Explanation editor workspace */
    .explanation-editor-nav {
        background: #f8f9fa;
        border-radius: 0.75rem;
        padding: 1.25rem 1rem;
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        position: sticky;
        top: 6.5rem;
    }

    .explanation-editor-nav h6 {
        letter-spacing: 0.08em;
    }

    .explanation-editor-nav .explanation-nav-btn {
        border: none;
        border-left: 3px solid transparent;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        text-align: left;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .explanation-editor-nav .explanation-nav-btn i {
        color: #0d6efd;
    }

    .explanation-editor-nav .explanation-nav-btn.active,
    .explanation-editor-nav .explanation-nav-btn:hover {
        background: rgba(13,110,253,0.1);
        border-left-color: #0d6efd;
        color: #0d6efd;
    }

    .explanation-editor-section.card {
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .explanation-editor-section .card-body {
        padding: 1.5rem;
    }

    .explanation-editor-section textarea {
        resize: vertical;
        min-height: 140px;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .explanation-editor-section .form-text {
        font-size: 0.85rem;
    }

    .explanation-record-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        transition: all 0.2s ease;
    }

    .explanation-record-btn.explanation-recording-active {
        background-color: rgba(220, 53, 69, 0.12);
        border-color: rgba(220, 53, 69, 0.35);
        color: #dc3545;
    }

    .explanation-record-btn:disabled {
        opacity: 0.7;
        pointer-events: none;
    }

    .explanation-record-status {
        display: none;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.8rem;
    }

    .explanation-record-status.active {
        display: inline-flex;
    }

    body.explanation-focus-active {
        background: #f8faff;
    }

    body.explanation-focus-active .explanation-editor-section.card {
        border-color: rgba(13,110,253,0.25);
        box-shadow: 0 0 0 3px rgba(13,110,253,0.12);
    }

    /* Animation for updated explanation content */
    @keyframes explanation-highlight {
        0% { background-color: rgba(25, 135, 84, 0.1); }
        100% { background-color: transparent; }
    }
    
    .explanation-updated {
        animation: explanation-highlight 3s ease;
    }
    
    /* Enhanced explanation content styling */
    .explanation-content {
        line-height: 1.6;
        font-size: 16px;
        color: #333;
    }

    /* AI explanation section enhancements */
    .ai-expl-nav {
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem;
        margin: 0 0 1.5rem;
        padding: 0.75rem;
        border-radius: 1rem;
        background: linear-gradient(135deg, rgba(14, 116, 233, 0.12), rgba(59, 130, 246, 0.05));
        border: 1px solid rgba(59, 130, 246, 0.18);
    }

    .ai-expl-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.45rem 1.05rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.9rem;
        background-color: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(15, 23, 42, 0.08);
        color: #0f172a;
        text-decoration: none;
        transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
    }

    .ai-expl-pill:hover {
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.12);
        border-color: rgba(15, 23, 42, 0.2);
    }

    .ai-expl-pill i {
        font-size: 1rem;
    }

    .ai-expl-pill--option-analysis {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.16), rgba(59, 130, 246, 0.12));
        color: #1d4ed8;
        border-color: rgba(37, 99, 235, 0.28);
    }

    .ai-expl-pill--brief-overview {
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.16), rgba(168, 85, 247, 0.12));
        color: #6d28d9;
        border-color: rgba(124, 58, 237, 0.25);
    }

    .ai-expl-pill--management {
        background: linear-gradient(135deg, rgba(5, 150, 105, 0.16), rgba(16, 185, 129, 0.1));
        color: #047857;
        border-color: rgba(5, 150, 105, 0.25);
    }

    .ai-expl-pill--key-pearls {
        background: linear-gradient(135deg, rgba(234, 88, 12, 0.16), rgba(249, 115, 22, 0.1));
        color: #c2410c;
        border-color: rgba(234, 88, 12, 0.25);
    }

    .ai-expl-section {
        border-radius: 18px;
        border: 1px solid rgba(15, 23, 42, 0.08);
        background-color: #fff;
        margin-bottom: 1.75rem;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
        overflow: hidden;
        position: relative;
    }

    .ai-expl-section::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 18px;
        pointer-events: none;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.14);
    }

    .ai-expl-section__header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1.1rem 1.4rem;
        font-size: 1.02rem;
        font-weight: 700;
        letter-spacing: 0.01em;
    }

    .ai-expl-section__icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2.35rem;
        height: 2.35rem;
        border-radius: 999px;
        background-color: rgba(255, 255, 255, 0.85);
        font-size: 1.2rem;
        box-shadow: 0 8px 16px rgba(15, 23, 42, 0.12);
    }

    .ai-expl-section__title {
        flex: 1;
    }

    .ai-expl-section__body {
        padding: 1.3rem 1.45rem 1.5rem;
    }

    .ai-expl-section__body > hr:first-child {
        display: none;
    }

    .ai-expl-section__body > p:first-child {
        margin-top: 0;
    }

    .ai-expl-section--option-analysis {
        border-left: 8px solid #2563eb;
    }

    .ai-expl-section--option-analysis .ai-expl-section__header {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.16), rgba(59, 130, 246, 0.1));
        color: #1d4ed8;
    }

    .ai-expl-section--option-analysis .ai-expl-section__icon {
        background: rgba(37, 99, 235, 0.2);
        color: #1d4ed8;
    }

    .ai-expl-section--brief-overview {
        border-left: 8px solid #7c3aed;
    }

    .ai-expl-section--brief-overview .ai-expl-section__header {
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.16), rgba(168, 85, 247, 0.1));
        color: #6d28d9;
    }

    .ai-expl-section--brief-overview .ai-expl-section__icon {
        background: rgba(124, 58, 237, 0.2);
        color: #6d28d9;
    }

    .ai-expl-section--management {
        border-left: 8px solid #059669;
    }

    .ai-expl-section--management .ai-expl-section__header {
        background: linear-gradient(135deg, rgba(5, 150, 105, 0.16), rgba(16, 185, 129, 0.1));
        color: #047857;
    }

    .ai-expl-section--management .ai-expl-section__icon {
        background: rgba(5, 150, 105, 0.2);
        color: #047857;
    }

    .ai-expl-section--key-pearls {
        border-left: 8px solid #ea580c;
    }

    .ai-expl-section--key-pearls .ai-expl-section__header {
        background: linear-gradient(135deg, rgba(234, 88, 12, 0.16), rgba(249, 115, 22, 0.1));
        color: #c2410c;
    }

    .ai-expl-section--key-pearls .ai-expl-section__icon {
        background: rgba(234, 88, 12, 0.2);
        color: #c2410c;
    }

    .ai-expl-subsection {
        border-radius: 14px;
        border: 1px solid rgba(15, 23, 42, 0.06);
        margin-bottom: 1rem;
        background-color: rgba(248, 250, 252, 0.9);
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
        overflow: hidden;
    }

    .ai-expl-subsection__header {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.85rem 1.1rem;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .ai-expl-subsection__icon {
        width: 2rem;
        height: 2rem;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(255, 255, 255, 0.85);
        box-shadow: 0 6px 14px rgba(15, 23, 42, 0.1);
        font-size: 1rem;
    }

    .ai-expl-subsection__body {
        padding: 0.9rem 1.1rem 1rem;
    }

    .ai-expl-subsection__body > p:first-child {
        margin-top: 0;
    }

    .ai-expl-subsection__body ul {
        margin-top: 0.75rem;
    }

    .ai-expl-subsection--pharm .ai-expl-subsection__header {
        background: linear-gradient(135deg, rgba(14, 165, 233, 0.18), rgba(3, 105, 161, 0.1));
        color: #0369a1;
    }

    .ai-expl-subsection--pharm .ai-expl-subsection__icon {
        color: #0369a1;
    }

    .ai-expl-subsection--nonpharm .ai-expl-subsection__header {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.18), rgba(16, 185, 129, 0.08));
        color: #047857;
    }

    .ai-expl-subsection--nonpharm .ai-expl-subsection__icon {
        color: #047857;
    }

    .ai-expl-subsection--counsel .ai-expl-subsection__header {
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.18), rgba(245, 158, 11, 0.08));
        color: #b45309;
    }

    .ai-expl-subsection--counsel .ai-expl-subsection__icon {
        color: #b45309;
    }
    
    /* Professional section-based explanation styling */
    .enhanced-explanation {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        color: #2c3e50;
        margin-bottom: 2rem;
    }
    
    .exam-source-info {
        background-color: #f0f7ff;
        padding: 0.75rem 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        font-size: 0.95rem;
        font-weight: 500;
        color: #0d6efd;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border-left: 3px solid #0d6efd;
    }
    
    .exam-source-info i {
        margin-right: 0.5rem;
        font-size: 1.1rem;
    }
    
    .explanation-section {
        margin-bottom: 1.75rem;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 5px rgba(0,0,0,0.08);
        background-color: #fff;
        border: 1px solid rgba(0,0,0,0.06);
        transition: all 0.3s ease;
    }
    
    .explanation-section:hover {
        box-shadow: 0 3px 12px rgba(0,0,0,0.1);
    }
    
    .explanation-section .section-header {
        display: flex;
        align-items: center;
        padding: 0.85rem 1.25rem;
        border-bottom: 1px solid rgba(0,0,0,0.06);
        background-color: #f8f9fa;
    }
    
    .explanation-section .section-header i {
        font-size: 1.25rem;
        margin-right: 0.75rem;
        color: #0d6efd;
    }
    
    .explanation-section .section-header h3 {
        margin: 0;
        font-size: 1.15rem;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .explanation-section .section-content {
        padding: 1.25rem;
        font-size: 1rem;
        line-height: 1.6;
    }

    .explanation-section .section-subtitle {
        border-top: 1px solid rgba(0,0,0,0.03);
        border-bottom: 1px solid rgba(0,0,0,0.03);
        background-color: rgba(248,249,250,0.6);
    }

    .legacy-explanation-sections .explanation-section {
        border-style: dashed;
    }

    .legacy-explanation-sections .section-header i {
        color: #6c757d;
    }
    
    /* Section-specific styling */
    .explanation-section.conceptual-framework-clinical-context .section-header {
        background-color: rgba(13, 110, 253, 0.08);
    }
    
    .explanation-section.conceptual-framework-clinical-context .section-header i {
        color: #0d6efd;
    }
    
    .explanation-section.key-concepts .section-header {
        background-color: rgba(255, 193, 7, 0.12);
    }
    
    .explanation-section.key-concepts .section-header i {
        color: #ffc107;
    }
    
    .explanation-section.pathophysiology .section-header {
        background-color: rgba(220, 53, 69, 0.08);
    }
    
    .explanation-section.pathophysiology .section-header i {
        color: #dc3545;
    }
    
    .explanation-section.diagnostic-criteria .section-header {
        background-color: rgba(25, 135, 84, 0.08);
    }
    
    .explanation-section.diagnostic-criteria .section-header i {
        color: #198754;
    }
    
    .explanation-section.differential-diagnosis .section-header {
        background-color: rgba(102, 16, 242, 0.08);
    }
    
    .explanation-section.differential-diagnosis .section-header i {
        color: #6610f2;
    }
    
    .explanation-section.management-principles .section-header {
        background-color: rgba(13, 202, 240, 0.08);
    }
    
    .explanation-section.management-principles .section-header i {
        color: #0dcaf0;
    }
    
    .explanation-section.clinical-pearls .section-header {
        background-color: rgba(111, 66, 193, 0.08);
    }
    
    .explanation-section.clinical-pearls .section-header i {
        color: #6f42c1;
    }
    
    .explanation-section.why-this-answer-is-correct .section-header {
        background-color: rgba(25, 135, 84, 0.08);
    }
    
    .explanation-section.why-this-answer-is-correct .section-header i {
        color: #198754;
    }
    
    .explanation-section.why-other-options-are-incorrect .section-header {
        background-color: rgba(220, 53, 69, 0.08);
    }
    
    .explanation-section.why-other-options-are-incorrect .section-header i {
        color: #dc3545;
    }
    
    .explanation-section.references .section-header {
        background-color: rgba(52, 58, 64, 0.08);
    }
    
    .explanation-section.references .section-header i {
        color: #343a40;
    }
    
    .explanation-section.follow-up .section-header {
        background-color: rgba(108, 117, 125, 0.08);
    }
    
    .explanation-section.follow-up .section-header i {
        color: #6c757d;
    }
    
    .explanation-section.default-explanation .section-header {
        background-color: rgba(13, 202, 240, 0.08);
    }
    
    .explanation-section.default-explanation .section-header i {
        color: #0dcaf0;
    }
    
    .verification-badge {
        display: inline-flex;
        align-items: center;
        background-color: #f8f9fa;
        padding: 0.35rem 0.75rem;
        border-radius: 3rem;
        margin-top: 1rem;
        font-size: 0.85rem;
        font-weight: 500;
        color: #198754;
        border: 1px solid rgba(25, 135, 84, 0.2);
    }
    
    .verification-badge i {
        font-size: 1rem;
        margin-right: 0.35rem;
        color: #198754;
    }
    
    /* Professional note style */
    .professional-note {
        border: 1px solid rgba(25, 135, 84, 0.2);
        border-left: 4px solid #198754;
    }
    
    /* Better table formatting */
    .explanation-content table, 
    .section-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5rem 0;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        border: 1px solid #dee2e6;
    }
    
    .explanation-content thead,
    .section-content thead {
        background-color: #f1f8ff;
        border-bottom: 2px solid #dee2e6;
    }
    
    .explanation-content th, 
    .section-content th {
        background-color: #f1f8ff;
        padding: 12px;
        text-align: center;
        font-weight: 600;
        color: #333;
        border: 1px solid #dee2e6;
    }
    
    .explanation-content td, 
    .section-content td {
        padding: 10px 12px;
        border: 1px solid #dee2e6;
        vertical-align: middle;
    }
    
    .explanation-content tr:nth-child(even), 
    .section-content tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .explanation-content table caption,
    .section-content table caption {
        font-style: italic;
        padding: 8px;
        caption-side: bottom;
        color: #6c757d;
        text-align: center;
        font-size: 0.9rem;
    }
    
    /* Better list formatting */
    .explanation-content ul, 
    .explanation-content ol,
    .section-content ul, 
    .section-content ol {
        padding-left: 1.75rem;
        margin: 1rem 0;
        line-height: 1.6;
    }
    
    .explanation-content li, 
    .section-content li {
        margin-bottom: 0.5rem;
        padding-left: 0.25rem;
    }
    
    .explanation-content ul li,
    .section-content ul li {
        list-style-type: disc;
    }
    
    .explanation-content ul li li,
    .section-content ul li li {
        list-style-type: circle;
    }
    
    /* Consistent heading styles */
    .explanation-content h1, 
    .explanation-content h2, 
    .explanation-content h3 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
        line-height: 1.3;
        color: #212529;
    }
    
    .explanation-content h1 {
        font-size: 1.75rem;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 0.5rem;
    }
    
    .explanation-content h2 {
        font-size: 1.5rem;
        padding-bottom: 0.3rem;
    }
    
    .explanation-content h3 {
        font-size: 1.25rem;
    }
    
    /* Better spacing for paragraphs */
    .explanation-content p,
    .section-content p {
        margin-bottom: 1rem;
        line-height: 1.6;
    }
    
    /* Improved references section */
    .references-section,
    .reference-box {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 1.25rem;
        margin: 1.5rem 0;
        border-left: 4px solid #0d6efd;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .references-header,
    .reference-header {
        font-weight: 600;
        color: #0d6efd;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
    }
    
    .references-header i,
    .reference-header i {
        margin-right: 0.5rem;
    }
    
    .references-list,
    .reference-content {
        font-size: 0.95rem;
        color: #495057;
    }
    
    /* Highlighted content box */
    .highlighted-box {
        background-color: #fff8e1;
        border-left: 4px solid #ffc107;
        padding: 1rem 1.25rem;
        margin: 1.5rem 0;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .highlighted-box p:last-child {
        margin-bottom: 0;
    }
    
    /* Verification box at the bottom of explanations */
    .verification-box {
        display: flex;
        align-items: center;
        background-color: #e8f4f8;
        border-radius: 8px;
        padding: 1rem 1.25rem;
        border: 1px solid rgba(13, 202, 240, 0.2);
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .verification-icon {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        background-color: #0dcaf0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        color: white;
        font-size: 1.25rem;
    }
    
    .verification-text {
        flex: 1;
    }
    
    .verification-text h5 {
        margin: 0 0 0.35rem 0;
        font-weight: 600;
        color: #0dcaf0;
        font-size: 1.1rem;
    }
    
    .verification-text p {
        margin: 0;
        color: #495057;
        font-size: 0.95rem;
    }
    
    .references-list {
        padding-left: 1.5rem;
        margin-bottom: 0;
    }
    
    .reference-item {
        margin-bottom: 0.75rem;
        line-height: 1.5;
    }
    
    /* Fix for reasoning button - lower z-index to stay behind modal */
    #launch-reasoning-pal {
        position: relative !important;
        z-index: 10 !important;  /* Much lower than modal (1050) and backdrop (1040) */
        pointer-events: auto !important;
        cursor: pointer !important;
    }
    
    #reasoning-pal-button-container {
        position: relative;
        z-index: 10;  /* Lower than modal */
        pointer-events: auto;
    }
    
    /* Bootstrap modal backdrop default z-index is 1040, modal is 1050 */
    /* Ensure button is completely hidden when modal is open */
    .modal-open #reasoning-pal-button-container {
        display: none !important;
    }
    
    /* Enhanced analysis content styling */
    .enhanced-analysis-content,
    .clinical-reasoning-analysis {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        line-height: 1.6;
        color: #2c3e50;
    }
    
    .analysis-header {
        color: #1565c0;
        font-size: 1.75rem;
        font-weight: 600;
        margin-bottom: 1rem;
        text-align: center;
    }
    
    .analysis-divider {
        border: 0;
        border-top: 3px solid #e9ecef;
        margin: 1.5rem 0;
    }
    
    .analysis-step {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .step-header {
        color: #1565c0;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
    }
    
    /* Answer assessment styling */
    .answer-assessment {
        background-color: #fff;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .answer-assessment.correct {
        border-left: 4px solid #28a745;
    }
    
    .answer-assessment.incorrect {
        border-left: 4px solid #dc3545;
    }
    
    .reasoning-header {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .reasoning-points,
    .clinical-features ul {
        list-style-type: none;
        padding-left: 0;
    }
    
    .reasoning-points li,
    .clinical-features li {
        position: relative;
        padding-left: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .reasoning-points li:before,
    .clinical-features li:before {
        content: "‚Üí";
        position: absolute;
        left: 0;
        color: #1565c0;
        font-weight: bold;
    }
    
    /* Clinical summary tables */
    .summary-table-container {
        margin-top: 2rem;
    }
    
    .clinical-summary-table,
    .key-features-table,
    .diagnostic-approach-table,
    .memory-aids-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.5rem;
        background-color: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .table-header {
        background-color: #1565c0;
        color: white;
        padding: 0.75rem;
        font-weight: 600;
        text-align: center;
    }
    
    .label-cell {
        background-color: #f8f9fa;
        padding: 0.75rem;
        font-weight: 600;
        width: 40%;
        border-bottom: 1px solid #dee2e6;
    }
    
    .value-cell {
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    .value-cell.correct {
        color: #28a745;
        font-weight: 600;
    }
    
    .value-cell.incorrect {
        color: #dc3545;
        font-weight: 600;
    }
    
    .memory-pattern {
        text-align: center;
        padding: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
        color: #1565c0;
        background-color: #e3f2fd;
    }
    
    /* Fix modal backdrop issues */
    .modal-backdrop {
        z-index: 1040 !important;
    }
    
    #clinical-reasoning-modal {
        z-index: 1050 !important;
    }
    
    /* Ensure modal backdrop is removed on close */
    body.modal-open {
        overflow: auto !important;
        padding-right: 0 !important;
    }
    
    /* Prettier divider lines */
    .explanation-content hr,
    .ai-pal-section hr,
    .ai-answer-content hr {
        margin: 1.5rem 0;
        border: 0;
        border-top: 1px solid #e9ecef;
    }
    
    /* Better blockquotes */
    .explanation-content blockquote,
    .ai-pal-section blockquote,
    .ai-answer-content blockquote {
        border-left: 4px solid #0d6efd;
        background-color: #f8f9fa;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 0 4px 4px 0;
    }
    
    /* AI Assistant Styling */
    .ai-pal-section .section-header {
        background-color: rgba(111, 66, 193, 0.1);
        border-left: 5px solid #6f42c1;
        padding: 0.75rem 1rem;
        border-radius: 4px 0 0 4px;
    }
    
    .ai-pal-section .section-header h2 {
        color: #6f42c1;
        margin: 0;
        font-size: 1.25rem;
    }
    
    .ai-pal-section .section-content {
        line-height: 1.6;
        padding: 1.25rem;
    }
    
    /* Also maintaining legacy AI assistant styling for compatibility */
    .ai-answer-card {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
        background-color: #ffffff;
    }
    
    .ai-answer-header {
        background-color: #6f42c1;
        color: white;
        padding: 12px 15px;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
    }
    
    .ai-answer-header i {
        margin-right: 8px;
    }
    
    .ai-answer-content {
        padding: 15px;
        line-height: 1.6;
    }
    
    .ai-answer-footer {
        padding: 8px 15px;
        border-top: 1px solid #e9ecef;
        text-align: right;
        font-style: italic;
        color: #6c757d;
    }
    
    /* Option badges */
    .option-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        margin-right: 8px;
        font-weight: bold;
        font-size: 0.9rem;
    }
    .option-A { background-color: #0d6efd; color: white; }
    .option-B { background-color: #198754; color: white; }
    .option-C { background-color: #ffc107; color: black; }
    .option-D { background-color: #dc3545; color: white; }
    .option-E { background-color: #6c757d; color: white; }
    
    /* Recording button styles for ReasoningPal */
    #reasoningRecordBtn.recording {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
    }
    
    /* Improved code blocks */
    .explanation-content code,
    .ai-pal-section code,
    .ai-answer-content code {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 2px 4px;
        font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        color: #d63384;
    }
    
    .explanation-content pre,
    .ai-pal-section pre,
    .ai-answer-content pre {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 1rem;
        margin: 1rem 0;
        overflow-x: auto;
        line-height: 1.45;
        border: 1px solid #e9ecef;
    }
    
    .explanation-content pre code,
    .ai-pal-section pre code,
    .ai-answer-content pre code {
        background-color: transparent;
        padding: 0;
        color: inherit;
    }

    .question-section {
        margin-bottom: 1.5rem;
    }

    .question-display {
        font-size: 1.05rem;
        line-height: 1.65;
        color: #1f2933;
    }

    .question-display p {
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}

{% if user.is_superuser %}
<!-- Admin Debug Console -->
<div id="admin-debug-console" style="position: fixed; top: 10px; right: 10px; width: 450px; max-height: 400px; overflow-y: auto; background: #1a1a1a; color: #00ff00; font-family: 'Courier New', monospace; font-size: 11px; border: 2px solid #333; border-radius: 8px; z-index: 10000; padding: 10px;">
    <div style="background: #333; color: #fff; padding: 5px; margin: -10px -10px 10px -10px; text-align: center; font-weight: bold;">
        üîß Admin Debug Console - MCQ {{ mcq.id }}
        <button onclick="document.getElementById('admin-debug-console').style.display='none'" style="float: right; background: #ff4444; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer;">√ó</button>
    </div>
    
    <!-- Case Conversion Debug Controls -->
    <div style="background: #2a2a2a; padding: 8px; margin-bottom: 10px; border-radius: 4px;">
        <div style="color: #ffaa00; font-weight: bold; margin-bottom: 5px;">üîç Case Conversion Debug</div>
        <button onclick="loadCaseConversionDebugInfo({{ mcq.id }})" style="background: #0066cc; color: white; border: none; padding: 3px 8px; margin: 2px; border-radius: 3px; cursor: pointer; font-size: 10px;">üîÑ Reload Debug Info</button>
        <button onclick="testMcqConversion({{ mcq.id }})" style="background: #cc6600; color: white; border: none; padding: 3px 8px; margin: 2px; border-radius: 3px; cursor: pointer; font-size: 10px;">üß™ Test Conversion</button>
        <button onclick="clearDebugLog()" style="background: #666; color: white; border: none; padding: 3px 8px; margin: 2px; border-radius: 3px; cursor: pointer; font-size: 10px;">üßπ Clear Log</button>
    </div>
    
    <div id="debug-log"></div>
</div>

<script>
window.__MCQ_CORE_ACTIVE = true;
// Custom console for admins
function debugLog(message, type) {
    type = type || 'log';
    const debugDiv = document.getElementById('debug-log');
    if (debugDiv) {
        const timestamp = new Date().toLocaleTimeString();
        const color = type === 'error' ? '#ff4444' : type === 'warn' ? '#ffaa00' : '#00ff00';
        debugDiv.innerHTML += '<div style="color: ' + color + '; margin-bottom: 3px;">[' + timestamp + '] ' + message + '</div>';
        debugDiv.scrollTop = debugDiv.scrollHeight;
    }
}

// Override console methods for admins
if (typeof console !== 'undefined') {
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    console.log = function() {
        const message = Array.prototype.slice.call(arguments).join(' ');
        debugLog(message, 'log');
        originalLog.apply(console, arguments);
    };

    console.error = function() {
        const message = Array.prototype.slice.call(arguments).join(' ');
        debugLog(message, 'error');
        originalError.apply(console, arguments);
    };

    console.warn = function() {
        const message = Array.prototype.slice.call(arguments).join(' ');
        debugLog(message, 'warn');
        originalWarn.apply(console, arguments);
    };
}

debugLog('MCQ Detail page loaded - JavaScript is working');
debugLog('Testing if JavaScript execution reaches this point...');

// Load case conversion debugging information for this MCQ
debugLog('üîÑ Loading MCQ case conversion debug info...');
loadCaseConversionDebugInfo({{ mcq.id }});

// Test if functions exist - wait for DOM to be fully ready
function checkSystemReadiness() {
    debugLog('DOMContentLoaded state: ' + document.readyState);
    debugLog('Bootstrap available: ' + (typeof bootstrap !== 'undefined'));
    debugLog('Modal element exists: ' + (!!document.getElementById('clinical-reasoning-modal')));
    debugLog('Function exists: ' + (typeof window.openClinicalReasoningAnalysis === 'function'));
    
    if (document.readyState !== 'complete') {
        debugLog('‚è≥ Waiting for DOM to complete...');
        setTimeout(checkSystemReadiness, 500);
        return;
    }
    
    if (typeof bootstrap === 'undefined') {
        debugLog('‚è≥ Waiting for Bootstrap to load...');
        setTimeout(checkSystemReadiness, 500);
        return;
    }
    
    if (!document.getElementById('clinical-reasoning-modal')) {
        debugLog('‚è≥ Waiting for modal element...');
        setTimeout(checkSystemReadiness, 500);
        return;
    }
    
    if (typeof window.openClinicalReasoningAnalysis !== 'function') {
        debugLog('‚ùå Function still not found after full load!');
    } else {
        debugLog('‚úÖ All systems ready - Clinical Reasoning Analysis should work!');
    }
}

// Case Conversion Debug System
function loadCaseConversionDebugInfo(mcqId) {
    debugLog(`üìä Fetching case conversion data for MCQ ${mcqId}...`);
    
    fetch(`{% url "debug_trace_mcq_conversion" mcq_id=0 %}`.replace('0', mcqId))
        .then(response => {
            if (response.status === 404) {
                debugLog('‚ÑπÔ∏è No existing case conversion debug data for this MCQ yet. This is expected until a conversion runs.', 'warn');
                return null;
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) {
                return;
            }
            debugLog('‚úÖ Case conversion data loaded successfully');
            displayCaseConversionDebugInfo(data);
        })
        .catch(error => {
            debugLog(`‚ùå Failed to load case conversion data: ${error.message}`, 'error');
        });
}

function displayCaseConversionDebugInfo(data) {
    const mcq = data.mcq;
    const sessions = data.conversion_sessions;
    const djangoSessions = data.django_sessions;
    
    debugLog(`üìù MCQ ${mcq.id}: ${mcq.subspecialty}`);
    debugLog(`üìÑ Question: ${mcq.question_preview}`);
    
    if (sessions.length === 0) {
        debugLog('üì≠ No conversion sessions found for this MCQ');
    } else {
        debugLog(`üìö Found ${sessions.length} conversion session(s):`);
        
        sessions.forEach((session, index) => {
            debugLog(`\nüîç Session ${index + 1} (ID: ${session.id}):`, 'warn');
            debugLog(`  Status: ${session.status}`);
            debugLog(`  Created: ${new Date(session.created_at).toLocaleString()}`);
            
            if (session.error_message) {
                debugLog(`  ‚ùå Error: ${session.error_message}`, 'error');
            }
            
            if (session.validation_details) {
                const val = session.validation_details;
                debugLog(`  üîç Validation:`);
                debugLog(`    Passed: ${val.passed ? '‚úÖ' : '‚ùå'}`);
                debugLog(`    Score: ${val.score}/100`);
                debugLog(`    Method: ${val.method}`);
                debugLog(`    Reason: ${val.reason}`);
                
                if (val.has_warnings) {
                    debugLog(`    ‚ö†Ô∏è Warnings: ${val.warning_count}`, 'warn');
                }
                
                if (val.issues && val.issues.length > 0) {
                    debugLog(`    Issues: ${val.issues.join('; ')}`, 'warn');
                }
                
                if (val.critical_issues && val.critical_issues.length > 0) {
                    debugLog(`    üö® Critical: ${val.critical_issues.join('; ')}`, 'error');
                }
            }
            
            if (session.case_details) {
                const details = session.case_details;
                debugLog(`  üë§ Patient: ${details.patient_demographics}`);
                debugLog(`  üè• Specialty: ${details.specialty}`);
                debugLog(`  üí° Concept: ${details.core_concept}`);
                debugLog(`  üìã Type: ${details.question_type}`);
                debugLog(`  ‚≠ê Difficulty: ${details.difficulty}`);
            }
            
            if (session.case_preview) {
                debugLog(`  üìÑ Case Preview: ${session.case_preview.substring(0, 100)}...`);
            }
            
            if (session.integrity_issues && session.integrity_issues.length > 0) {
                debugLog(`  üö® Integrity Issues: ${session.integrity_issues.join('; ')}`, 'error');
            }
            
            if (session.debug_log && session.debug_log.length > 0) {
                debugLog(`  üêõ Debug Log (last ${session.debug_log.length} entries):`);
                session.debug_log.forEach(entry => {
                    debugLog(`    [${entry.step}] ${typeof entry.data === 'object' ? JSON.stringify(entry.data).substring(0, 100) : entry.data.substring(0, 100)}...`);
                });
            }
        });
    }
    
    if (djangoSessions.length > 0) {
        debugLog(`\nüóÑÔ∏è Found ${djangoSessions.length} Django session(s) with case data:`);
        djangoSessions.forEach((session, index) => {
            debugLog(`  Session ${index + 1}: ${session.session_key.substring(0, 12)}... (MCQ: ${session.data.mcq_id})`);
        });
    } else {
        debugLog('üì≠ No Django sessions found with case data for this MCQ');
    }
    
    debugLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
}

function testMcqConversion(mcqId) {
    debugLog('üß™ Testing MCQ case conversion...', 'warn');
    
    // Use GET request since the view doesn't handle POST
    fetch('{% url "test_heroku_mcq_conversion" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        debugLog(`üîç Full response: ${JSON.stringify(data, null, 2)}`);
        if (data.success) {
            debugLog('‚úÖ Test conversion initiated successfully');
            debugLog(`Session ID: ${data.session_id}`);
            debugLog(`Task ID: ${data.test_data.task_id}`);
            debugLog(`MCQ ID: ${data.test_data.mcq.id}`);
            debugLog('‚è≥ Monitor test progress in console...');
            monitorTestConversion(data.session_id);
        } else {
            debugLog('‚ùå Test conversion failed to start', 'error');
            debugLog(`Error: ${data.error || 'Unknown error'}`, 'error');
        }
    })
    .catch(error => {
        debugLog(`‚ùå Test conversion request failed: ${error.message}`, 'error');
        debugLog(`Error details: ${error.stack}`, 'error');
    });
}

function monitorTestConversion(sessionId, pollCount = 0) {
    if (pollCount > 20) {  // Stop after 20 polls (about 2 minutes)
        debugLog('‚è∞ Test monitoring timeout reached', 'warn');
        return;
    }
    
    debugLog(`üì° Poll #${pollCount + 1} - Checking test conversion status...`);
    
    setTimeout(() => {
        loadCaseConversionDebugInfo({{ mcq.id }});
        monitorTestConversion(sessionId, pollCount + 1);
    }, 6000);  // Poll every 6 seconds
}

function clearDebugLog() {
    const debugDiv = document.getElementById('debug-log');
    if (debugDiv) {
        debugDiv.innerHTML = '';
        debugLog('üßπ Debug log cleared');
    }
}

// Add test conversion button functionality
debugLog('üîß Case conversion debugging tools loaded');
debugLog('üí° Available commands:');
debugLog('  - testMcqConversion({{ mcq.id }}) - Test case conversion for this MCQ');
debugLog('  - loadCaseConversionDebugInfo({{ mcq.id }}) - Reload conversion debug info');

// Background Task Monitoring System
let taskMonitoringActive = false;
let currentTaskSession = null;

function startBackgroundTaskMonitoring(sessionId, taskId) {
    debugLog(`üîÑ Background Task Monitor Started`, 'warn');
    debugLog(`Session ID: ${sessionId}`, 'log');
    debugLog(`Task ID: ${taskId}`, 'log');
    
    taskMonitoringActive = true;
    currentTaskSession = sessionId;
    
    monitorTaskProgress(sessionId, taskId);
}

function monitorTaskProgress(sessionId, taskId) {
    if (!taskMonitoringActive) {
        debugLog('üõë Task monitoring stopped', 'warn');
        return;
    }
    
    const pollCount = window.taskPollCount || 0;
    window.taskPollCount = pollCount + 1;
    
    debugLog(`üì° Poll #${window.taskPollCount} for session ${sessionId}`, 'log');
    
    fetch(`/cognitive_session/${sessionId}/status/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            debugLog(`üìä Task Status: ${data.status}`, data.status === 'ready' ? 'log' : 'warn');
            
            if (data.success && data.status === 'ready') {
                debugLog('‚úÖ Background task completed successfully!', 'log');
                const analysisQuality = data.analysis && data.analysis.reasoning_quality
                    ? data.analysis.reasoning_quality
                    : 'N/A';
                const confidenceScore = data.analysis && data.analysis.confidence_score
                    ? data.analysis.confidence_score
                    : 'N/A';
                debugLog(`Analysis Quality: ${analysisQuality}`, 'log');
                debugLog(`Confidence Score: ${confidenceScore}%`, 'log');
                taskMonitoringActive = false;
            } else if (data.status === 'failed') {
                debugLog('‚ùå Background task failed!', 'error');
                debugLog(`Error: ${data.error || 'Unknown error'}`, 'error');
                taskMonitoringActive = false;
            } else if (data.status === 'processing') {
                debugLog('‚è≥ Task still processing, will poll again...', 'warn');
                setTimeout(() => monitorTaskProgress(sessionId, taskId), 5000);
            } else {
                debugLog(`‚ö†Ô∏è Unexpected status: ${data.status}`, 'warn');
                setTimeout(() => monitorTaskProgress(sessionId, taskId), 5000);
            }
        })
        .catch(error => {
            debugLog(`üö® Polling Error: ${error.message}`, 'error');
            if (window.taskPollCount < 60) { // Continue polling if under limit
                setTimeout(() => monitorTaskProgress(sessionId, taskId), 5000);
            } else {
                debugLog('üõë Polling timeout reached, stopping monitor', 'error');
                taskMonitoringActive = false;
            }
        });
}

function stopBackgroundTaskMonitoring() {
    debugLog('üõë Stopping background task monitoring', 'warn');
    taskMonitoringActive = false;
    currentTaskSession = null;
    window.taskPollCount = 0;
}

// Celery Task Diagnostics
function diagnoseBackgroundTasks() {
    debugLog('üîç Running Background Task Diagnostics...', 'warn');
    
    // Check if we have an active session
    if (currentTaskSession) {
        debugLog(`Current Session: ${currentTaskSession}`, 'log');
        debugLog(`Monitoring Active: ${taskMonitoringActive}`, 'log');
        debugLog(`Poll Count: ${window.taskPollCount || 0}`, 'log');
    } else {
        debugLog('No active background task session', 'log');
    }
    
    // Check Celery worker availability
    fetch('/cognitive_session/test_worker_connectivity/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                debugLog('‚úÖ Worker connectivity: OK', 'log');
                debugLog(`Workers active: ${data.diagnostics.worker_count}`, 'log');
                debugLog(`Task registered: ${data.diagnostics.task_available}`, 'log');
                debugLog(`Broker: ${data.diagnostics.broker_url}`, 'log');
            } else {
                debugLog('‚ùå Worker connectivity: FAILED', 'error');
                debugLog(`Error: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            debugLog('‚ùå Worker connectivity: FAILED', 'error');
            debugLog(`Error: ${error.message}`, 'error');
        });
    
    // Check recent failed sessions
    debugLog('üîç Checking for recent failed sessions...', 'log');
    fetch('/cognitive_session/check_failed_sessions/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                debugLog(`üìä Sessions last 24h: ${data.stats.total_sessions_24h}`, 'log');
                debugLog(`‚ùå Failed: ${data.stats.failed_last_24h}`, data.stats.failed_last_24h > 0 ? 'error' : 'log');
                debugLog(`‚è≥ Stuck processing: ${data.stats.processing_stuck}`, data.stats.processing_stuck > 0 ? 'warn' : 'log');
                
                if (data.failed_sessions.length > 0) {
                    debugLog('Recent failures:', 'error');
                    data.failed_sessions.slice(0, 3).forEach(session => {
                        debugLog(`  Session ${session.id}: ${session.error_message} (${Math.round(session.time_ago)}m ago)`, 'error');
                    });
                }
                
                if (data.stuck_processing.length > 0) {
                    debugLog('Stuck sessions:', 'warn');
                    data.stuck_processing.forEach(session => {
                        debugLog(`  Session ${session.id}: ${session.status} for ${Math.round(session.time_ago)}m`, 'warn');
                    });
                }
            } else {
                debugLog(`‚ùå Failed to check sessions: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            debugLog(`üö® Session check error: ${error.message}`, 'error');
        });
}

// Add diagnostics button
function addDiagnosticsControls() {
    const debugDiv = document.getElementById('debug-log');
    if (debugDiv && !document.getElementById('diagnostics-controls')) {
        const controls = document.createElement('div');
        controls.id = 'diagnostics-controls';
        controls.style.cssText = 'margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;';
        controls.innerHTML = `
            <button onclick="diagnoseBackgroundTasks()" style="background: #0066cc; color: white; border: none; padding: 4px 8px; margin: 2px; border-radius: 3px; cursor: pointer; font-size: 10px;">üîç Diagnose Tasks</button>
            <button onclick="stopBackgroundTaskMonitoring()" style="background: #cc6600; color: white; border: none; padding: 4px 8px; margin: 2px; border-radius: 3px; cursor: pointer; font-size: 10px;">üõë Stop Monitor</button>
            <button onclick="document.getElementById('debug-log').innerHTML = ''" style="background: #666; color: white; border: none; padding: 4px 8px; margin: 2px; border-radius: 3px; cursor: pointer; font-size: 10px;">üóëÔ∏è Clear Log</button>
        `;
        debugDiv.parentNode.appendChild(controls);
    }
}

// Initialize diagnostics after page load
setTimeout(() => {
    addDiagnosticsControls();
}, 2000);

// Start checking after initial timeout
setTimeout(checkSystemReadiness, 1000);
</script>
{% else %}
<script>
console.log('MCQ Detail page loaded - JavaScript is working');
console.log('Testing if JavaScript execution reaches this point...');

// Test if functions exist
setTimeout(function() {
    console.log('DOMContentLoaded state:', document.readyState);
    console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
    console.log('Modal element exists:', !!document.getElementById('clinical-reasoning-modal'));
    console.log('Function exists:', typeof openClinicalReasoningAnalysis === 'function');
}, 1000);
</script>
{% endif %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>
            <small class="text-muted">{{ mcq.question_number }}</small>
            {% if mcq.exam_type or mcq.exam_year %}
            <small class="text-muted">
                {% if mcq.exam_type %}{{ mcq.exam_type }}{% endif %}
                {% if mcq.exam_year %}{{ mcq.exam_year }}{% endif %}
            </small>
            {% endif %}
        </h1>
    </div>
    <div class="col-md-4 text-md-end">
        <div class="d-flex justify-content-end gap-2 mb-2">
            <!-- Reclassify dropdown -->
            <div class="dropdown">
                <button class="btn btn-sm btn-dark dropdown-toggle" type="button" id="reclassifyDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-tag"></i> Reclassify
                </button>
                <div class="dropdown-menu" aria-labelledby="reclassifyDropdown">
                    <form action="{% url 'reclassify_mcq' mcq_id=mcq.id %}" method="post" class="px-3 py-2">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="subspecialty" class="form-label small">Subspecialty:</label>
                            <select class="form-select form-select-sm" id="subspecialty" name="subspecialty">
                                {% for subspecialty in SUBSPECIALTIES %}
                                <option value="{{ subspecialty }}" {% if mcq.subspecialty == subspecialty %}selected{% endif %}>
                                    {{ subspecialty }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-sm btn-dark w-100">Save</button>
                    </form>
                </div>
            </div>
            
            <!-- Report Question button -->
            <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#reportQuestionModal">
                <i class="bi bi-flag"></i> Report Question
            </button>
            
            <!-- Hide/Show button -->
            {% if is_hidden %}
            <form action="{% url 'unhide_mcq' mcq_id=mcq.id %}" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-success">
                    <i class="bi bi-eye"></i> Unhide
                </button>
            </form>
            {% else %}
            <form action="{% url 'hide_mcq' mcq_id=mcq.id %}" method="post" onsubmit="return confirm('Are you sure you want to hide this MCQ? It will no longer appear in your lists.');">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-secondary">
                    <i class="bi bi-eye-slash"></i> Hide
                </button>
            </form>
            {% endif %}
            
            <a href="{% url 'subspecialty' mcq.subspecialty %}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Back to {{ mcq.subspecialty }}
            </a>
        </div>
    </div>
</div>

<!-- Quick Action Buttons (Flashcard, Bookmark, Notes) at top -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between">
                    <!-- AI Improvement buttons -->
                    <div>
                        <form action="{% url 'improve_mcq' mcq_id=mcq.id %}" method="post" class="d-inline me-2">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-secondary" title="Only improves clarity and grammar without changing medical content">
                                <i class="bi bi-pencil"></i> Improve Question
                            </button>
                        </form>
                        
                        <form action="{% url 'new_options' mcq_id=mcq.id %}" method="post" class="d-inline me-2">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-list-check"></i> New Options
                            </button>
                        </form>
                    </div>
                    
                    <!-- User actions -->
                    <div>
                        <!-- Flashcard button with inline selection -->
                        {% if is_flashcard %}
                            <button class="btn btn-sm btn-warning me-2">
                                <i class="bi bi-card-list"></i> Flashcard Added
                            </button>
                        {% else %}
                            <form id="flashcardForm" action="{% url 'create_flashcard' mcq_id=mcq.id %}" method="post" class="d-inline-block me-2">
                                {% csrf_token %}
                                <div class="input-group input-group-sm">
                                    <select class="form-select form-select-sm" name="interval" id="flashcardInterval" aria-label="Flashcard interval">
                                        <option value="1" selected>1 day</option>
                                        <option value="3">3 days</option>
                                        <option value="7">7 days</option>
                                        <option value="14">2 weeks</option>
                                        <option value="30">1 month</option>
                                    </select>
                                    <button type="submit" class="btn btn-warning" id="addFlashcardBtn">
                                        <i class="bi bi-card-list"></i> Add Flashcard
                                    </button>
                                </div>
                            </form>
                        {% endif %}
                        
                        <!-- Bookmark button -->
                        <form action="{% url 'toggle_bookmark' mcq_id=mcq.id %}" method="post" class="d-inline me-2">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-{% if is_bookmarked %}danger{% else %}outline-danger{% endif %}">
                                <i class="bi bi-bookmark{% if is_bookmarked %}-check{% else %}-plus{% endif %}"></i> {% if is_bookmarked %}Bookmarked{% else %}Bookmark{% endif %}
                            </button>
                        </form>
                        
                        <!-- Notes button - toggles notes panel -->
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="toggleNotesPanel()">
                            <i class="bi bi-journal-text"></i> My Notes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notes Panel (initially hidden) -->
<div id="notes-panel" class="row mb-3" style="display: none;">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Personal Notes</h5>
            </div>
            <div class="card-body">
                <form action="{% url 'save_note' mcq_id=mcq.id %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <textarea class="form-control" id="note" name="note" rows="4" placeholder="Add your personal notes here...">{% if user_note %}{{ user_note.note_text }}{% endif %}</textarea>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="toggleNotesPanel()">Close</button>
                        <button type="submit" class="btn btn-info">
                            <i class="bi bi-save"></i> Save Notes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ReasoningPal Button Container -->
<div id="reasoning-pal-button-container" style="margin-top: 15px; display: block;" class="text-center mb-3">
    <!-- Button will be dynamically inserted by JavaScript after checking an answer -->
    <div class="reasoning-button-placeholder text-muted small">
        <i class="bi bi-info-circle"></i> Check your answer to see AI-powered reasoning analysis
    </div>
</div>

<!-- MCQ-to-Case Learning Button Container -->
<div id="case-learning-button-container" style="margin-top: 10px; display: none;" class="text-center mb-3">
    <button id="launch-case-learning" class="btn btn-info animate__animated animate__pulse" 
            style="margin-top: 5px;">
        <i class="bi bi-chat-dots"></i> Turn into Case-Based Learning
    </button>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- MCQ Question Card -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Question</h5>
                <div class="navigation-buttons">
                    {% if prev_mcq %}
                    <a href="{% url 'view_mcq' mcq_id=prev_mcq.id %}" class="btn btn-sm btn-outline-light me-1">
                        <i class="bi bi-arrow-left"></i> Previous
                    </a>
                    {% else %}
                    <button disabled class="btn btn-sm btn-outline-light me-1 opacity-50">
                        <i class="bi bi-arrow-left"></i> Previous
                    </button>
                    {% endif %}
                    
                    {% if next_mcq %}
                    <a href="{% url 'view_mcq' mcq_id=next_mcq.id %}" class="btn btn-sm btn-outline-light">
                        Next <i class="bi bi-arrow-right"></i>
                    </a>
                    {% else %}
                    <button disabled class="btn btn-sm btn-outline-light opacity-50">
                        Next <i class="bi bi-arrow-right"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if user.is_staff %}
                <!-- Admin Inline Editing Controls -->
                <div class="admin-edit-controls mb-3" style="border: 2px dashed #17a2b8; padding: 15px; border-radius: 8px; background-color: rgba(23, 162, 184, 0.05);">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-shield-check text-info me-2"></i>
                        <strong class="text-info">Admin Editing Mode</strong>
                        <button class="btn btn-sm btn-outline-info ms-auto" id="toggleEditMode">
                            <i class="bi bi-pencil"></i> Edit MCQ
                        </button>
                    </div>
                    <small class="text-muted">Click "Edit MCQ" to modify content directly from this page</small>
                </div>
                {% endif %}
                
                <!-- Question Text Section -->
                <div class="question-section">
                    {% if user.is_staff %}
                    <div class="edit-section" id="questionEditSection" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label text-muted small">
                                <i class="bi bi-question-circle"></i> Question Text
                            </label>
                            <textarea class="form-control" id="questionTextEdit" rows="4">{{ mcq.question_text }}</textarea>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-success" onclick="saveQuestion()">
                                    <i class="bi bi-check"></i> Save
                                </button>
                                <button class="btn btn-sm btn-primary js-ai-question">
                                    <i class="bi bi-magic"></i> Edit with AI
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="cancelEdit('question')">
                                    <i class="bi bi-x"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="card-text question-display" id="questionDisplay">
                        {{ mcq.question_text|linebreaksbr }}
                    </div>
                </div>

                <!-- Image Section -->
                {% if user.is_staff %}
                <div class="image-edit-section mb-3" id="imageEditSection" style="display: none;">
                    <div class="card border-info">
                        <div class="card-body">
                            <label class="form-label text-muted small">
                                <i class="bi bi-image"></i> Image URL
                            </label>
                            <input type="url" class="form-control mb-2" id="imageUrlEdit" value="{{ mcq.image_url|default:'' }}" 
                                   placeholder="https://example.com/image.jpg or Google Drive URL">
                            <small class="text-muted d-block mb-2">
                                Enter a direct image URL or a Google Drive sharing link. Google Drive links will be automatically converted.
                            </small>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-success" onclick="saveImage()">
                                    <i class="bi bi-check"></i> Save Image URL
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="cancelEdit('image')">
                                    <i class="bi bi-x"></i> Cancel
                                </button>
                                {% if mcq.image_url %}
                                <button class="btn btn-sm btn-danger" onclick="removeImage()">
                                    <i class="bi bi-trash"></i> Remove Image
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if mcq.image_url %}
                <div class="question-image-container mb-4" id="imageDisplay">
                    {% if mcq.image_url|is_google_drive_url %}
                    <!-- Google Drive images need iframe -->
                    <div style="position: relative; width: 100%; max-width: 600px; margin: 0 auto;">
                        <iframe src="{{ mcq.image_url|to_drive_preview_url }}" 
                                style="border: 0; width: 100%; height: 400px; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.12);"
                                allowfullscreen>
                        </iframe>
                    </div>
                    {% else %}
                    <!-- Regular images use img tag -->
                    <img src="{{ mcq.image_url }}" alt="Question Image" class="img-fluid rounded question-image border shadow-sm" style="max-height: 400px;">
                    {% endif %}
                </div>
                {% endif %}
                
                <form id="answerForm" action="{% url 'check_answer' mcq_id=mcq.id %}" method="post">
                    {% csrf_token %}
                    
                    <!-- Options Edit Section for Admins -->
                    {% if user.is_staff %}
                    <div class="options-edit-section mb-3" id="optionsEditSection" style="display: none;">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h6 class="card-title text-warning">
                                    <i class="bi bi-list-check"></i> Edit Options
                                </h6>
                                <div class="mb-3">
                                    <label class="form-label text-muted small">Option A</label>
                                    <textarea class="form-control form-control-sm" id="optionAEdit" rows="2">{{ mcq.options.0|default:'' }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-muted small">Option B</label>
                                    <textarea class="form-control form-control-sm" id="optionBEdit" rows="2">{{ mcq.options.1|default:'' }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-muted small">Option C</label>
                                    <textarea class="form-control form-control-sm" id="optionCEdit" rows="2">{{ mcq.options.2|default:'' }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-muted small">Option D</label>
                                    <textarea class="form-control form-control-sm" id="optionDEdit" rows="2">{{ mcq.options.3|default:'' }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-muted small">
                                        <i class="bi bi-check-circle"></i> Correct Answer
                                    </label>
                                    <select class="form-select form-select-sm" id="correctAnswerEdit">
                                        <option value="A" {% if mcq.correct_answer == "A" %}selected{% endif %}>A</option>
                                        <option value="B" {% if mcq.correct_answer == "B" %}selected{% endif %}>B</option>
                                        <option value="C" {% if mcq.correct_answer == "C" %}selected{% endif %}>C</option>
                                        <option value="D" {% if mcq.correct_answer == "D" %}selected{% endif %}>D</option>
                                        <option value="A, B" {% if mcq.correct_answer == "A, B" %}selected{% endif %}>A, B</option>
                                        <option value="A, C" {% if mcq.correct_answer == "A, C" %}selected{% endif %}>A, C</option>
                                        <option value="A, D" {% if mcq.correct_answer == "A, D" %}selected{% endif %}>A, D</option>
                                        <option value="B, C" {% if mcq.correct_answer == "B, C" %}selected{% endif %}>B, C</option>
                                        <option value="B, D" {% if mcq.correct_answer == "B, D" %}selected{% endif %}>B, D</option>
                                        <option value="C, D" {% if mcq.correct_answer == "C, D" %}selected{% endif %}>C, D</option>
                                        <option value="A, B, C" {% if mcq.correct_answer == "A, B, C" %}selected{% endif %}>A, B, C</option>
                                        <option value="A, B, D" {% if mcq.correct_answer == "A, B, D" %}selected{% endif %}>A, B, D</option>
                                        <option value="A, C, D" {% if mcq.correct_answer == "A, C, D" %}selected{% endif %}>A, C, D</option>
                                        <option value="B, C, D" {% if mcq.correct_answer == "B, C, D" %}selected{% endif %}>B, C, D</option>
                                        <option value="A, B, C, D" {% if mcq.correct_answer == "A, B, C, D" %}selected{% endif %}>A, B, C, D</option>
                                    </select>
                                </div>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-sm btn-success" onclick="saveOptions()">
                                        <i class="bi bi-check"></i> Save Options
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary js-ai-options">
                                        <i class="bi bi-magic"></i> Edit Options with AI
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit('options')">
                                        <i class="bi bi-x"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="text-muted small mb-3">
                        <i class="bi bi-info-circle"></i> Click "Strikethrough" button to enable elimination mode.
                    </div>
                    <div id="options">
                        {% if option_pairs %}
                            {% for option_letter, option_text in option_pairs %}
                                <div class="option" id="option-{{ option_letter }}">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="answer" id="answer-{{ option_letter }}" value="{{ option_letter }}">
                                        <label class="form-check-label" for="answer-{{ option_letter }}">
                                            <strong>{{ option_letter }}.</strong> <span class="option-text-content">{{ option_text }}</span>
                                        </label>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning">No options available for this MCQ.</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2 d-md-block mt-4">
                        <button type="button" id="checkAnswerBtn" class="btn btn-primary"
                                data-check-url="/mcq/{{ mcq.id }}/check_answer/"
                                data-mcq-id="{{ mcq.id }}">
                            <i class="bi bi-check-circle"></i> Check Answer
                        </button>
                        <button type="button" id="showExplanationBtn" class="btn {% if has_proper_explanation %}btn-outline-info{% else %}btn-outline-warning{% endif %}">
                            <i class="bi bi-{% if has_proper_explanation %}lightbulb{% else %}exclamation-triangle{% endif %}"></i> <span>{% if has_proper_explanation %}Show Explanation{% else %}Show Placeholder{% endif %}</span>
                        </button>
                        <button type="button" id="strikethroughToggleBtn" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-pencil-square"></i> Strikethrough
                        </button>
                    </div>
                    
                                    </form>
            </div>
        </div>
        
        <!-- Explanation Edit Section for Admins -->
        {% if user.is_staff %}
        <div class="explanation-edit-section mb-4" id="explanationEditSection" style="display: none;">
            <div class="card border-success">
                <div class="card-header bg-success text-white d-flex align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil-square me-2"></i> Edit Explanation
                    </h5>
                    <span class="badge bg-light text-success ms-3">Unified workspace</span>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="explanationUnifiedEdit" class="form-label fw-semibold">
                            Unified explanation
                        </label>
                        <textarea
                            class="form-control explanation-input"
                            id="explanationUnifiedEdit"
                            rows="14"
                            placeholder="Write or paste the full explanation here. Use headings (### Heading) or bullet points as needed."
                        >{{ initial_explanation_text }}</textarea>
                        <div class="form-text d-flex justify-content-between flex-wrap mt-2 small text-muted">
                            <span>Tip: include short headings (###) and concise bullet points for high-yield review.</span>
                            <span id="explanationCharCount">0 characters</span>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
                        <button type="button" class="btn btn-outline-primary js-ai-explanation-unified" data-ai-target="explanationUnifiedEdit">
                            <i class="bi bi-magic"></i> Edit with AI
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="explanationRecordBtn" data-record-target="explanationUnifiedEdit">
                            <i class="bi bi-mic"></i> Record
                        </button>
                        <span class="text-muted small" id="explanationRecordStatus"></span>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-success" onclick="saveExplanation()">
                            <i class="bi bi-check-circle"></i> Save explanation
                        </button>
                        <button class="btn btn-secondary" onclick="cancelEdit('explanation')">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- AI Instruction Modal -->
        <div class="modal fade" id="aiInstructionModal" tabindex="-1" aria-labelledby="aiInstructionModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="aiInstructionModalLabel">AI Custom Instructions</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted small mb-3" id="aiInstructionModalDescription">
                            Add optional guidance for the AI (tone, focus points, style). Leave blank to continue.
                        </p>
                        <textarea class="form-control" id="aiInstructionTextarea" rows="5" placeholder="Optional: describe how the AI should tailor its edits"></textarea>
                        <div class="d-flex align-items-center justify-content-between mt-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="aiInstructionRecordBtn">
                                <i class="bi bi-mic"></i> Record
                            </button>
                            <span class="text-muted small" id="aiInstructionRecordStatus"></span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="aiInstructionConfirmBtn">Continue</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Explanation Card -->
        <div class="card shadow mb-4" id="explanation">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Explanation {% if not has_proper_explanation %}<span class="badge bg-warning ms-2">Needs Generation</span>{% endif %}</h5>
            </div>
            <div class="card-body">
                <div class="explanation-content">
                    {% if mcq.primary_category or mcq.exam_type or mcq.exam_year %}
                    <div class="exam-source-info mb-4">
                        <i class="bi bi-info-circle"></i>
                        {% if mcq.primary_category %}<span class="badge bg-primary me-2">{{ mcq.primary_category }}</span>{% endif %}
                        {% if mcq.secondary_category %}<span class="badge bg-secondary me-2">{{ mcq.secondary_category }}</span>{% endif %}
                        {% if mcq.exam_type %}<span class="badge {{ mcq.exam_type|exam_type_badge_class }} me-2">{{ mcq.exam_type|display_exam_type }}</span>{% endif %}
                        {% if mcq.exam_year %}<span class="badge bg-info me-2">{{ mcq.exam_year }}</span>{% endif %}
                        {% if mcq.difficulty_level %}<span class="ms-2 badge bg-warning">{{ mcq.difficulty_level }}</span>{% endif %}
                    </div>
                    {% endif %}
                    {{ clean_explanation|safe }}
                    {% if mcq.key_concept %}
                    <div class="highlighted-box mt-4">
                        <strong>Key Concept:</strong> {{ mcq.key_concept }}
                    </div>
                    {% endif %}
                    {% if mcq.verification_confidence %}
                    <div class="verification-box mt-4">
                        <div class="verification-icon">
                            <i class="bi bi-check2-all"></i>
                        </div>
                        <div class="verification-text">
                            <h5>Verified Answer: {{ mcq.correct_answer }}</h5>
                            <p>Confidence: {{ mcq.verification_confidence }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Removed AI Analysis Card -->
        
        <!-- Ask AI Card -->
        <div class="card shadow mb-4">
            <div class="card-header bg-purple text-white" style="background-color: #6f42c1;">
                <h5 class="mb-0"><i class="bi bi-robot"></i> Ask AI-Pal</h5>
            </div>
            <div class="card-body">
                <div class="p-3 bg-light rounded mb-3">
                    <p class="small mb-1"><strong>Example questions you can ask:</strong></p>
                    <ul class="small example-questions mb-0">
                        <li>What's the pathophysiology behind this condition?</li>
                        <li>Why is option B wrong in this case?</li>
                        <li>How do I differentiate between these diagnoses?</li>
                        <li>What are the latest treatment guidelines for this?</li>
                        <li>Can you explain the neuroanatomy involved here?</li>
                    </ul>
                </div>

                <form id="askAIForm" action="{% url 'ask_gpt_async' mcq_id=mcq.id %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="question" class="form-label">Your question about this MCQ:</label>
                        <textarea class="form-control" id="question" name="question" rows="2" 
                            placeholder="What would you like to understand better about this question?"></textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted small">Specific questions yield better answers</span>
                        <button type="submit" class="btn btn-primary" style="background-color: #6f42c1; border-color: #6f42c1;">
                            <i class="bi bi-send"></i> Ask AI-Pal
                        </button>
                    </div>
                </form>
                <script>
                // Lightweight, resilient AJAX handler for Ask AI-Pal
                (function() {
                    try {
                        const form = document.getElementById('askAIForm');
                        if (!form || form.dataset.ajaxBound === '1') return;
                        form.dataset.ajaxBound = '1';
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            const questionEl = document.getElementById('question');
                            const question = (questionEl && questionEl.value || '').trim();
                            if (!question) return;

                            const aiAnswer = document.getElementById('aiAnswer');
                            const aiAnswerContent = document.getElementById('aiAnswerContent');
                            const aiLoading = document.getElementById('aiLoading');
                            if (aiAnswer) aiAnswer.classList.remove('hidden');
                            if (aiAnswerContent) aiAnswerContent.innerHTML = '';
                            if (aiLoading) aiLoading.style.display = 'flex';

                            const fd = new FormData(form);
                            // Submit async job then poll status
                            fetch(form.action, { method: 'POST', body: fd })
                              .then(r => r.json())
                              .then(({ job_id, status, error }) => {
                                  if (!job_id) throw new Error(error || 'Failed to queue job');
                                  const poll = () => {
                                      fetch('/ai/job/' + job_id + '/status/')
                                        .then(r => r.json())
                                        .then(data => {
                                            if (data.status === 'ready') {
                                                if (aiLoading) aiLoading.style.display = 'none';
                                                if (aiAnswerContent) aiAnswerContent.innerHTML = (data.result && data.result.answer) ? data.result.answer : '<div class="alert alert-warning">No answer.</div>';
                                            } else if (data.status === 'failed') {
                                                if (aiLoading) aiLoading.style.display = 'none';
                                                if (aiAnswerContent) aiAnswerContent.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ' + (data.error || 'AI job failed') + '</div>';
                                            } else {
                                                setTimeout(poll, 1200);
                                            }
                                        })
                                        .catch(() => setTimeout(poll, 1500));
                                  };
                                  setTimeout(poll, 800);
                              })
                              .catch(err => {
                                  if (aiLoading) aiLoading.style.display = 'none';
                                  if (aiAnswerContent) aiAnswerContent.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error contacting AI service.</div>';
                              });
                        });
                    } catch (e) { /* ignore to avoid blocking page */ }
                })();
                </script>
                
                <div id="aiAnswer" class="mt-4 hidden">
                    <div class="d-flex justify-content-center mb-3" id="aiLoading">
                        <div class="spinner-border text-primary" role="status" style="color: #6f42c1 !important;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">AI-Pal is thinking...</span>
                    </div>
                    <div id="aiAnswerContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- No panels here - moved to the top right corner -->
    </div>
</div>

<!-- Clinical Reasoning Analysis Modal - Professional Medical Education Tool -->
<div id="clinical-reasoning-modal" class="modal fade" tabindex="-1" aria-labelledby="clinicalReasoningModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <!-- Professional Header -->
            <div class="modal-header bg-gradient-primary text-white py-3">
                <div class="d-flex align-items-center">
                    <div class="bg-white bg-opacity-20 rounded-circle p-2 me-3">
                        <i class="bi bi-brain text-white" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0" id="clinicalReasoningModalLabel">Clinical Reasoning Analysis</h5>
                        <small class="opacity-75">AI-Powered Cognitive Assessment Tool</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body p-0">
                <!-- Progress Indicator -->
                <div class="bg-light border-bottom px-4 py-2">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="badge bg-primary rounded-pill px-3 py-2" id="step-indicator">Step 1 of 3</span>
                        </div>
                        <div class="col">
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-primary" id="progress-bar" role="progressbar" style="width: 33%"></div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <small class="text-muted" id="step-description">Clinical Reasoning Input</small>
                        </div>
                    </div>
                </div>
                
                <!-- Step 1: Clinical Reasoning Input -->
                <div id="step-1-reasoning-input" class="reasoning-step active">
                    <div class="p-4">
                        <!-- Answer Context Banner -->
                        <div id="answer-context-banner" class="mb-4">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                        
                        <!-- Clinical Reasoning Framework -->
                        <div class="card border-0 bg-light mb-4">
                            <div class="card-body">
                                <h6 class="card-title text-primary mb-3">
                                    <i class="bi bi-lightbulb"></i> Clinical Reasoning Framework
                                </h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center mb-3">
                                            <div class="bg-primary bg-opacity-10 rounded-circle p-3 mx-auto mb-2" style="width: 60px; height: 60px;">
                                                <i class="bi bi-search text-primary" style="font-size: 1.5rem;"></i>
                                            </div>
                                            <small class="text-muted fw-bold">Data Gathering</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center mb-3">
                                            <div class="bg-warning bg-opacity-10 rounded-circle p-3 mx-auto mb-2" style="width: 60px; height: 60px;">
                                                <i class="bi bi-list-ul text-warning" style="font-size: 1.5rem;"></i>
                                            </div>
                                            <small class="text-muted fw-bold">Differential Diagnosis</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center mb-3">
                                            <div class="bg-info bg-opacity-10 rounded-circle p-3 mx-auto mb-2" style="width: 60px; height: 60px;">
                                                <i class="bi bi-funnel text-info" style="font-size: 1.5rem;"></i>
                                            </div>
                                            <small class="text-muted fw-bold">Prioritization</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center mb-3">
                                            <div class="bg-success bg-opacity-10 rounded-circle p-3 mx-auto mb-2" style="width: 60px; height: 60px;">
                                                <i class="bi bi-check-circle text-success" style="font-size: 1.5rem;"></i>
                                            </div>
                                            <small class="text-muted fw-bold">Decision Making</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reasoning Input Section -->
                        <div class="mb-4">
                            <label for="clinical-reasoning-textarea" class="form-label fw-bold mb-3">
                                <i class="bi bi-chat-square-text text-primary me-2"></i>
                                Describe Your Clinical Reasoning Process
                            </label>
                            
                            <!-- Input Methods -->
                            <div class="mb-3">
                                <div class="btn-group" role="group" aria-label="Input methods">
                                    <input type="radio" class="btn-check" name="input-method" id="type-input" checked>
                                    <label class="btn btn-outline-primary" for="type-input">
                                        <i class="bi bi-keyboard"></i> Type
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="input-method" id="voice-input">
                                    <label class="btn btn-outline-primary" for="voice-input">
                                        <i class="bi bi-mic"></i> Voice
                                    </label>
                                </div>
                                
                                <!-- Voice Recording Controls -->
                                <div id="voice-controls" class="ms-3 d-none">
                                    <button type="button" id="start-recording-btn" class="btn btn-outline-danger btn-sm">
                                        <i class="bi bi-record-circle"></i> Start Recording
                                    </button>
                                    <button type="button" id="stop-recording-btn" class="btn btn-danger btn-sm d-none">
                                        <i class="bi bi-stop-circle"></i> Stop Recording
                                    </button>
                                    <span id="recording-status" class="text-muted small ms-2"></span>
                                </div>
                            </div>
                            
                            <!-- Professional Guidance -->
                            <div class="alert alert-info border-0 mb-3">
                                <div class="row">
                                    <div class="col-auto">
                                        <i class="bi bi-info-circle text-info" style="font-size: 1.2rem;"></i>
                                    </div>
                                    <div class="col">
                                        <h6 class="alert-heading mb-2">Clinical Reasoning Guidelines</h6>
                                        <ul class="mb-0 small">
                                            <li><strong>History & Examination:</strong> What key findings influenced your decision?</li>
                                            <li><strong>Differential Diagnosis:</strong> What other conditions did you consider?</li>
                                            <li><strong>Risk Stratification:</strong> How did you prioritize possibilities?</li>
                                            <li><strong>Decision Process:</strong> What led you to your final answer?</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Main Textarea -->
                            <textarea 
                                id="clinical-reasoning-textarea" 
                                class="form-control shadow-sm"
                                rows="8" 
                                placeholder="Describe your systematic approach to this clinical scenario. Include your differential diagnosis, key clinical features you considered, and the reasoning behind your final decision..."
                                maxlength="2000"
                                style="resize: vertical; min-height: 200px;"
                            ></textarea>
                            
                            <!-- Character Counter and Validation -->
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div class="text-muted small">
                                    <span id="character-count">0</span> / 2000 characters
                                    <span class="text-primary">(minimum 20 characters)</span>
                                </div>
                                <div id="reasoning-validation" class="text-muted small">
                                    <i class="bi bi-info-circle"></i> Please provide your reasoning above
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle"></i> Cancel
                            </button>
                            <button type="button" id="analyze-reasoning-btn" class="btn btn-primary btn-lg px-4" disabled>
                                <i class="bi bi-cpu me-2"></i>
                                Analyze Clinical Reasoning
                                <i class="bi bi-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: AI Analysis -->
                <div id="step-2-ai-analysis" class="reasoning-step">
                    <div class="p-4 text-center">
                        <div class="mb-4">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Analyzing...</span>
                            </div>
                        </div>
                        <h5 class="text-primary mb-3">Analyzing Your Clinical Reasoning</h5>
                        <p class="text-muted mb-4">Our AI is evaluating your reasoning process using established clinical decision-making frameworks...</p>
                        
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="analysis-progress" style="width: 0%"></div>
                        </div>
                        
                        <div id="analysis-status" class="text-muted small">
                            <span id="current-analysis-step">Parsing reasoning structure...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Step 3: Results & Feedback -->
                <div id="step-3-results" class="reasoning-step">
                    <div class="p-4">
                        <!-- Analysis Summary -->
                        <div id="analysis-summary" class="mb-4">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                        
                        <!-- Detailed Feedback Sections -->
                        <div id="detailed-feedback">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" id="restart-analysis-btn" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-counterclockwise"></i> Analyze Different Reasoning
                            </button>
                            <div>
                                <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">
                                    <i class="bi bi-check"></i> Done
                                </button>
                                <button type="button" id="save-analysis-btn" class="btn btn-success">
                                    <i class="bi bi-download"></i> Save Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    <div id="follow-up-answer" style="margin-top: 15px; display: none;">
        <!-- Follow-up answer will be inserted here -->
    </div>
                </div>
                
                <!-- Test understanding section -->
                <div class="test-understanding-section" style="margin-top: 25px; border-top: 1px solid #ddd; padding-top: 20px;">
                    <div class="d-grid">
                        <button id="test-understanding-btn" class="btn btn-success" style="display: none;">
                            <i class="bi bi-lightning-charge"></i> Test My Understanding
                        </button>
                    </div>
                    
                    <div id="test-question-section" style="display: none; margin-top: 20px;">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-check-circle"></i> Challenge Question</h5>
                            </div>
                            <div class="card-body">
                                <div id="test-question-content">
                                    <!-- Test question will be inserted here -->
                                </div>
                                
                                <div id="test-options-section" class="mt-3">
                                    <!-- Options will be inserted here -->
                                </div>
                                
                                <div class="d-grid mt-3">
                                    <button id="submit-test-answer" class="btn btn-primary">Submit Answer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="test-result-section" style="display: none; margin-top: 20px;">
                        <!-- Test result will be inserted here -->
                    </div>
                    
                    <div id="test-followup-section" style="display: none; margin-top: 20px;">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-chat-dots"></i> Explain Your Choice</h5>
                            </div>
                            <div class="card-body">
                                <p>Why did you choose this answer? This helps us provide better guidance.</p>
                                <textarea id="test-followup-reasoning" rows="3" class="form-control" placeholder="I chose this answer because..."></textarea>
                                <div class="d-grid mt-3">
                                    <button id="submit-test-followup" class="btn btn-info">Submit Reasoning</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const root = document.querySelector('#explanation .explanation-content');
    if (!root || root.dataset.aiSectionsProcessed === '1') {
        return;
    }

    root.dataset.aiSectionsProcessed = '1';

    const sectionConfigs = [
        { key: 'option-analysis', matchers: ['option analysis'], navLabel: 'Option analysis', icon: 'bi-list-check' },
        { key: 'brief-overview', matchers: ['brief overview'], navLabel: 'Brief overview', icon: 'bi-journal-text' },
        { key: 'management', matchers: ['management', 'management focus', 'paragraph 3 management'], navLabel: 'Management', icon: 'bi-clipboard-heart' },
        { key: 'key-pearls', matchers: ['key pearls', 'key pearls (board-style)', 'board-style pearls'], navLabel: 'Key pearls', icon: 'bi-stars' },
    ];

    const identifySection = (node) => {
        if (!node || node.nodeType !== Node.ELEMENT_NODE) {
            return null;
        }
        const rawText = (node.textContent || '').trim();
        if (!rawText) {
            return null;
        }
        const normalized = rawText.toLowerCase().replace(/\s+/g, ' ');
        for (const config of sectionConfigs) {
            if (config.matchers.some((m) => normalized.startsWith(m))) {
                return { config, headingText: rawText };
            }
        }
        return null;
    };

    const cleanupSectionBody = (body) => {
        while (body.firstChild && body.firstChild.nodeType === Node.TEXT_NODE && !body.firstChild.textContent.trim()) {
            body.removeChild(body.firstChild);
        }
        if (body.firstElementChild && body.firstElementChild.tagName === 'HR') {
            body.removeChild(body.firstElementChild);
        }
        while (body.firstChild && body.firstChild.nodeType === Node.TEXT_NODE && !body.firstChild.textContent.trim()) {
            body.removeChild(body.firstChild);
        }
        while (body.lastChild && body.lastChild.nodeType === Node.TEXT_NODE && !body.lastChild.textContent.trim()) {
            body.removeChild(body.lastChild);
        }
        if (body.lastElementChild && body.lastElementChild.tagName === 'HR') {
            body.removeChild(body.lastElementChild);
        }
    };

    const subSectionConfigs = [
        { key: 'pharm', matchers: ['pharmacological management'], label: 'Pharmacological management', icon: 'bi-capsule' },
        { key: 'nonpharm', matchers: ['non pharmacological management', 'non-pharmacological management'], label: 'Non-pharmacological management', icon: 'bi-heart-pulse' },
        { key: 'counsel', matchers: ['counseling & follow-up essentials', 'counseling and follow-up essentials', 'counseling & follow up essentials'], label: 'Counseling & follow-up essentials', icon: 'bi-chat-square-heart' },
    ];

    const identifyManagementSubsection = (node) => {
        if (!node || node.nodeType !== Node.ELEMENT_NODE) {
            return null;
        }
        const rawText = (node.textContent || '').trim();
        if (!rawText) {
            return null;
        }
        const normalized = rawText
            .toLowerCase()
            .replace(/[‚Äî‚Äì-]/g, '')
            .replace(/:/g, '')
            .replace(/\s+/g, ' ')
            .trim();
        for (const config of subSectionConfigs) {
            if (config.matchers.some((m) => normalized.startsWith(m))) {
                return { config, headingText: rawText };
            }
        }
        return null;
    };

    const decorateManagementSubsections = (body) => {
        if (!body) return;

        const created = [];
        let node = body.firstChild;
        while (node) {
            const match = identifyManagementSubsection(node);
            if (!match) {
                node = node.nextSibling;
                continue;
            }

            const { config } = match;
            const wrapper = document.createElement('div');
            wrapper.className = `ai-expl-subsection ai-expl-subsection--${config.key}`;

            const header = document.createElement('div');
            header.className = 'ai-expl-subsection__header';
            const iconHolder = document.createElement('span');
            iconHolder.className = 'ai-expl-subsection__icon';
            iconHolder.innerHTML = `<i class="bi ${config.icon}"></i>`;
            const title = document.createElement('span');
            title.textContent = config.label;
            header.append(iconHolder, title);

            const subBody = document.createElement('div');
            subBody.className = 'ai-expl-subsection__body';

            wrapper.append(header, subBody);
            body.insertBefore(wrapper, node);
            const sectionStart = node;
            node = wrapper.nextSibling;
            sectionStart.remove();

            while (node) {
                const nextNode = node.nextSibling;
                const nextMatch = identifyManagementSubsection(node);
                if (nextMatch) {
                    break;
                }
                subBody.appendChild(node);
                node = nextNode;
            }

            cleanupSectionBody(subBody);
            created.push(wrapper);
        }

        if (created.length > 0) {
            created.forEach((sub) => {
                if (!sub.querySelector('ul, ol')) {
                    sub.querySelectorAll('p').forEach((p) => {
                        const trimmed = p.textContent.trim();
                        if (/^(‚Ä¢|-)/.test(trimmed)) {
                            const html = p.innerHTML.replace(/^(‚Ä¢|-)\s*/, '');
                            const list = document.createElement('ul');
                            const li = document.createElement('li');
                            li.innerHTML = html;
                            list.appendChild(li);
                            p.replaceWith(list);
                        }
                    });
                }
            });
        }
    };

    const createdSections = [];

    let node = root.firstChild;
    while (node) {
        const match = identifySection(node);
        if (!match) {
            node = node.nextSibling;
            continue;
        }

        const { config, headingText } = match;
        const wrapper = document.createElement('section');
        wrapper.className = `ai-expl-section ai-expl-section--${config.key}`;
        wrapper.id = `ai-expl-${config.key}`;

        const header = document.createElement('div');
        header.className = 'ai-expl-section__header';
        const iconHolder = document.createElement('span');
        iconHolder.className = 'ai-expl-section__icon';
        iconHolder.innerHTML = `<i class="bi ${config.icon}"></i>`;
        const titleSpan = document.createElement('span');
        titleSpan.className = 'ai-expl-section__title';
        titleSpan.textContent = headingText;

        header.append(iconHolder, titleSpan);
        wrapper.appendChild(header);

        const body = document.createElement('div');
        body.className = 'ai-expl-section__body';
        wrapper.appendChild(body);

        root.insertBefore(wrapper, node);
        const sectionStart = node;
        node = wrapper.nextSibling;
        sectionStart.remove();

        while (node) {
            const nextNode = node.nextSibling;
            const nextMatch = identifySection(node);
            if (nextMatch) {
                break;
            }
            body.appendChild(node);
            node = nextNode;
        }

        cleanupSectionBody(body);
        if (config.key === 'management') {
            decorateManagementSubsections(body);
        }
        createdSections.push({ config, navLabel: config.navLabel });
    }

    if (createdSections.length > 0) {
        const nav = document.createElement('div');
        nav.className = 'ai-expl-nav';
        createdSections.forEach(({ config, navLabel }) => {
            const link = document.createElement('a');
            link.className = `ai-expl-pill ai-expl-pill--${config.key}`;
            link.href = `#ai-expl-${config.key}`;
            link.innerHTML = `<i class="bi ${config.icon}"></i><span>${navLabel}</span>`;
            nav.appendChild(link);
        });

        const firstSection = root.querySelector('.ai-expl-section');
        if (firstSection) {
            root.insertBefore(nav, firstSection);
        } else {
            root.appendChild(nav);
        }
    }
});
</script>
<script>
// Debugging logger function - only logs visually for admin users
// Ensure detailed feedback always displays AI content (runtime override)
(function() {
    function attachOverride() {
        try {
            if (window.clinicalReasoningAnalyzer && typeof window.clinicalReasoningAnalyzer.generateDetailedFeedback === 'function') {
                const original = window.clinicalReasoningAnalyzer.generateDetailedFeedback.bind(window.clinicalReasoningAnalyzer);
                window.clinicalReasoningAnalyzer.generateDetailedFeedback = function(analysis, step) {
                    try {
                        const summary = (analysis && analysis.analysis_summary && String(analysis.analysis_summary).trim()) ? analysis.analysis_summary : '';
                        const stepContent = (step && step.content) ? step.content : '';
                        const title = (step && step.title) ? step.title : 'Clinical Reasoning Analysis';
                        const mainHtml = summary || stepContent;
                        if (mainHtml) {
                            return `
                                <div class="card border-0 shadow-sm mb-4">
                                  <div class="card-body">
                                    <h5 class="card-title text-primary mb-3">
                                      <i class="bi bi-lightbulb me-2"></i>${title}
                                    </h5>
                                    <div class="enhanced-analysis-content">${mainHtml}</div>
                                  </div>
                                </div>
                              ` + `
                                <div class="row">
                                  <div class="col-12">
                                    <div class="feedback-section p-4">
                                      <h6 class="text-primary mb-3">
                                        <i class="bi bi-graph-up me-2"></i>Analysis Summary
                                      </h6>
                                      <div class="row text-center">
                                        <div class="col-md-4"><div class="metric-box p-3"><h3 class="text-primary">${analysis && analysis.confidence_score != null ? analysis.confidence_score : '‚Äî'}%</h3><p class="text-muted mb-0">Confidence Score</p></div></div>
                                        <div class="col-md-4"><div class="metric-box p-3"><h3 class="text-success">${(analysis && analysis.reasoning_quality) || 'Good'}</h3><p class="text-muted mb-0">Reasoning Quality</p></div></div>
                                        <div class="col-md-4"><div class="metric-box p-3"><h3 class="text-info">${(analysis && analysis.total_steps) || '1'}</h3><p class="text-muted mb-0">Analysis Steps</p></div></div>
                                      </div>
                                    </div>
                                  </div>
                                </div>`;
                        }
                    } catch (e) {
                        console.error('Override generateDetailedFeedback error:', e);
                    }
                    return original(analysis, step);
                };
            } else {
                setTimeout(attachOverride, 300);
            }
        } catch (e) {
            console.error('Failed to attach feedback override:', e);
        }
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachOverride);
    } else {
        attachOverride();
    }
})();
function logUserAction(action, details = {}) {
    if (!action) return;
    const timestamp = new Date().toLocaleTimeString();
    const payload = Object.assign({ ts: timestamp }, details || {});

    console.log(`[USER ACTION] ${action}`, payload);

    const debugLogContainer = document.getElementById('debug-log-container');
    if (debugLogContainer) {
        const logEntry = document.createElement('div');
        logEntry.className = 'debug-log-entry';
        const safeDetails = Object.keys(payload).length > 1 ? ` - ${JSON.stringify(payload)}` : '';
        logEntry.innerHTML = `<strong>${timestamp}</strong>: ${action}${safeDetails}`;
        debugLogContainer.prepend(logEntry);
    }
}

function logLifecycle(stage, info) {
    logUserAction(`[Lifecycle] ${stage}`, info || {});
}
window.logLifecycle = logLifecycle;

// Function to toggle notes panel visibility
function toggleNotesPanel() {
    const notesPanel = document.getElementById('notes-panel');
    const notesButton = document.querySelector('button[onclick="toggleNotesPanel()"]');
    
    if (notesPanel) {
        if (notesPanel.style.display === 'none') {
            // Open the panel
            notesPanel.style.display = 'block';
            
            // Update button to show active state
            if (notesButton) {
                notesButton.classList.remove('btn-outline-info');
                notesButton.classList.add('btn-info');
            }
            
            // Scroll to the notes panel
            notesPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Log the action
            if (window.logUserAction) {
                logUserAction('Notes panel opened');
            }
        } else {
            // Close the panel
            notesPanel.style.display = 'none';
            
            // Update button to show inactive state
            if (notesButton) {
                notesButton.classList.remove('btn-info');
                notesButton.classList.add('btn-outline-info');
            }
            
            // Log the action
            if (window.logUserAction) {
                logUserAction('Notes panel closed');
            }
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded event fired');
    
    // Add error boundary
    try {
        // Global event capture for admin debugging
        document.addEventListener('click', function (event) {
            const target = event.target.closest('button, a, input[type="radio"], input[type="checkbox"]');
            if (!target) return;
            logUserAction('Click captured', {
                id: target.id || null,
                text: target.textContent ? target.textContent.trim().slice(0, 80) : null,
                tag: target.tagName,
                classes: target.className || null
            });
        }, true);

        document.addEventListener('change', function (event) {
            const target = event.target;
            if (target && target.matches('input[type="radio"], input[type="checkbox"], select')) {
                logUserAction('Change captured', {
                    id: target.id || null,
                    tag: target.tagName,
                    value: target.value,
                    name: target.name || null
                });
            }
        }, true);

        // Initialize strikethrough event listeners
        if (!window.__MCQ_CORE_ACTIVE) {
            initializeStrikethrough();
        }
    } catch (error) {
        console.error('Critical error while setting up DOMContentLoaded listeners:', error);
    }

    try {
    // Flashcard Form Handler
    const flashcardForm = document.getElementById('flashcardForm');
    const addFlashcardBtn = document.getElementById('addFlashcardBtn');
    const flashcardInterval = document.getElementById('flashcardInterval');

    if (flashcardForm && addFlashcardBtn) {
        // Add specific click handler for the button
        addFlashcardBtn.addEventListener('click', function(e) {
            e.preventDefault();

            // Get selected interval
            const selectedInterval = flashcardInterval ? flashcardInterval.value : 1;

            // Show loading state
            addFlashcardBtn.disabled = true;
            const originalText = addFlashcardBtn.innerHTML;
            addFlashcardBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...`;

            // Submit the form
            flashcardForm.submit();
        });
    }
    // Automatically open notes panel if it contains text
    const noteTextarea = document.getElementById('note');
    const notesPanel = document.getElementById('notes-panel');
    
    if (noteTextarea && notesPanel) {
        // Check if the notes textarea has content
        if (noteTextarea.value.trim()) {
            // Show the notes panel if it has content
            notesPanel.style.display = 'block';
            // Update the button text/style to indicate open state
            const notesButton = document.querySelector('button[onclick="toggleNotesPanel()"]');
            if (notesButton) {
                notesButton.classList.remove('btn-outline-info');
                notesButton.classList.add('btn-info');
            }
            // Log this action
            logUserAction('Notes panel automatically opened because it contains text');
        }
    }
    
    // Create debug log container only for admin users
    const isStaff = document.body.dataset.userIsStaff === 'true';
    if (isStaff) {
        const debugLogSection = document.createElement('div');
        debugLogSection.innerHTML = `
            <div class="card shadow mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Interaction Log (Admin Only)</h5>
                    <button type="button" class="btn btn-sm btn-outline-light ms-auto" id="copy-debug-log-btn">
                        <i class="bi bi-clipboard"></i> Copy Log
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="debug-log-container" style="max-height: 200px; overflow-y: auto; padding: 10px;">
                        <div class="debug-log-entry"><strong>${new Date().toLocaleTimeString()}</strong>: Page loaded</div>
                    </div>
                </div>
            </div>
        `;
        document.querySelector('.row').appendChild(debugLogSection);

        const copyLogBtn = document.getElementById('copy-debug-log-btn');
        if (copyLogBtn) {
            copyLogBtn.addEventListener('click', () => {
                const logContainer = document.getElementById('debug-log-container');
                if (!logContainer) {
                    alert('No log entries to copy yet.');
                    return;
                }
                const text = Array.from(logContainer.querySelectorAll('.debug-log-entry'))
                    .map((entry) => entry.textContent.trim())
                    .join('\n');

                if (!text) {
                    alert('No log entries to copy yet.');
                    return;
                }

                const copyToClipboard = (value) => {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        return navigator.clipboard.writeText(value);
                    }
                    const temp = document.createElement('textarea');
                    temp.value = value;
                    temp.style.position = 'fixed';
                    temp.style.opacity = '0';
                    document.body.appendChild(temp);
                    temp.focus();
                    temp.select();
                    try {
                        document.execCommand('copy');
                    } finally {
                        document.body.removeChild(temp);
                    }
                    return Promise.resolve();
                };

                copyToClipboard(text)
                    .then(() => {
                        logUserAction('Debug log copied to clipboard');
                        copyLogBtn.innerHTML = '<i class="bi bi-clipboard-check"></i> Copied';
                        setTimeout(() => {
                            copyLogBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copy Log';
                        }, 1500);
                    })
                    .catch((error) => {
                        console.error('Failed to copy debug log:', error);
                        alert('Unable to copy log automatically. Please select and copy manually.');
                    });
            });
        }
    }
    
    // Add event listeners for tracking
    document.querySelectorAll('button, a.btn').forEach(element => {
        element.addEventListener('click', function(event) {
            logUserAction(`Clicked: ${this.textContent.trim()}`, {
                element_type: this.tagName,
                element_id: this.id,
                element_class: this.className
            });
        });
    });
    
    // Get UI elements
    const checkAnswerBtn = document.getElementById('checkAnswerBtn');
    const showExplanationBtn = document.getElementById('showExplanationBtn');
    const explanation = document.getElementById('explanation');
    const askAIForm = document.getElementById('askAIForm');
    const aiAnswer = document.getElementById('aiAnswer');
    const aiAnswerContent = document.getElementById('aiAnswerContent');
    const explainForm = document.getElementById('explainForm');
    const generateExplanationBtn = document.getElementById('generateExplanation');
    const explainStatus = document.getElementById('explainStatus');
    const verifyAnswerBtn = document.getElementById('verifyAnswerBtn');
    
    // Strikethrough mode state
    let strikethroughMode = false;
    
    // Toggle strikethrough mode function - make it global
    window.toggleStrikethroughMode = function() {
        if (window.__MCQ_CORE_ACTIVE && window.MCQCore) {
            window.MCQCore.toggleStrikethrough(document.getElementById('strikethroughToggleBtn'));
            return;
        }
        console.log('Toggle strikethrough mode called');
        strikethroughMode = !strikethroughMode;
        const toggleBtn = document.getElementById('strikethroughToggleBtn');
        console.log('Strikethrough mode is now:', strikethroughMode);
        
        if (strikethroughMode) {
            // Enable strikethrough mode
            toggleBtn.classList.remove('btn-outline-secondary');
            toggleBtn.classList.add('btn-secondary');
            toggleBtn.innerHTML = '<i class="bi bi-pencil-square"></i> Strikethrough (ON)';
            
            // Add body class for hover effects
            document.body.classList.add('strikethrough-mode-active');
            
            // Update cursor for options
            document.querySelectorAll('.option-text-content').forEach(span => {
                span.style.cursor = 'pointer';
            });
            
            // Show tip
            const tip = document.querySelector('.text-muted.small.mb-3');
            if (tip) {
                tip.innerHTML = '<i class="bi bi-info-circle"></i> Strikethrough mode is ON. Click on option text to eliminate. Click the button again to turn OFF.';
                tip.classList.add('text-primary');
            }
            
            logUserAction('Strikethrough mode enabled');
        } else {
            // Disable strikethrough mode
            toggleBtn.classList.remove('btn-secondary');
            toggleBtn.classList.add('btn-outline-secondary');
            toggleBtn.innerHTML = '<i class="bi bi-pencil-square"></i> Strikethrough';
            
            // Remove body class
            document.body.classList.remove('strikethrough-mode-active');
            
            // Update cursor for options
            document.querySelectorAll('.option-text-content').forEach(span => {
                span.style.cursor = 'default';
            });
            
            // Restore tip
            const tip = document.querySelector('.text-muted.small.mb-3');
            if (tip) {
                tip.innerHTML = '<i class="bi bi-info-circle"></i> Click "Strikethrough" button to enable elimination mode.';
                tip.classList.remove('text-primary');
            }
            
            logUserAction('Strikethrough mode disabled');
        }
    }
    
    // Initialize strikethrough functionality
    function initializeStrikethrough() {
        console.log('Initializing strikethrough functionality');
        
        // Strikethrough functionality for eliminating answer options
        const options = document.querySelectorAll('.option');
        console.log(`Found ${options.length} options`);
        
        options.forEach(option => {
            const label = option.querySelector('.form-check-label');
            const radioInput = option.querySelector('.form-check-input');
            const textSpan = option.querySelector('.option-text-content');
            
            if (label && radioInput && textSpan) {
                console.log(`Setting up click handler for option ${option.id}`);
                
                // Add click event to the text span only for strikethrough
                textSpan.addEventListener('click', function(e) {
                    console.log('Option text clicked, strikethrough mode:', strikethroughMode);
                    // Prevent the click from bubbling to the label
                    e.stopPropagation();
                    e.preventDefault();
                    
                    // Only work if strikethrough mode is enabled
                    if (!strikethroughMode) {
                        // If not in strikethrough mode, manually trigger the radio button
                        radioInput.checked = true;
                        radioInput.dispatchEvent(new Event('change'));
                        return;
                    }
                    
                    // Toggle eliminated class
                    option.classList.toggle('option-eliminated');
                    
                    // Log the action
                    const optionLetter = option.id.replace('option-', '');
                    const isEliminated = option.classList.contains('option-eliminated');
                    logUserAction(`Option ${optionLetter} ${isEliminated ? 'eliminated' : 'restored'}`, {
                        option_id: option.id,
                        eliminated: isEliminated
                    });
                });
                
                // Prevent label from selecting radio when clicking on text span
                label.addEventListener('click', function(e) {
                    if (e.target === textSpan || textSpan.contains(e.target)) {
                        e.preventDefault();
                    }
                });
                
                // When clicking on the radio button or anywhere else in the label, it should work normally
                radioInput.addEventListener('change', function() {
                    // Remove strikethrough when selecting an option
                    if (option.classList.contains('option-eliminated')) {
                        option.classList.remove('option-eliminated');
                        logUserAction(`Option ${radioInput.value} restored (selected)`, {
                            option_id: option.id
                        });
                    }
                });
            }
        });
    }
    
    // Add event listener for strikethrough toggle button
    // Skip legacy handler if MCQCore is active (it already handles this via inline onclick)
    const strikethroughToggleBtn = document.getElementById('strikethroughToggleBtn');
    if (strikethroughToggleBtn && !window.__MCQ_CORE_ACTIVE) {
        strikethroughToggleBtn.addEventListener('click', function(event) {
            toggleStrikethroughMode();
        });
        strikethroughToggleBtn._addEventListener = true;
    }
    
    // Initially hide the explanation
    if (explanation) {
        explanation.style.display = 'none';
    }
    
    // Check Answer functionality
    // Skip legacy handler if MCQCore is active (it already handles this via inline onclick)
    if (checkAnswerBtn && !window.__MCQ_CORE_ACTIVE) {
        checkAnswerBtn.addEventListener('click', function(event) {
            logUserAction('Checking answer');
            const selectedAnswer = document.querySelector('input[name="answer"]:checked');
            
            if (!selectedAnswer) {
                alert('Please select an answer first.');
                logUserAction('No answer selected');
                return;
            }
            
            const formData = new FormData();
            formData.append('answer', selectedAnswer.value);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch(`/mcq/{{ mcq.id }}/check_answer/`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                logUserAction('Answer check response received', { is_correct: data.is_correct });
                
                // Reset all options (including eliminations)
                document.querySelectorAll('.option').forEach(option => {
                    option.className = 'option';
                });
                
                // Mark selected option
                const selectedOption = document.getElementById(`option-${selectedAnswer.value}`);
                
                if (data.is_correct) {
                    selectedOption.classList.add('option-correct');
                } else {
                    selectedOption.classList.add('option-incorrect');
                    // Mark correct answer
                    const correctOption = document.getElementById(`option-${data.correct_answer}`);
                    if (correctOption) {
                        correctOption.classList.add('option-correct');
                    } else {
                        // Handle case where correct answer doesn't match any option
                        console.error(`No option found for correct answer: ${data.correct_answer}`);
                        
                        // Add warning message
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'alert alert-warning mt-3';
                        warningDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> <strong>Data Error:</strong> The correct answer "${data.correct_answer}" doesn't match any available option. This question may have incorrect data. Please report this issue.`;
                        document.getElementById('options').appendChild(warningDiv);
                    }
                }
                
                // Show explanation
                if (explanation) {
                    explanation.style.display = 'block';
                }
                
                // Add ReasoningPal button after checking answer
                const reasoningPalContainer = document.getElementById('reasoning-pal-button-container');
                if (reasoningPalContainer) {
                    // Clear placeholder text
                    reasoningPalContainer.innerHTML = '';
                    
                    // Create wrapper for better styling
                    const buttonWrapper = document.createElement('div');
                    buttonWrapper.className = 'reasoning-pal-button-wrapper';
                    
                    // Create button
                    const reasoningPalButton = document.createElement('button');
                    reasoningPalButton.id = 'launch-reasoning-pal';
                    reasoningPalButton.className = 'btn btn-success animate__animated animate__pulse';
                    reasoningPalButton.innerHTML = '<i class="bi bi-brain"></i> Analyze My Clinical Reasoning';
                    
                    // Add event listener to open new ReasoningPal modal
                    reasoningPalButton.addEventListener('click', function() {
                        console.log('Reasoning button clicked!');
                        console.log('About to call openClinicalReasoningAnalysis with:', {
                            mcqId: '{{ mcq.id }}',
                            isCorrect: data.is_correct,
                            selectedAnswer: selectedAnswer.value,
                            correctAnswer: data.correct_answer
                        });
                        try {
                            openClinicalReasoningAnalysis('{{ mcq.id }}', data.is_correct, selectedAnswer.value, data.correct_answer);
                        } catch (error) {
                            console.error('Error calling openClinicalReasoningAnalysis:', error);
                            alert('Error opening modal: ' + error.message);
                        }
                    });
                    
                    // Add button to wrapper and wrapper to container
                    buttonWrapper.appendChild(reasoningPalButton);
                    reasoningPalContainer.appendChild(buttonWrapper);
                }
                
                // Update the request prompt area
                const requestPromptDiv = document.getElementById('request-prompt');
                if (requestPromptDiv) {
                    if (data.is_correct) {
                        requestPromptDiv.innerHTML = `
                            <div class="alert alert-success">
                                <h4><i class="bi bi-check-circle"></i> Your answer (${selectedAnswer.value}) is correct!</h4>
                                <p>Please explain your clinical reasoning process. What key factors led you to select this answer?</p>
                            </div>
                        `;
                    } else {
                        requestPromptDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <h4><i class="bi bi-x-circle"></i> Your answer (${selectedAnswer.value}) is incorrect.</h4>
                                <p>The correct answer is ${data.correct_answer}. Please explain your clinical reasoning process. What factors led you to select the wrong answer?</p>
                            </div>
                        `;
                    }
                }
                
                // Add submit button handler
                const submitReasoningBtn = document.getElementById('submit-reasoning-btn');
                if (submitReasoningBtn) {
                    submitReasoningBtn.onclick = function() {
                        const mcqId = '{{ mcq.id }}';
                        try {
                            if (typeof openClinicalReasoningAnalysis === 'function') {
                                openClinicalReasoningAnalysis(mcqId, data.is_correct, selectedAnswer.value, data.correct_answer);
                            } else {
                                alert('Please refresh the page and try again.');
                            }
                        } catch (e) {
                            console.error('Failed to open Clinical Reasoning Analysis:', e);
                            alert('Unable to open Clinical Reasoning Analysis. Please refresh and try again.');
                        }
                    };
                }
        });
        checkAnswerBtn._addEventListener = true;
    }
                                
    // Show/Hide Explanation
    // Skip legacy handler if MCQCore is active (it already handles this via inline onclick)
    if (showExplanationBtn && !window.__MCQ_CORE_ACTIVE) {
        showExplanationBtn.addEventListener('click', function(event) {
            // All explanations are now preloaded
            logUserAction('Toggle explanation visibility', { has_explanation: true });
            
            if (explanation) {
                if (explanation.style.display === 'none' || explanation.style.display === '') {
                    explanation.style.display = 'block';
                    showExplanationBtn.querySelector('i').className = 'bi bi-lightbulb-off';
                    showExplanationBtn.querySelector('span').textContent = 'Hide Explanation';
                } else {
                    explanation.style.display = 'none';
                    showExplanationBtn.querySelector('i').className = 'bi bi-lightbulb';
                    showExplanationBtn.querySelector('span').textContent = 'Show Explanation';
                }
            }
        });
        showExplanationBtn._addEventListener = true;
    }
    
    // Ask AI Assistant
    if (askAIForm && askAIForm.dataset.ajaxBound !== '1') {
        askAIForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const question = document.getElementById('question').value;
            
            if (!question) {
                alert('Please enter a question.');
                return;
            }
            
            logUserAction('Submitting AI question', { question_length: question.length });
            
            const formData = new FormData();
            formData.append('question', question);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Show loading
            if (aiAnswer) {
                aiAnswer.classList.remove('hidden');
            }
            if (aiAnswerContent) {
                aiAnswerContent.innerHTML = '';
            }
            const aiLoading = document.getElementById('aiLoading');
            if (aiLoading) {
                aiLoading.style.display = 'flex';
            }
            
            // Scroll to the answer container
            if (aiAnswer) {
                aiAnswer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Async background submission + polling
            fetch(`/mcq/{{ mcq.id }}/ask_gpt_async/`, { method: 'POST', body: formData })
                .then(r => r.json())
                .then(({ job_id, error }) => {
                    if (!job_id) throw new Error(error || 'Failed to queue job');
                    const poll = () => {
                        fetch('/ai/job/' + job_id + '/status/')
                          .then(r => r.json())
                          .then(data => {
                              if (data.status === 'ready') {
                                  if (aiLoading) aiLoading.style.display = 'none';
                                  if (aiAnswerContent) {
                                      const ans = data.result && data.result.answer ? data.result.answer : '<div class="alert alert-warning">No answer returned.</div>';
                                      aiAnswerContent.innerHTML = ans;
                                  }
                              } else if (data.status === 'failed') {
                                  if (aiLoading) aiLoading.style.display = 'none';
                                  if (aiAnswerContent) {
                                      aiAnswerContent.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ' + (data.error || 'AI job failed') + '</div>';
                                  }
                              } else {
                                  setTimeout(poll, 1200);
                              }
                          })
                          .catch(() => setTimeout(poll, 1500));
                    };
                    setTimeout(poll, 800);
                })
                .catch(error => {
                    logUserAction('Error getting AI answer', { error: error.toString() });
                    if (aiLoading) aiLoading.style.display = 'none';
                    if (aiAnswerContent) {
                        aiAnswerContent.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error contacting AI service.</div>';
                    }
                });
        });
    }
    
    // All MCQs now have pre-loaded explanations
    
    // Add listeners for hide/unhide buttons
    document.querySelectorAll('form[action*="hide_mcq"], form[action*="unhide_mcq"]').forEach(form => {
        form.addEventListener('submit', function(event) {
            const action = form.action.includes('hide_mcq') ? 'hide' : 'unhide';
            logUserAction(`Submitting form to ${action} MCQ`, { form_action: form.action });
        });
    });
    
    // Test My Understanding button
    const testUnderstandingBtn = document.getElementById('test-understanding-btn');
    if (testUnderstandingBtn) {
        testUnderstandingBtn.addEventListener('click', function() {
            // Hide the button and show loading state
            testUnderstandingBtn.disabled = true;
            testUnderstandingBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating test question...';
            
            // Get the current MCQ and reasoning guidance content for context
            const mcqId = '{{ mcq.id }}';
            const guidanceElement = document.getElementById('reasoning-guidance');
            const guidanceContent = guidanceElement ? guidanceElement.innerText : '';
            
            // Make an API call to generate a related test question
            const formData = new FormData();
            formData.append('mcq_id', mcqId);
            formData.append('guidance_content', guidanceContent);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch('/mcq/' + mcqId + '/generate_test_question/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const testQuestionSection = document.getElementById('test-question-section');
                const testQuestionContent = document.getElementById('test-question-content');
                const testOptionsSection = document.getElementById('test-options-section');
                
                if (!testQuestionSection || !testQuestionContent || !testOptionsSection) {
                    throw new Error('Test question container elements are missing from the DOM.');
                }
                
                // Show question section
                testQuestionSection.style.display = 'block';
                
                // Display the API-generated question and options
                testQuestionContent.innerHTML = `<p>${data.question}</p>`;
                
                // Generate options from the API response data
                let optionsHTML = '';
                const optionLetters = data.options ? Object.keys(data.options) : [];
                
                optionLetters.forEach(letter => {
                    optionsHTML += `
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="test_answer" id="test_option_${letter}" value="${letter}">
                            <label class="form-check-label" for="test_option_${letter}">
                                <strong>${letter}.</strong> ${data.options[letter]}
                            </label>
                        </div>
                    `;
                });
                
                testOptionsSection.innerHTML = optionsHTML;
                
                // Store the correct answer from the API
                testOptionsSection.dataset.correctAnswer = data.correct_answer;
                
                // Reset button
                testUnderstandingBtn.style.display = 'none';
                
                // Set up submit button
                const submitTestBtn = document.getElementById('submit-test-answer');
                if (submitTestBtn) {
                    submitTestBtn.addEventListener('click', function() {
                        const selectedAnswer = document.querySelector('input[name="test_answer"]:checked');
                        if (!selectedAnswer) {
                            alert('Please select an answer.');
                            return;
                        }
                        
                        // Get the selected value
                        const answerValue = selectedAnswer.value;
                        const correctAnswer = testOptionsSection.dataset.correctAnswer; // Get the correct answer from the API
                        const isCorrect = answerValue === correctAnswer;
                        
                        // Show result section
                        const testResultSection = document.getElementById('test-result-section');
                        testResultSection.style.display = 'block';
                        
                        if (isCorrect) {
                            // Use the API-provided feedback for correct answers
                            testResultSection.innerHTML = `
                                <div class="alert alert-success">
                                    <h5><i class="bi bi-check-circle"></i> Correct!</h5>
                                    <p>${data.correct_feedback}</p>
                                    <hr>
                                    <p class="mb-0">This demonstrates your understanding of the key concepts.</p>
                                </div>
                                <div class="d-grid mt-3">
                                    <button class="btn btn-success" onclick="document.getElementById('reasoning-pal-modal').style.display='none';">Continue Learning</button>
                                </div>
                            `;
                        } else {
                            // Show incorrect feedback and follow-up section
                            // Use the API-provided feedback for incorrect answers
                            const correctOptionText = document.querySelector(`label[for="test_option_${correctAnswer}"]`).innerText.replace(`${correctAnswer}.`, '');
                            testResultSection.innerHTML = `
                                <div class="alert alert-danger">
                                    <h5><i class="bi bi-x-circle"></i> Not quite right</h5>
                                    <p>You selected option ${answerValue}. The correct answer is option ${correctAnswer}: ${correctOptionText}</p>
                                    <hr>
                                    <p class="mb-0">${data.incorrect_feedback}</p>
                                </div>
                            `;
                            
                            // Show follow-up section for incorrect answers
                            const testFollowupSection = document.getElementById('test-followup-section');
                            testFollowupSection.style.display = 'block';
                            
                            // Set up follow-up reasoning submission
                            const submitFollowupBtn = document.getElementById('submit-test-followup');
                            if (submitFollowupBtn) {
                                submitFollowupBtn.addEventListener('click', function() {
                                    const followupReasoning = document.getElementById('test-followup-reasoning').value;
                                    if (!followupReasoning) {
                                        alert('Please explain your reasoning.');
                                        return;
                                    }
                                    
                                    // Show loading state
                                    submitFollowupBtn.disabled = true;
                                    submitFollowupBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...';
                                    
                                    // Simulate processing time (would be API call in production)
                                    setTimeout(function() {
                                        // Make an API call to get detailed feedback based on the user's reasoning
                                        const followupData = new FormData();
                                        followupData.append('mcq_id', mcqId);
                                        followupData.append('user_reasoning', followupReasoning);
                                        followupData.append('selected_answer', answerValue);
                                        followupData.append('correct_answer', correctAnswer);
                                        followupData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                                        
                                        fetch('/mcq/' + mcqId + '/analyze_test_reasoning/', {
                                            method: 'POST',
                                            body: followupData
                                        })
                                        .then(response => response.json())
                                        .then(feedbackData => {
                                            // Add detailed feedback based on the user's reasoning
                                            testResultSection.innerHTML += `
                                                <div class="card mt-3">
                                                    <div class="card-header bg-primary text-white">
                                                        <h5 class="mb-0"><i class="bi bi-lightning"></i> Clarification</h5>
                                                    </div>
                                                    <div class="card-body">
                                                        ${feedbackData.detailed_feedback}
                                                    </div>
                                                </div>
                                                <div class="d-grid mt-3">
                                                    <button class="btn btn-primary" onclick="document.getElementById('reasoning-pal-modal').style.display='none';">Continue Learning</button>
                                                </div>
                                            `;
                                            
                                            // Hide follow-up section
                                            testFollowupSection.style.display = 'none';
                                        })
                                        .catch(error => {
                                            console.error('Error getting detailed feedback:', error);
                                            testResultSection.innerHTML += `
                                                <div class="alert alert-warning mt-3">
                                                    <p>We encountered an error while analyzing your reasoning. Here's some general feedback:</p>
                                                    <p>${data.detailed_explanation}</p>
                                                </div>
                                                <div class="d-grid mt-3">
                                                    <button class="btn btn-primary" onclick="document.getElementById('reasoning-pal-modal').style.display='none';">Continue Learning</button>
                                                </div>
                                            `;
                                            testFollowupSection.style.display = 'none';
                                        });
                                        
                                        // Hide follow-up section
                                        testFollowupSection.style.display = 'none';
                                    }, 2000);
                                });
                            }
                        }
                        
                        // Disable the submit button to prevent multiple submissions
                        submitTestBtn.disabled = true;
                    });
                }
            })
            .catch(error => {
                console.error('Error generating test question:', error);
                
                // Show error message if API fails
                testQuestionSection.style.display = 'block';
                testQuestionContent.innerHTML = `
                    <div class="alert alert-warning">
                        <h5><i class="bi bi-exclamation-triangle"></i> Error Generating Question</h5>
                        <p>We encountered an error while creating your test question.</p>
                        <p>Please try again later.</p>
                    </div>
                `;
                testOptionsSection.innerHTML = '';
                
                // Reset button state
                testUnderstandingBtn.disabled = false;
                testUnderstandingBtn.innerHTML = '<i class="bi bi-lightning-charge"></i> Try Again';
                testUnderstandingBtn.style.display = 'block';
            });
        });
    }
} catch (error) {
    console.error('Critical error in main DOMContentLoaded:', error);
    console.error('Stack trace:', error.stack);
}
}); // Close DOMContentLoaded
</script>

<!-- Debug Script to identify button issues -->
<script>
// Add this debug script to help identify issues
window.addEventListener('error', function(e) {
    console.error('JavaScript Error:', e.message, 'at', e.filename, ':', e.lineno, ':', e.colno);
    const stackTrace = e && e.error && e.error.stack ? e.error.stack : undefined;
    if (stackTrace) {
        console.error('Stack:', stackTrace);
    }
});

// Check if buttons exist and have event listeners after page loads
window.addEventListener('load', function() {
    console.log('=== Button Debug Information ===');
    
    // Check Check Answer button
    const checkBtn = document.getElementById('checkAnswerBtn');
    console.log('Check Answer Button exists:', !!checkBtn);
    if (checkBtn) {
        console.log('Check Answer Button onclick:', checkBtn.onclick);
        console.log('Check Answer Button event listeners:', checkBtn._addEventListener ? 'Has listeners' : 'No listeners detected');
    }
    
    // Check Show Explanation button
    const showBtn = document.getElementById('showExplanationBtn');
    console.log('Show Explanation Button exists:', !!showBtn);
    if (showBtn) {
        console.log('Show Explanation Button onclick:', showBtn.onclick);
        console.log('Show Explanation Button event listeners:', showBtn._addEventListener ? 'Has listeners' : 'No listeners detected');
    }
    
    // Check Strikethrough button
    const strikeBtn = document.getElementById('strikethroughToggleBtn');
    console.log('Strikethrough Button exists:', !!strikeBtn);
    if (strikeBtn) {
        console.log('Strikethrough Button onclick:', strikeBtn.onclick);
        console.log('Strikethrough Button event listeners:', strikeBtn._addEventListener ? 'Has listeners' : 'No listeners detected');
    }
    
    // Check if toggleStrikethroughMode function exists
    console.log('toggleStrikethroughMode function exists:', typeof window.toggleStrikethroughMode === 'function');
    
    console.log('=== End Debug Information ===');
});
</script>

<!-- ReasoningPal Critical CSS Fixes -->
<style>
#char-count {
    display: inline !important;
    visibility: visible !important;
    opacity: 1 !important;
    font-weight: bold !important;
    color: #333 !important;
}

#submit-reasoning {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    width: 100% !important;
}

#user-reasoning {
    display: block !important;
    visibility: visible !important;
    width: 100% !important;
}

.character-count {
    display: block !important;
    visibility: visible !important;
    margin-top: 8px !important;
}

/* Prevent framework interference */
.reasoning-pal-modal * {
    box-sizing: border-box !important;
}

/* Force visibility on critical elements */
#reasoning-pal-modal #char-count,
#reasoning-pal-modal #submit-reasoning,
#reasoning-pal-modal #user-reasoning {
    z-index: 9999 !important;
    position: relative !important;
}

/* Clinical Reasoning Modal Styles */
#clinical-reasoning-modal .modal-dialog {
    max-width: 1200px;
}

#clinical-reasoning-modal .bg-gradient-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
}

#clinical-reasoning-modal .reasoning-step {
    display: none;
}

#clinical-reasoning-modal .reasoning-step.active {
    display: block;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

#clinical-reasoning-modal .progress-bar {
    transition: width 0.6s ease;
}

#clinical-reasoning-modal .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
}

#clinical-reasoning-modal .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

#clinical-reasoning-modal .btn:not(:disabled) {
    transition: all 0.2s ease;
}

#clinical-reasoning-modal .btn:not(:disabled):hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Recording states */
#clinical-reasoning-modal .recording {
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Validation states */
#clinical-reasoning-modal .is-valid {
    border-color: #198754;
}

#clinical-reasoning-modal .is-invalid {
    border-color: #dc3545;
}

/* Professional card styling */
#clinical-reasoning-modal .card {
    transition: all 0.2s ease;
}

#clinical-reasoning-modal .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

/* Analysis results styling */
#clinical-reasoning-modal .analysis-card {
    border-left: 4px solid #0d6efd;
    background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
}

#clinical-reasoning-modal .feedback-section {
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: #fff;
}

#clinical-reasoning-modal .feedback-section:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.1);
}

#clinical-reasoning-modal .metric-box {
    background: white;
    border-radius: 10px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
}

#clinical-reasoning-modal .metric-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

#clinical-reasoning-modal .metric-box h3 {
    margin-bottom: 0.5rem;
    font-weight: 600;
}

/* Modal backdrop fix */
.modal-backdrop {
    z-index: 1040 !important;
}

#clinical-reasoning-modal {
    z-index: 1050 !important;
}

/* Ensure body is clickable after modal closes */
body.modal-open {
    overflow: hidden !important;
    padding-right: 0 !important;
}

/* Force remove any lingering modal effects */
body:not(.modal-open) {
    overflow: auto !important;
    padding-right: 0 !important;
}

/* Make reasoning button more clickable */
#launch-reasoning-pal {
    position: relative;
    z-index: 10 !important;  /* Lower than modal to prevent overlap */
    pointer-events: auto !important;
    cursor: pointer !important;
}

#launch-reasoning-pal:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
}

/* Fix any potential button overlapping issues */
#reasoning-pal-button-container {
    position: relative;
    z-index: 9998 !important;
}
</style>

<!-- Old ReasoningPal recording code removed to prevent conflicts -->

<!-- Admin Inline Editing JavaScript -->
<!-- New Cognitive ReasoningPal JavaScript -->
<script>
// Global variables for the clinical reasoning system
let currentReasoningSession = null;
let clinicalReasoningContext = null;
const TRANSCRIBE_AUDIO_URL = "{% url 'transcribe_audio_enhanced' %}";

/**
 * Professional Clinical Reasoning Analysis System
 * Designed for medical education and cognitive assessment
 */

class ClinicalReasoningAnalyzer {
    constructor() {
        this.currentStep = 1;
        this.totalSteps = 3;
        this.analysisData = null;
        this.recordingState = {
            isRecording: false,
            mediaRecorder: null,
            stream: null,
            audioChunks: [],
            selectedMimeType: null
        };
        
        this.initializeEventListeners();
    }
    
    initializeEventListeners() {
        // Character counter and validation
        const textarea = document.getElementById('clinical-reasoning-textarea');
        if (textarea) {
            textarea.addEventListener('input', () => this.updateCharacterCount());
            textarea.addEventListener('paste', () => {
                setTimeout(() => this.updateCharacterCount(), 100);
            });
        }
        
        // Input method switcher
        const typeInput = document.getElementById('type-input');
        const voiceInput = document.getElementById('voice-input');
        const voiceControls = document.getElementById('voice-controls');
        
        if (typeInput && voiceInput && voiceControls) {
            typeInput.addEventListener('change', () => {
                if (typeInput.checked) {
                    voiceControls.classList.add('d-none');
                    this.stopRecording();
                }
            });
            
            voiceInput.addEventListener('change', () => {
                if (voiceInput.checked) {
                    voiceControls.classList.remove('d-none');
                }
            });
        }
        
        // Recording controls
        const startRecBtn = document.getElementById('start-recording-btn');
        const stopRecBtn = document.getElementById('stop-recording-btn');
        
        if (startRecBtn) startRecBtn.addEventListener('click', () => this.startRecording());
        if (stopRecBtn) stopRecBtn.addEventListener('click', () => this.stopRecording());
        
        // Main analyze button
        const analyzeBtn = document.getElementById('analyze-reasoning-btn');
        if (analyzeBtn) {
            analyzeBtn.addEventListener('click', () => this.startAnalysis());
        }
        
        // Navigation buttons
        const restartBtn = document.getElementById('restart-analysis-btn');
        if (restartBtn) {
            restartBtn.addEventListener('click', () => this.restartAnalysis());
        }
        
        // Save analysis button
        const saveBtn = document.getElementById('save-analysis-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => this.saveAnalysis());
        }
    }
    
    updateCharacterCount() {
        const textarea = document.getElementById('clinical-reasoning-textarea');
        const counter = document.getElementById('character-count');
        const validation = document.getElementById('reasoning-validation');
        const analyzeBtn = document.getElementById('analyze-reasoning-btn');
        
        if (!textarea || !counter || !validation || !analyzeBtn) return;
        
        const length = textarea.value.length;
        counter.textContent = length;
        
        // Update validation state
        if (length >= 20) {
            analyzeBtn.disabled = false;
            validation.innerHTML = '<i class="bi bi-check-circle text-success"></i> Ready for analysis';
            validation.className = 'text-success small';
            textarea.classList.remove('is-invalid');
            textarea.classList.add('is-valid');
        } else if (length > 0) {
            analyzeBtn.disabled = true;
            validation.innerHTML = `<i class="bi bi-exclamation-circle text-warning"></i> ${20 - length} more characters needed`;
            validation.className = 'text-warning small';
            textarea.classList.remove('is-valid', 'is-invalid');
        } else {
            analyzeBtn.disabled = true;
            validation.innerHTML = '<i class="bi bi-info-circle"></i> Please provide your reasoning above';
            validation.className = 'text-muted small';
            textarea.classList.remove('is-valid', 'is-invalid');
        }
    }
    
    async startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // Store the stream for later cleanup
            this.recordingState.stream = stream;
            
            // Use exact same implementation as case-based learning
            const mimeTypes = [
                'audio/webm',
                'audio/webm;codecs=opus',
                'audio/mp4',
                'audio/ogg',
                'audio/wav'
            ];
            
            let options = {};
            let selectedMimeType = 'audio/webm'; // Default fallback
            
            for (const mimeType of mimeTypes) {
                if (MediaRecorder.isTypeSupported(mimeType)) {
                    options = { mimeType };
                    selectedMimeType = mimeType;
                    break;
                }
            }
            
            // If no mime type was supported, let the browser choose
            if (Object.keys(options).length === 0) {
                console.warn('No supported MIME types found, using browser default');
                this.recordingState.mediaRecorder = new MediaRecorder(stream);
            } else {
                this.recordingState.mediaRecorder = new MediaRecorder(stream, options);
            }
            
            // Store the mime type for later use (don't modify readonly property)
            this.recordingState.selectedMimeType = selectedMimeType;
            this.recordingState.audioChunks = [];
            
            // Set up event handlers before starting
            this.recordingState.mediaRecorder.addEventListener('dataavailable', (event) => {
                if (event.data.size > 0) {
                    this.recordingState.audioChunks.push(event.data);
                }
            });
            
            this.recordingState.mediaRecorder.addEventListener('stop', () => this.processRecording());
            
            this.recordingState.mediaRecorder.start();
            this.recordingState.isRecording = true;
            
            // Update UI
            const startBtn = document.getElementById('start-recording-btn');
            const stopBtn = document.getElementById('stop-recording-btn');
            const status = document.getElementById('recording-status');
            
            startBtn.classList.add('d-none');
            stopBtn.classList.remove('d-none');
            stopBtn.classList.add('recording');
            status.textContent = 'Recording in progress...';
            status.className = 'text-danger small ms-2';
            
        } catch (error) {
            console.error('Recording error:', error);
            console.error('Error type:', error.name);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            
            // Provide more specific error messages
            let errorMessage = 'Unable to start recording. ';
            if (error.name === 'NotAllowedError') {
                errorMessage += 'Microphone access denied. Please allow microphone permissions.';
            } else if (error.name === 'NotFoundError') {
                errorMessage += 'No microphone found. Please check your audio devices.';
            } else if (error.name === 'TypeError' && error.message.includes('readonly')) {
                errorMessage += 'Browser compatibility issue. Please try refreshing the page.';
            } else {
                errorMessage += error.message || 'Please check permissions and try again.';
            }
            
            this.showRecordingError(errorMessage);
        }
    }
    
    stopRecording() {
        if (this.recordingState.mediaRecorder && this.recordingState.isRecording) {
            this.recordingState.mediaRecorder.stop();
            // Use the stored stream to stop tracks
            if (this.recordingState.stream) {
                this.recordingState.stream.getTracks().forEach(track => track.stop());
            }
            this.recordingState.isRecording = false;
            
            // Update UI
            const startBtn = document.getElementById('start-recording-btn');
            const stopBtn = document.getElementById('stop-recording-btn');
            const status = document.getElementById('recording-status');
            
            startBtn.classList.remove('d-none');
            stopBtn.classList.add('d-none');
            stopBtn.classList.remove('recording');
            status.textContent = 'Processing transcription...';
            status.className = 'text-info small ms-2';
        }
    }
    
    async processRecording() {
        const status = document.getElementById('recording-status');
        
        try {
            // Use exact same implementation as case-based learning
            const mimeType = this.recordingState.selectedMimeType || 'audio/webm';
            const blob = new Blob(this.recordingState.audioChunks, { type: mimeType });
            
            // Determine file extension based on MIME type
            let extension = '.webm';
            if (mimeType.includes('ogg')) {
                extension = '.ogg';
            } else if (mimeType.includes('mp4') || mimeType.includes('m4a')) {
                extension = '.m4a';
            } else if (mimeType.includes('wav')) {
                extension = '.wav';
            } else if (mimeType.includes('mp3')) {
                extension = '.mp3';
            }
            
            const formData = new FormData();
            formData.append('audio', blob, 'recording' + extension);
            formData.append('mimeType', mimeType);
            
            console.log('üì° Sending audio for transcription...', {
                url: TRANSCRIBE_AUDIO_URL,
                mimeType: mimeType,
                blobSize: blob.size,
                extension: extension
            });
            
            const response = await fetch(TRANSCRIBE_AUDIO_URL, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': this.getCookie('csrftoken')
                },
                body: formData
            });
            
            console.log('üì° Response received:', {
                status: response.status,
                statusText: response.statusText,
                contentType: response.headers.get('content-type')
            });
            
            // Check if response is HTML (login redirect)
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/html')) {
                throw new Error('Authentication required - you may need to log in again');
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üì° Response data:', data);
            
            if (data.text) {
                const textarea = document.getElementById('clinical-reasoning-textarea');
                const currentText = textarea.value;
                textarea.value = currentText + (currentText ? ' ' : '') + data.text;
                this.updateCharacterCount();
                
                status.textContent = 'Transcription completed!';
                status.className = 'text-success small ms-2';
                
                setTimeout(() => {
                    status.textContent = '';
                }, 3000);
                
                console.log('‚úÖ Transcription successful:', data.text);
            } else if (data.error) {
                console.error('Transcription error:', data.error);
                this.showRecordingError('Transcription error: ' + data.error);
            } else {
                console.error('Unexpected response format:', data);
                this.showRecordingError('Unexpected response from server');
            }
            
        } catch (error) {
            console.error('Error sending audio:', error);
            this.showRecordingError('Error transcribing audio: ' + error.message);
        }
    }
    
    showRecordingError(message) {
        const status = document.getElementById('recording-status');
        status.textContent = message;
        status.className = 'text-danger small ms-2';
        
        setTimeout(() => {
            status.textContent = '';
        }, 5000);
    }
    
    getCookie(name) {
        // Exact same implementation as case-based learning
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    async startAnalysis() {
        const textarea = document.getElementById('clinical-reasoning-textarea');
        const reasoning = textarea.value.trim();
        
        if (reasoning.length < 20) {
            this.showValidationError('Please provide at least 20 characters of clinical reasoning.');
            return;
        }
        
        // Move to analysis step
        this.updateStep(2);
        
        // Simulate analysis progress
        this.simulateAnalysisProgress();
        
        try {
            // Check if we have the required context
            if (!clinicalReasoningContext) {
                throw new Error('Clinical reasoning context not available. Please close and reopen the modal.');
            }
            
            const { mcqId, isCorrect, selectedAnswer, correctAnswer } = clinicalReasoningContext;
            
            console.log('üß† Starting clinical reasoning analysis...', {
                mcqId: mcqId,
                reasoningLength: reasoning.length,
                selectedAnswer: selectedAnswer,
                isCorrect: isCorrect,
                url: `/mcq/${mcqId}/reasoning_pal/`
            });
            
            const formData = new FormData();
            formData.append('user_reasoning', reasoning);
            formData.append('selected_answer', selectedAnswer);
            formData.append('is_correct', isCorrect ? 'true' : 'false');
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Debug: Log form data
            console.log('üß† Form data being sent:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
            
            const response = await fetch(`/mcq/${mcqId}/reasoning_pal/`, {
                method: 'POST',
                body: formData
            });
            
            console.log('üß† Analysis response received:', {
                status: response.status,
                statusText: response.statusText,
                contentType: response.headers.get('content-type')
            });
            
            // Check if response is HTML (login redirect or error page)
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/html')) {
                throw new Error('Authentication required or server error - you may need to log in again');
            }
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Analysis request failed:', errorText);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üß† Analysis data received:', data);
            
            if (data.success && data.status === 'processing') {
                // Background task started - begin polling
                console.log('üß† Background analysis started, beginning polling...');
                this.pollTaskStatus(data.session_id, data.task_id);
            } else if (data.success) {
                // Analysis complete immediately
                console.log('üß† Analysis complete immediately');
                this.analysisData = data;
                this.moveToResults(data);
            } else {
                throw new Error(data.error || 'Analysis failed');
            }
            
        } catch (error) {
            console.error('Analysis error:', error);
            
            // Reset to step 1 on error
            this.updateStep(1);
            
            // Show more descriptive error messages
            let errorMessage = 'Analysis failed. ';
            if (error.message.includes('Authentication')) {
                errorMessage += 'Please refresh the page and try again.';
            } else if (error.message.includes('HTTP 400')) {
                errorMessage += 'Invalid request data. Please check your input.';
            } else if (error.message.includes('HTTP 500')) {
                errorMessage += 'Server error. Please try again in a moment.';
            } else {
                errorMessage += 'Please try again.';
            }
            
            this.showAnalysisError(errorMessage);
        }
    }
    
    simulateAnalysisProgress() {
        const progressBar = document.getElementById('analysis-progress');
        const statusText = document.getElementById('current-analysis-step');
        
        const steps = [
            'Parsing reasoning structure...',
            'Identifying clinical patterns...',
            'Evaluating decision-making process...',
            'Analyzing cognitive biases...',
            'Generating feedback...'
        ];
        
        let currentStep = 0;
        const interval = setInterval(() => {
            if (currentStep < steps.length) {
                progressBar.style.width = `${((currentStep + 1) / steps.length) * 100}%`;
                statusText.textContent = steps[currentStep];
                currentStep++;
            } else {
                clearInterval(interval);
            }
        }, 400);
    }
    
    updateStep(stepNumber) {
        console.log('üß† updateStep called with stepNumber:', stepNumber);
        
        // Hide all steps
        document.querySelectorAll('#clinical-reasoning-modal .reasoning-step').forEach(step => {
            step.classList.remove('active');
            console.log('üß† Removing active from:', step.id);
        });
        
        // Show current step
        const stepId = `step-${stepNumber}-${
            stepNumber === 1 ? 'reasoning-input' :
            stepNumber === 2 ? 'ai-analysis' : 'results'
        }`;
        
        console.log('üß† Looking for step element with ID:', stepId);
        const currentStepElement = document.getElementById(stepId);
        
        if (currentStepElement) {
            currentStepElement.classList.add('active');
            console.log('üß† Added active class to:', stepId);
            console.log('üß† Element now has classes:', currentStepElement.className);
            console.log('üß† Element display style:', window.getComputedStyle(currentStepElement).display);
        } else {
            console.error('üß† Step element not found:', stepId);
            // List all available step elements
            const allSteps = document.querySelectorAll('#clinical-reasoning-modal .reasoning-step');
            console.log('üß† Available step elements:', Array.from(allSteps).map(s => s.id));
        }
        
        // Update progress indicators
        const stepIndicator = document.getElementById('step-indicator');
        const progressBar = document.getElementById('progress-bar');
        const stepDescription = document.getElementById('step-description');
        
        if (stepIndicator) stepIndicator.textContent = `Step ${stepNumber} of ${this.totalSteps}`;
        if (progressBar) progressBar.style.width = `${(stepNumber / this.totalSteps) * 100}%`;
        
        if (stepDescription) {
            const descriptions = {
                1: 'Clinical Reasoning Input',
                2: 'AI Analysis in Progress',
                3: 'Results & Feedback'
            };
            stepDescription.textContent = descriptions[stepNumber] || '';
        }
        
        this.currentStep = stepNumber;
    }
    
    async pollTaskStatus(sessionId, taskId) {
        console.log('üß† Starting polling for session:', sessionId, 'task:', taskId);
        
        // Start admin debug monitoring if user is admin
        if (typeof startBackgroundTaskMonitoring === 'function') {
            startBackgroundTaskMonitoring(sessionId, taskId);
        }
        
        const maxPolls = 60; // 5 minutes max (5 second intervals)
        let pollCount = 0;
        
        const pollInterval = setInterval(async () => {
            pollCount++;
            console.log(`üß† Polling attempt ${pollCount}/${maxPolls} for session ${sessionId}`);
            
            try {
                const response = await fetch(`/cognitive_session/${sessionId}/status/`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üß† Poll response:', data);
                
                if (data.success && data.status === 'ready') {
                    // Analysis complete!
                    clearInterval(pollInterval);
                    console.log('üß† Analysis complete, moving to results');
                    this.analysisData = data;
                    this.moveToResults(data);
                } else if (data.status === 'failed') {
                    // Analysis failed
                    clearInterval(pollInterval);
                    console.error('üß† Analysis failed:', data.error);
                    this.handleAnalysisError(data.error || 'Background analysis failed');
                } else if (data.status === 'processing') {
                    // Still processing - continue polling
                    console.log('üß† Still processing, continuing to poll...');
                } else {
                    // Unexpected status
                    console.warn('üß† Unexpected status:', data.status);
                }
                
                // Check if we've exceeded max polls
                if (pollCount >= maxPolls) {
                    clearInterval(pollInterval);
                    console.error('üß† Polling timeout reached');
                    this.handleAnalysisError('Analysis is taking longer than expected. Please try again.');
                }
                
            } catch (error) {
                console.error('üß† Polling error:', error);
                // Don't stop polling immediately on network errors, but count them
                if (pollCount >= maxPolls) {
                    clearInterval(pollInterval);
                    this.handleAnalysisError('Network error during analysis. Please try again.');
                }
            }
        }, 5000); // Poll every 5 seconds
    }
    
    moveToResults(data) {
        console.log('üß† Moving to results with data:', data);
        setTimeout(() => {
            console.log('üß† Moving to step 3 now...');
            this.updateStep(3);
            console.log('üß† Step 3 update complete, now displaying results...');
            this.displayResults(data);
            console.log('üß† Display results complete');
        }, 1000);
    }
    
    handleAnalysisError(errorMessage) {
        console.error('üß† Handling analysis error:', errorMessage);
        // Stay on step 2 (analysis) to avoid bouncing back to input
        this.updateStep(2);
        
        // Show error in the status
        const statusElement = document.querySelector('#step-2 .step-status');
        if (statusElement) {
            statusElement.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    ${errorMessage}
                </div>
            `;
        }
    }
    
    displayResults(data) {
        console.log('üß† displayResults called with data:', data);
        console.log('üß† Data structure:', JSON.stringify(data, null, 2));
        
        const summaryContainer = document.getElementById('analysis-summary');
        const feedbackContainer = document.getElementById('detailed-feedback');
        
        console.log('üß† Container check:');
        console.log('üß† summaryContainer exists:', !!summaryContainer);
        console.log('üß† feedbackContainer exists:', !!feedbackContainer);
        console.log('üß† summaryContainer element:', summaryContainer);
        console.log('üß† feedbackContainer element:', feedbackContainer);
        
        if (!summaryContainer || !feedbackContainer) {
            console.error('üß† Missing containers:', { summaryContainer, feedbackContainer });
            console.log('üß† Searching for containers in document...');
            const allElements = document.querySelectorAll('[id*="analysis"], [id*="feedback"], [id*="summary"]');
            console.log('üß† Related elements found:', allElements);
            return;
        }
        
        // Extract analysis data from response
        const analysis = data.analysis || {};
        const step = data.step || {};
        
        console.log('üß† Extracted analysis:', analysis);
        console.log('üß† Extracted step:', step);
        
        // Create professional summary card
        console.log('üß† Generating summary HTML...');
        const summaryHTML = `
            <div class="card analysis-card border-0 mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                <i class="bi bi-clipboard-data text-primary" style="font-size: 1.5rem;"></i>
                            </div>
                        </div>
                        <div class="col">
                            <h5 class="card-title mb-1">Clinical Reasoning Analysis Complete</h5>
                            <p class="card-text text-muted mb-2">
                                Your reasoning demonstrates ${analysis.reasoning_quality || 'good'} clinical decision-making patterns.
                            </p>
                            <div class="d-flex gap-2">
                                <span class="badge bg-primary">${analysis.primary_error || 'Systematic Approach'}</span>
                                <span class="badge bg-info">Confidence: ${analysis.confidence_score || 'N/A'}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        console.log('üß† Setting summaryContainer innerHTML...');
        summaryContainer.innerHTML = summaryHTML;
        console.log('üß† Summary HTML set successfully');
        
        console.log('üß† Generating detailed feedback...');
        const hasBody = (analysis && analysis.analysis_summary && String(analysis.analysis_summary).trim().length > 0) || (step && step.content && String(step.content).trim().length > 0);
        const feedbackHTML = this.generateDetailedFeedback(analysis, step) || '';
        console.log('üß† Feedback HTML generated, length:', feedbackHTML.length);
        
        console.log('üß† Setting feedbackContainer innerHTML...');
        feedbackContainer.innerHTML = feedbackHTML;
        if (!hasBody) {
            // Visible notice to the user if analysis body is missing
            const warn = document.createElement('div');
            warn.className = 'alert alert-warning mt-2';
            warn.innerHTML = '<i class="bi bi-info-circle"></i> Analysis generated without detailed text. Please retry in a moment or refresh the page.';
            feedbackContainer.prepend(warn);
        }
        console.log('üß† Feedback HTML set successfully');
        
        console.log('üß† Final check - summary container content:', summaryContainer.innerHTML.length);
        console.log('üß† Final check - feedback container content:', feedbackContainer.innerHTML.length);
    }
    
    generateDetailedFeedback(analysis, step) {
        console.log('üß† generateDetailedFeedback called with:', { analysis, step });
        
        // Use step data if available, otherwise show generic feedback
        const hasStepData = step && step.title;
        
        if (hasStepData) {
            // Since the enhanced analysis_summary now contains all the formatted content,
            // just display it without additional sections to avoid duplication
            return `
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        ${analysis.analysis_summary ? `
                            <div class="enhanced-analysis-content">
                                ${analysis.analysis_summary}
                            </div>
                        ` : `
                            <h5 class="card-title text-primary mb-3">
                                <i class="bi bi-lightbulb me-2"></i>${step.title || 'Clinical Reasoning Analysis'}
                            </h5>
                            <p class="card-text">${step.content || 'Your clinical reasoning has been analyzed.'}</p>
                        `}
                        
                        ${step.question ? `
                            <div class="alert alert-info mt-3">
                                <h6 class="alert-heading"><i class="bi bi-question-circle me-2"></i>Reflection Question</h6>
                                <p class="mb-0">${step.question}</p>
                            </div>
                        ` : ''}
                        
                        ${step.evidence ? `
                            <div class="mt-3">
                                <h6 class="text-secondary"><i class="bi bi-journal-medical me-2"></i>Supporting Evidence</h6>
                                <p class="text-muted">${step.evidence}</p>
                            </div>
                        ` : ''}
                        
                        ${step.action ? `
                            <div class="mt-3">
                                <h6 class="text-success"><i class="bi bi-check2-circle me-2"></i>Recommended Next Steps</h6>
                                <p>${step.action}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="feedback-section p-4">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-graph-up me-2"></i>Analysis Summary
                            </h6>
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="metric-box p-3">
                                        <h3 class="text-primary">${analysis.confidence_score || '‚Äî'}%</h3>
                                        <p class="text-muted mb-0">Confidence Score</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-box p-3">
                                        <h3 class="text-success">${analysis.reasoning_quality || 'Good'}</h3>
                                        <p class="text-muted mb-0">Reasoning Quality</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-box p-3">
                                        <h3 class="text-info">${analysis.total_steps || '1'}</h3>
                                        <p class="text-muted mb-0">Analysis Steps</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Fallback to generic feedback if no step data
        return `
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="feedback-section p-4 h-100">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-check-circle-fill me-2"></i>Strengths Identified
                        </h6>
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Systematic approach to differential diagnosis</li>
                            <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Appropriate risk stratification</li>
                            <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Evidence-based reasoning</li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="feedback-section p-4 h-100">
                        <h6 class="text-warning mb-3">
                            <i class="bi bi-lightbulb-fill me-2"></i>Areas for Enhancement
                        </h6>
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="bi bi-arrow-right text-info me-2"></i>Consider broader differential diagnosis</li>
                            <li class="mb-2"><i class="bi bi-arrow-right text-info me-2"></i>Include more clinical reasoning steps</li>
                            <li class="mb-2"><i class="bi bi-arrow-right text-info me-2"></i>Enhance pattern recognition skills</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <h6 class="text-primary mb-3">
                        <i class="bi bi-mortarboard-fill me-2"></i>Educational Recommendations
                    </h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="text-center">
                                <div class="bg-primary bg-opacity-10 rounded-circle p-3 mx-auto mb-2" style="width: 60px; height: 60px;">
                                    <i class="bi bi-book text-primary" style="font-size: 1.5rem;"></i>
                                </div>
                                <h6 class="fw-bold">Study Resources</h6>
                                <p class="text-muted small">Review clinical decision-making frameworks</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="text-center">
                                <div class="bg-success bg-opacity-10 rounded-circle p-3 mx-auto mb-2" style="width: 60px; height: 60px;">
                                    <i class="bi bi-people text-success" style="font-size: 1.5rem;"></i>
                                </div>
                                <h6 class="fw-bold">Practice</h6>
                                <p class="text-muted small">Engage in more case-based discussions</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="text-center">
                                <div class="bg-info bg-opacity-10 rounded-circle p-3 mx-auto mb-2" style="width: 60px; height: 60px;">
                                    <i class="bi bi-trophy text-info" style="font-size: 1.5rem;"></i>
                                </div>
                                <h6 class="fw-bold">Next Steps</h6>
                                <p class="text-muted small">Focus on pattern recognition skills</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    restartAnalysis() {
        // Reset to step 1
        this.updateStep(1);
        
        // Clear previous data
        this.analysisData = null;
        
        // Reset form
        const textarea = document.getElementById('clinical-reasoning-textarea');
        if (textarea) {
            textarea.value = '';
            textarea.classList.remove('is-valid', 'is-invalid');
        }
        
        this.updateCharacterCount();
        
        // Reset input method
        const typeInput = document.getElementById('type-input');
        if (typeInput) {
            typeInput.checked = true;
            typeInput.dispatchEvent(new Event('change'));
        }
    }
    
    saveAnalysis() {
        if (!this.analysisData) return;
        
        const analysisReport = {
            timestamp: new Date().toISOString(),
            reasoning: document.getElementById('clinical-reasoning-textarea').value,
            analysis: this.analysisData,
            mcq_id: window.location.pathname.split('/')[2]
        };
        
        const dataStr = JSON.stringify(analysisReport, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `clinical_reasoning_analysis_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
    }
    
    showValidationError(message) {
        const validation = document.getElementById('reasoning-validation');
        if (validation) {
            validation.innerHTML = `<i class="bi bi-exclamation-triangle text-danger"></i> ${message}`;
            validation.className = 'text-danger small';
        }
    }
    
    showAnalysisError(message) {
        const currentStep = document.getElementById('current-analysis-step');
        if (currentStep) {
            currentStep.textContent = message;
            currentStep.className = 'text-danger small';
        }
    }
}

// Professional function to open the clinical reasoning modal - make it globally available
window.openClinicalReasoningAnalysis = function(mcqId, isCorrect, selectedAnswer, correctAnswer) {
    console.log('‚úÖ openClinicalReasoningAnalysis function called successfully!');
    console.log('Opening Clinical Reasoning Analysis:', { mcqId, isCorrect, selectedAnswer, correctAnswer });
    
    // Store the context for later use in analysis
    clinicalReasoningContext = {
        mcqId: mcqId,
        isCorrect: isCorrect,
        selectedAnswer: selectedAnswer,
        correctAnswer: correctAnswer
    };
    
    // Check if modal exists
    const modalElement = document.getElementById('clinical-reasoning-modal');
    if (!modalElement) {
        console.error('Clinical reasoning modal not found!');
        alert('Modal not found. Please refresh the page.');
        return;
    }
    
    // Check if Bootstrap is available
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap not loaded!');
        alert('Bootstrap not loaded. Please refresh the page.');
        return;
    }
    
    // Set up the answer context banner
    const banner = document.getElementById('answer-context-banner');
    if (banner) {
        if (isCorrect) {
            banner.innerHTML = `
                <div class="alert alert-success border-0 mb-0">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                        </div>
                        <div class="col">
                            <h6 class="alert-heading mb-1">Excellent! Correct Answer Selected</h6>
                            <p class="mb-0 small">
                                You chose <strong>${selectedAnswer}</strong>, which is correct. 
                                Now let's analyze your clinical reasoning process to reinforce your decision-making skills.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        } else {
            banner.innerHTML = `
                <div class="alert alert-warning border-0 mb-0">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-info-circle-fill text-warning" style="font-size: 1.5rem;"></i>
                        </div>
                        <div class="col">
                            <h6 class="alert-heading mb-1">Learning Opportunity Identified</h6>
                            <p class="mb-0 small">
                                You selected <strong>${selectedAnswer}</strong>, but the correct answer is <strong>${correctAnswer}</strong>. 
                                Let's analyze your reasoning to identify learning opportunities and strengthen your clinical thinking.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    // Show the modal
    const reasoningModalElement = document.getElementById('clinical-reasoning-modal');
    const modal = new bootstrap.Modal(reasoningModalElement);
    
    // Hide the reasoning button when modal is shown
    const reasoningButton = document.getElementById('launch-reasoning-pal');
    const reasoningContainer = document.getElementById('reasoning-pal-button-container');
    if (reasoningButton) {
        reasoningButton.style.display = 'none';
        console.log('ü´• Hidden reasoning button while modal is open');
    }
    
    // Add modal cleanup handler to fix backdrop issues
    reasoningModalElement.addEventListener('hidden.bs.modal', function () {
        console.log('üßπ Cleaning up modal backdrops...');
        // Remove any lingering backdrops
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.remove();
        });
        
        // Remove modal-open class from body
        document.body.classList.remove('modal-open');
        
        // Reset body padding and overflow
        document.body.style.paddingRight = '';
        document.body.style.overflow = '';
        
        // Show the reasoning button again when modal is hidden
        if (reasoningButton) {
            reasoningButton.style.display = 'block';
            console.log('üëÅÔ∏è Showed reasoning button after modal closed');
        }
        
        // Clean up any Bootstrap modal data
        if (reasoningModalElement._backdrop) {
            reasoningModalElement._backdrop = null;
        }
    }, { once: true });
    
    modal.show();
}

// Debug: Confirm function is defined globally
console.log('üîß openClinicalReasoningAnalysis function defined globally');
console.log('üîß Function available as window.openClinicalReasoningAnalysis:', typeof window.openClinicalReasoningAnalysis === 'function');

// Debug function to test button clicks
window.debugReasoningButton = function() {
    const btn = document.getElementById('launch-reasoning-pal');
    if (btn) {
        console.log('üîç Debug: Button found');
        console.log('üîç Button display:', window.getComputedStyle(btn).display);
        console.log('üîç Button visibility:', window.getComputedStyle(btn).visibility);
        console.log('üîç Button pointer-events:', window.getComputedStyle(btn).pointerEvents);
        console.log('üîç Button z-index:', window.getComputedStyle(btn).zIndex);
        console.log('üîç Button position:', window.getComputedStyle(btn).position);
        console.log('üîç Button disabled:', btn.disabled);
        console.log('üîç Button onclick:', btn.onclick);
        
        // Check for overlapping elements
        const rect = btn.getBoundingClientRect();
        const elementAtPoint = document.elementFromPoint(rect.left + rect.width/2, rect.top + rect.height/2);
        console.log('üîç Element at button center:', elementAtPoint);
        console.log('üîç Is button?', elementAtPoint === btn || btn.contains(elementAtPoint));
        
        // Try to click it programmatically
        console.log('üîç Attempting programmatic click...');
        btn.click();
    } else {
        console.log('üîç Debug: Button not found!');
        console.log('üîç Checking container:', document.getElementById('reasoning-pal-button-container'));
    }
};

// Initialize the clinical reasoning analyzer globally
window.clinicalReasoningAnalyzer = null;
document.addEventListener('DOMContentLoaded', function() {
    window.clinicalReasoningAnalyzer = new ClinicalReasoningAnalyzer();
    console.log('üîß ClinicalReasoningAnalyzer initialized globally');
    
    // Add global click listener to debug clicks on reasoning button
    document.addEventListener('click', function(e) {
        if (e.target.id === 'launch-reasoning-pal' || e.target.closest('#launch-reasoning-pal')) {
            console.log('üéØ Global click detected on reasoning button!');
            console.log('üéØ Target:', e.target);
            console.log('üéØ Event propagation stopped?', e.defaultPrevented);
        }
}, true);
});

function renderQuestionDisplay(rawText) {
    const displayEl = document.getElementById('questionDisplay');
    if (!displayEl) {
        return;
    }
    if (!rawText) {
        displayEl.innerHTML = '<span class="text-muted">No question text available.</span>';
        return;
    }

    const paragraphs = String(rawText).split(/\n{2,}/).map(part => part.trim()).filter(Boolean);

    if (!paragraphs.length) {
        paragraphs.push(rawText.trim());
    }

    displayEl.innerHTML = paragraphs
        .map(paragraph => `<p>${paragraph.replace(/\n/g, '<br>')}</p>`)
        .join('');
}

// All old ReasoningPal functions removed - now using ClinicalReasoningAnalyzer class

// All old ReasoningPal voice recording functions removed - now using ClinicalReasoningAnalyzer class

// All old ReasoningPal event listeners removed - now using ClinicalReasoningAnalyzer class
</script>

<script>
function adminDebugLog(message, type) {
    if (typeof debugLog !== 'undefined') {
        try {
            debugLog(message, type);
        } catch (err) {
            if (window && window.console && typeof window.console.log === 'function') {
                window.console.log('[AdminDebug]', message);
            }
        }
    }
}

function truncateForDebug(text, maxLength) {
    if (!text) {
        return '';
    }
    const limit = maxLength || 160;
    const stringified = String(text);
    if (stringified.length <= limit) {
        return stringified;
    }
    return stringified.slice(0, limit) + '‚Ä¶';
}

window.adminDebugLog = adminDebugLog;

async function parseJsonWithDebug(response, contextLabel) {
    const label = contextLabel || 'request';
    let rawText = '';

    try {
        rawText = await response.text();
    } catch (err) {
        adminDebugLog(`‚ùå [${label}] Failed to read response body: ${err}`, 'error');
        throw err;
    }

    adminDebugLog(`üì• [${label}] HTTP ${response.status} ${response.ok ? 'OK' : 'ERROR'}; body preview: ${truncateForDebug(rawText, 240) || '[empty]'}`);

    if (!response.ok) {
        const message = rawText ? rawText : `HTTP ${response.status}`;
        adminDebugLog(`‚ùå [${label}] Non-OK response: ${truncateForDebug(message, 200)}`, 'error');
        throw new Error(`HTTP ${response.status}`);
    }

    if (!rawText) {
        return {};
    }

    try {
        return JSON.parse(rawText);
    } catch (err) {
        adminDebugLog(`‚ùå [${label}] Invalid JSON: ${err}`, 'error');
        throw err;
    }
}
</script>

{% if user.is_staff %}
<script type="module" src="{% static 'js/admin_ai_editor.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    if (window.AIAdminEditor && typeof window.AIAdminEditor.init === 'function') {
        window.AIAdminEditor.init({
            mcqId: {{ mcq.id }},
            initialExplanationText: "{{ initial_explanation_text|default:''|escapejs }}",
            endpoints: {
                question: "{% url 'ai_edit_mcq_question' mcq.id %}",
                options: "{% url 'ai_edit_mcq_options' mcq.id %}",
                explanation: "{% url 'ai_edit_mcq_explanation' mcq.id %}",
                regenerate: "{% url 'regenerate_all_explanations' mcq.id %}",
                transcribe: "{% url 'transcribe_audio_enhanced' %}",
                saveQuestion: "{% url 'update_mcq_question' mcq.id %}",
                saveOptions: "{% url 'update_mcq_options' mcq.id %}",
                saveImage: "{% url 'update_mcq_image' mcq.id %}",
                saveExplanation: "{% url 'update_mcq_explanation' mcq.id %}"
            }
        });
    }
});
</script>
{% endif %}
<script type="module">
(function (window, document) {
  window.__MCQ_CORE_ACTIVE = true;

  const lifecycleLogger =
    typeof window.logLifecycle === 'function'
      ? window.logLifecycle
      : function (stage, info) {
          if (typeof window.logUserAction === 'function') {
            window.logUserAction(`[Lifecycle] ${stage}`, info || {});
          } else {
            console.debug('[MCQ lifecycle]', stage, info || {});
          }
        };

  function log(action, detail) {
    if (typeof window.logUserAction === 'function') {
      window.logUserAction(action, detail || {});
    } else {
      console.debug('[MCQ]', action, detail || {});
    }
  }

  function getCsrfToken() {
    const cookie = document.cookie.match(/csrftoken=([^;]+)/);
    if (cookie) return decodeURIComponent(cookie[1]);
    const input = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return input ? input.value : '';
  }

  function parseLetters(value) {
    if (!value) return [];
    if (Array.isArray(value)) return value;
    return String(value)
      .split(',')
      .map((token) => token.trim())
      .filter(Boolean);
  }

  function resetOptionStyles() {
    document.querySelectorAll('.option').forEach((option) => {
      option.classList.remove('option-eliminated', 'option-correct', 'option-incorrect');
    });
  }

  function markOptions(letters, className) {
    parseLetters(letters).forEach((letter) => {
      const el = document.getElementById(`option-${letter}`);
      if (el) {
        el.classList.add(className);
      }
    });
  }

  function ensureExplanationVisibility(visible) {
    const explanation = document.getElementById('explanation');
    const toggleBtn = document.getElementById('showExplanationBtn');
    if (!explanation) return;
    explanation.style.display = visible ? 'block' : 'none';
    if (toggleBtn) {
      const icon = toggleBtn.querySelector('i');
      const label = toggleBtn.querySelector('span');
      if (icon) icon.className = visible ? 'bi bi-lightbulb-off' : 'bi bi-lightbulb';
      if (label) label.textContent = visible ? 'Hide Explanation' : 'Show Explanation';
    }
  }

  let strikethroughActive = false;

  function updateStrikethroughButton() {
    const btn = document.getElementById('strikethroughToggleBtn');
    const tip = document.querySelector('.text-muted.small.mb-3');
    document.body.dataset.strikethrough = strikethroughActive ? 'on' : 'off';

    if (btn) {
      btn.classList.toggle('btn-secondary', strikethroughActive);
      btn.classList.toggle('btn-outline-secondary', !strikethroughActive);
      btn.innerHTML = strikethroughActive
        ? '<i class="bi bi-pencil-square"></i> Strikethrough (ON)'
        : '<i class="bi bi-pencil-square"></i> Strikethrough';
    }

    if (tip) {
      tip.innerHTML = strikethroughActive
        ? '<i class="bi bi-info-circle"></i> Strikethrough mode is ON. Click option text to eliminate. Click the button again to turn OFF.'
        : '<i class="bi bi-info-circle"></i> Click "Strikethrough" button to enable elimination mode.';
      tip.classList.toggle('text-primary', strikethroughActive);
    }

    document.querySelectorAll('.option-text-content').forEach((span) => {
      span.style.cursor = strikethroughActive ? 'pointer' : 'default';
    });
  }

  function bindOptionClicks() {
    document.querySelectorAll('.option').forEach((option) => {
      const textSpan = option.querySelector('.option-text-content');
      const radio = option.querySelector('.form-check-input');

      if (textSpan) {
        textSpan.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          if (strikethroughActive) {
            option.classList.toggle('option-eliminated');
            const letter = option.id.replace('option-', '');
            log(`Option ${letter} ${option.classList.contains('option-eliminated') ? 'eliminated' : 'restored'}`);
          } else if (radio) {
            radio.checked = true;
            radio.dispatchEvent(new Event('change', { bubbles: true }));
          }
        });
      }

      if (radio) {
        radio.addEventListener('change', () => {
          option.classList.remove('option-eliminated');
        });
      }
    });
  }

  function buildReasoningButton(mcqId, result, selected) {
    const container = document.getElementById('reasoning-pal-button-container');
    if (!container) return;
    container.innerHTML = '';

    const wrapper = document.createElement('div');
    wrapper.className = 'reasoning-pal-button-wrapper';

    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'btn btn-success';
    button.innerHTML = '<i class="bi bi-brain"></i> Analyze My Clinical Reasoning';
    button.addEventListener('click', () => {
      if (typeof window.openClinicalReasoningAnalysis === 'function') {
        window.openClinicalReasoningAnalysis(mcqId, result.is_correct, selected, result.correct_answer);
      }
    });

    wrapper.appendChild(button);
    container.appendChild(wrapper);
  }

  function updateReasoningPrompt(result, selected) {
    const prompt = document.getElementById('request-prompt');
    if (!prompt) return;
    if (result.is_correct) {
      prompt.innerHTML = `<div class="alert alert-success"><h4><i class="bi bi-check-circle"></i> Your answer (${selected}) is correct.</h4><p>Please explain your clinical reasoning process.</p></div>`;
    } else {
      prompt.innerHTML = `<div class="alert alert-danger"><h4><i class="bi bi-x-circle"></i> Your answer (${selected}) is incorrect.</h4><p>The correct answer is ${result.correct_answer}. Describe your reasoning.</p></div>`;
    }
  }

  function handleCheckAnswer() {
    const btn = document.getElementById('checkAnswerBtn');
    if (!btn) return;
    const endpoint = btn.dataset.checkUrl || `/mcq/${btn.dataset.mcqId}/check_answer/`;
    if (!endpoint) {
      alert('Check answer endpoint unavailable.');
      return;
    }

    const selected = document.querySelector('input[name="answer"]:checked');
    if (!selected) {
      alert('Please select an answer first.');
      return;
    }

    const formData = new FormData();
    formData.append('answer', selected.value);

    const headers = {};
    const csrf = getCsrfToken();
    if (csrf) {
      headers['X-CSRFToken'] = csrf;
    }

    fetch(endpoint, {
      method: 'POST',
      body: formData,
      headers,
      credentials: 'same-origin',
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        log('Answer check response', data);
        resetOptionStyles();
        if (data.is_correct) {
          markOptions(selected.value, 'option-correct');
        } else {
          markOptions(selected.value, 'option-incorrect');
          markOptions(data.correct_answer, 'option-correct');
        }

        ensureExplanationVisibility(true);
        buildReasoningButton(btn.dataset.mcqId, data, selected.value);
        updateReasoningPrompt(data, selected.value);

        const submitReasoningBtn = document.getElementById('submit-reasoning-btn');
        if (submitReasoningBtn) {
          submitReasoningBtn.onclick = function () {
            if (typeof window.openClinicalReasoningAnalysis === 'function') {
              window.openClinicalReasoningAnalysis(btn.dataset.mcqId, data.is_correct, selected.value, data.correct_answer);
            }
          };
        }
      })
      .catch((error) => {
        console.error('Check answer failed:', error);
        alert('Unable to verify the answer right now. Please try again.');
      });
  }

  function toggleExplanation() {
    console.debug('[MCQ] toggleExplanation invoked');
    const explanation = document.getElementById('explanation');
    if (!explanation) return;
    const isHidden = explanation.style.display === 'none' || explanation.style.display === '';
    ensureExplanationVisibility(isHidden);
  }

  function toggleStrikethrough(button) {
    console.debug('[MCQ] toggleStrikethrough invoked');
    strikethroughActive = !strikethroughActive;
    updateStrikethroughButton();
    log('Strikethrough mode toggled', { active: strikethroughActive });
  }

  function init() {
    window.__MCQ_CORE_ACTIVE = true;
    lifecycleLogger('MCQCore init start', { readyState: document.readyState });
    log('Initialising core MCQ handlers (inline script)');
    const explanation = document.getElementById('explanation');
    if (explanation) explanation.style.display = 'none';

    const checkBtn = document.getElementById('checkAnswerBtn');
    if (checkBtn) {
      if (!checkBtn.dataset.checkUrl && checkBtn.dataset.mcqId) {
        checkBtn.dataset.checkUrl = `/mcq/${checkBtn.dataset.mcqId}/check_answer/`;
      }
      checkBtn.addEventListener('click', function (event) {
        event.preventDefault();
        handleCheckAnswer();
      });
      log('Check answer button wired (MCQCore)', { id: checkBtn.id });
    } else {
      log('Check answer button missing; MCQCore wiring skipped');
    }

    const showBtn = document.getElementById('showExplanationBtn');
    if (showBtn) {
      showBtn.addEventListener('click', function (event) {
        event.preventDefault();
        toggleExplanation();
      });
      log('Explanation toggle wired (MCQCore)', { id: showBtn.id });
    } else {
      log('Explanation toggle missing; MCQCore wiring skipped');
    }

    const strikeBtn = document.getElementById('strikethroughToggleBtn');
    if (strikeBtn) {
      strikeBtn.addEventListener('click', function (event) {
        event.preventDefault();
        toggleStrikethrough(strikeBtn);
      });
      log('Strikethrough toggle wired (MCQCore)', { id: strikeBtn.id });
    } else {
      log('Strikethrough toggle missing; MCQCore wiring skipped');
    }

    updateStrikethroughButton();
    bindOptionClicks();
    lifecycleLogger('MCQCore init complete', { strikethroughActive });
  }

  window.MCQCore = {
    checkAnswer: handleCheckAnswer,
    toggleExplanation: toggleExplanation,
    toggleStrikethrough: toggleStrikethrough,
  };

  window.toggleStrikethroughMode = function () {
    if (window.MCQCore) {
      window.MCQCore.toggleStrikethrough(document.getElementById('strikethroughToggleBtn'));
    }
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})(window, document);
</script>

<script nomodule>
(function () {
    function ready(fn) {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fn);
        } else {
            fn();
        }
    }

    function log(action, detail) {
        if (typeof window.logUserAction === 'function') {
            try {
                window.logUserAction(action, detail || {});
            } catch (err) {
                if (window.console && console.debug) {
                    console.debug('[Fallback]', action, detail || {});
                }
            }
        }
    }

    function getCsrfToken() {
        var match = document.cookie.match(/csrftoken=([^;]+)/);
        if (match) {
            try {
                return decodeURIComponent(match[1]);
            } catch (err) {
                return match[1];
            }
        }
        var input = document.querySelector('input[name="csrfmiddlewaretoken"]');
        return input ? input.value : '';
    }

    ready(function () {
        var explanation = document.getElementById('explanation');
        if (explanation) {
            explanation.style.display = 'none';
        }

        var showBtn = document.getElementById('showExplanationBtn');
        var strikethroughBtn = document.getElementById('strikethroughToggleBtn');
        var editBtn = document.getElementById('toggleEditMode');
        var strikethroughActive = false;

        function setStrikethroughState(button, active) {
            strikethroughActive = !!active;

            if (button) {
                button.className = strikethroughActive ? 'btn btn-secondary btn-sm' : 'btn btn-outline-secondary btn-sm';
                button.innerHTML = strikethroughActive
                    ? '<i class="bi bi-pencil-square"></i> Strikethrough (ON)'
                    : '<i class="bi bi-pencil-square"></i> Strikethrough';
            }

            var tip = document.querySelector('.text-muted.small.mb-3');
            if (tip) {
                if (strikethroughActive) {
                    tip.innerHTML = '<i class="bi bi-info-circle"></i> Strikethrough mode is ON. Click on option text to eliminate. Click the button again to turn OFF.';
                    tip.classList.add('text-primary');
                } else {
                    tip.innerHTML = '<i class="bi bi-info-circle"></i> Click "Strikethrough" button to enable elimination mode.';
                    tip.classList.remove('text-primary');
                }
            }

            var spans = document.querySelectorAll('.option-text-content');
            for (var i = 0; i < spans.length; i += 1) {
                spans[i].style.cursor = strikethroughActive ? 'pointer' : 'default';
            }

            document.body.setAttribute('data-strikethrough', strikethroughActive ? 'on' : 'off');
            log('Strikethrough mode ' + (strikethroughActive ? 'enabled' : 'disabled'));
        }

        function bindOptionClicks() {
            var options = document.querySelectorAll('.option');
            for (var i = 0; i < options.length; i += 1) {
                (function (option) {
                    var textSpan = option.querySelector('.option-text-content');
                    var radio = option.querySelector('.form-check-input');
                    if (textSpan) {
                        textSpan.addEventListener('click', function (event) {
                            event.preventDefault();
                            event.stopPropagation();
                            if (strikethroughActive) {
                                option.classList.toggle('option-eliminated');
                                var letter = option.id ? option.id.replace('option-', '') : '';
                                log('Option ' + letter + (option.classList.contains('option-eliminated') ? ' eliminated' : ' restored'));
                            } else if (radio) {
                                radio.checked = true;
                                try {
                                    var changeEvent = document.createEvent('Event');
                                    changeEvent.initEvent('change', true, true);
                                    radio.dispatchEvent(changeEvent);
                                } catch (err) {
                                    radio.onchange && radio.onchange();
                                }
                            }
                        });
                    }
                    if (radio) {
                        radio.addEventListener('change', function () {
                            if (option.classList.contains('option-eliminated')) {
                                option.classList.remove('option-eliminated');
                            }
                        });
                    }
                })(options[i]);
            }
        }

        function toggleExplanation() {
            if (!explanation) {
                return;
            }
            var isHidden = explanation.style.display === 'none' || explanation.style.display === '';
            explanation.style.display = isHidden ? 'block' : 'none';

            if (showBtn) {
                var icon = showBtn.querySelector('i');
                var label = showBtn.querySelector('span');
                if (icon) {
                    icon.className = isHidden ? 'bi bi-lightbulb-off' : 'bi bi-lightbulb';
                }
                if (label) {
                    label.textContent = isHidden ? 'Hide Explanation' : 'Show Explanation';
                }
            }
            log(isHidden ? 'Explanation shown' : 'Explanation hidden');
        }

        function resetOptionStyles() {
            var options = document.querySelectorAll('.option');
            for (var i = 0; i < options.length; i += 1) {
                options[i].className = 'option';
            }
        }

        function markOptions(letters, className) {
            if (!letters) {
                return;
            }
            var parts = String(letters).split(',');
            for (var i = 0; i < parts.length; i += 1) {
                var letter = parts[i].replace(/\s+/g, '');
                if (!letter) {
                    continue;
                }
                var el = document.getElementById('option-' + letter);
                if (el) {
                    el.classList.add(className);
                }
            }
        }

        function ensureExplanationVisible() {
            if (explanation) {
                explanation.style.display = 'block';
            }
        }

        function handleCheckAnswer() {
            var btn = document.getElementById('checkAnswerBtn');
            if (!btn) {
                return;
            }

            var selected = document.querySelector('input[name="answer"]:checked');
            if (!selected) {
                alert('Please select an answer first.');
                return;
            }

            var endpoint = btn.getAttribute('data-check-url');
            if (!endpoint) {
                var mcqId = btn.getAttribute('data-mcq-id');
                endpoint = mcqId ? '/mcq/' + mcqId + '/check_answer/' : null;
            }
            if (!endpoint || typeof window.fetch !== 'function' || typeof FormData === 'undefined') {
                alert('Your browser cannot verify answers. Please upgrade to a newer browser.');
                return;
            }

            var formData = new FormData();
            formData.append('answer', selected.value);

            var headers = {};
            var csrf = getCsrfToken();
            if (csrf) {
                headers['X-CSRFToken'] = csrf;
            }

            fetch(endpoint, {
                method: 'POST',
                body: formData,
                headers: headers,
                credentials: 'same-origin'
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(function (data) {
                    resetOptionStyles();
                    if (data.is_correct) {
                        markOptions(selected.value, 'option-correct');
                    } else {
                        markOptions(selected.value, 'option-incorrect');
                        markOptions(data.correct_answer, 'option-correct');
                    }
                    ensureExplanationVisible();
                })
                .catch(function (error) {
                    console.error('Check answer failed (legacy mode):', error);
                    alert('Unable to verify the answer right now. Please try again.');
                });
        }

        function toggleEditMode() {
            var sections = ['questionEditSection', 'imageEditSection', 'optionsEditSection', 'explanationEditSection'];
            var isEditing = editBtn && editBtn.className.indexOf('btn-outline-info') !== -1;

            for (var i = 0; i < sections.length; i += 1) {
                var section = document.getElementById(sections[i]);
                if (section) {
                    section.style.display = isEditing ? 'block' : 'none';
                }
            }

            if (editBtn) {
                if (isEditing) {
                    editBtn.innerHTML = '<i class="bi bi-x-circle"></i> Cancel Editing';
                    editBtn.classList.remove('btn-outline-info');
                    editBtn.classList.add('btn-outline-danger');
                } else {
                    editBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit MCQ';
                    editBtn.classList.remove('btn-outline-danger');
                    editBtn.classList.add('btn-outline-info');
                }
            }
        }

        if (showBtn) {
            showBtn.addEventListener('click', function (event) {
                event.preventDefault();
                toggleExplanation();
            });
        }

        if (strikethroughBtn) {
            strikethroughBtn.addEventListener('click', function (event) {
                event.preventDefault();
                setStrikethroughState(strikethroughBtn, !strikethroughActive);
            });
        }

        if (editBtn) {
            editBtn.addEventListener('click', function (event) {
                event.preventDefault();
                toggleEditMode();
            });
        }

        bindOptionClicks();
        setStrikethroughState(strikethroughBtn, false);

        window.MCQCore = {
            checkAnswer: handleCheckAnswer,
            toggleExplanation: toggleExplanation,
            toggleStrikethrough: function (button) {
                setStrikethroughState(button || strikethroughBtn, !strikethroughActive);
            }
        };
    });
})();
</script>

<!-- Include the Report Question Modal -->
{% include 'mcq/report_question_modal.html' %}

<!-- Case Conversion Debug Modal -->
<div class="modal fade" id="caseConversionDebugModal" tabindex="-1" aria-labelledby="caseConversionDebugModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="caseConversionDebugModalLabel">
                    <i class="bi bi-bug-fill"></i> Case Conversion Debug Information
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" id="debugErrorMessage"></div>
                
                <h6 class="mt-3">Detailed Debug Log:</h6>
                <div class="accordion" id="debugAccordion">
                    <!-- Debug log entries will be inserted here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="copyDebugLog()">
                    <i class="bi bi-clipboard"></i> Copy Debug Log
                </button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Function to show case conversion debug modal
function showCaseConversionDebugModal(error, debugLog) {
    console.log('Showing debug modal with:', { error, debugLog });
    
    // Set error message
    document.getElementById('debugErrorMessage').innerHTML = `
        <strong>Error:</strong> ${error}
    `;
    
    // Clear previous debug entries
    const accordion = document.getElementById('debugAccordion');
    accordion.innerHTML = '';
    
    // Process debug log
    if (Array.isArray(debugLog)) {
        debugLog.forEach((entry, index) => {
            const timestamp = new Date(entry.timestamp).toLocaleTimeString();
            const stepClass = entry.step.includes('ERROR') ? 'text-danger' : 
                            entry.step.includes('SUCCESS') ? 'text-success' : 
                            entry.step.includes('WARNING') ? 'text-warning' : '';
            
            const accordionItem = document.createElement('div');
            accordionItem.className = 'accordion-item';
            accordionItem.innerHTML = `
                <h2 class="accordion-header" id="heading${index}">
                    <button class="accordion-button ${index > 0 ? 'collapsed' : ''} ${stepClass}" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#collapse${index}" 
                            aria-expanded="${index === 0 ? 'true' : 'false'}" 
                            aria-controls="collapse${index}">
                        <span class="me-2">${timestamp}</span>
                        <strong>${entry.step}</strong>
                    </button>
                </h2>
                <div id="collapse${index}" 
                     class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                     aria-labelledby="heading${index}"
                     data-bs-parent="#debugAccordion">
                    <div class="accordion-body">
                        <pre class="mb-0" style="white-space: pre-wrap; font-size: 0.875rem;">${
                            typeof entry.data === 'object' ? 
                            JSON.stringify(entry.data, null, 2) : 
                            entry.data
                        }</pre>
                    </div>
                </div>
            `;
            accordion.appendChild(accordionItem);
        });
    } else if (typeof debugLog === 'string') {
        // If debug log is a string, show it as raw text
        accordion.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <pre style="white-space: pre-wrap;">${debugLog}</pre>
                </div>
            </div>
        `;
    }
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('caseConversionDebugModal'));
    modal.show();
}

// Function to copy debug log to clipboard
function copyDebugLog() {
    const debugContent = {
        error: document.getElementById('debugErrorMessage').textContent,
        debugLog: []
    };
    
    // Collect all debug entries
    document.querySelectorAll('#debugAccordion .accordion-item').forEach((item) => {
        const header = item.querySelector('.accordion-button').textContent.trim();
        const body = item.querySelector('.accordion-body pre').textContent;
        debugContent.debugLog.push({
            header: header,
            data: body
        });
    });
    
    const textToCopy = JSON.stringify(debugContent, null, 2);
    
    navigator.clipboard.writeText(textToCopy).then(() => {
        // Show success message
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Copied!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy debug log to clipboard');
    });
}
</script>

{% endblock %}
