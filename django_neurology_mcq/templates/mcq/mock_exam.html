{% extends "mcq/base.html" %}
{% load static %}

{% block title %}Mock Examination - Neurology MCQ Reader{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-alarm"></i> Mock Examination</h4>
                <div class="exam-timer">
                    <span id="timerDisplay" class="badge bg-dark p-2 fs-5">{{ time_limit }}:00</span>
                </div>
            </div>
            <div class="card-body p-3">
                <div class="d-flex justify-content-between mb-3">
                    <div>
                        <span class="badge bg-primary">Questions: {{ mcqs|length }}</span>
                        <span class="badge bg-info ms-2">Subspecialties: {{ subspecialties|length }}</span>
                        <span class="badge bg-secondary ms-2">{{ exam_type }} Exam</span>
                        {% if start_year and end_year %}
                        <span class="badge bg-warning ms-2">Years: {{ start_year }}-{{ end_year }}</span>
                        {% endif %}
                    </div>
                    <div>
                        <span class="badge bg-dark">Time Remaining: <span id="timerText">{{ time_limit }}:00</span></span>
                    </div>
                </div>
                
                <div class="progress mb-4" style="height: 10px;">
                    <div id="examProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%;" 
                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                
                <form id="examForm" action="{% url 'submit_exam' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="exam_id" value="{{ exam_id }}">
                    
                    {% if display_options == 'all' %}
                    <!-- All questions displayed at once -->
                    {% for mcq in mcqs %}
                    <div class="card mb-4 question-card" id="question-{{ forloop.counter }}">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Question {{ forloop.counter }} of {{ mcqs|length }}</h5>
                            <span class="badge bg-secondary">{{ mcq.subspecialty }}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">{{ mcq.question_text }}</p>

                            {% if mcq.image_url %}
                            <div class="question-image-container mb-4">
                                <img src="{{ mcq.image_url }}" alt="Question Image" class="img-fluid rounded question-image border shadow-sm" style="max-height: 300px;">
                            </div>
                            {% endif %}
                            
                            <div class="options-container">
                                {% if mcq.options %}
                                    {% for option_letter, option_text in mcq.options.items %}
                                    <div class="form-check mb-2 p-2 border-start border-2 option-container">
                                        <input class="form-check-input" type="radio" name="answer-{{ mcq.id }}" id="answer-{{ mcq.id }}-{{ option_letter }}" value="{{ option_letter }}">
                                        <label class="form-check-label" for="answer-{{ mcq.id }}-{{ option_letter }}">
                                            <strong>{{ option_letter }}.</strong> {{ option_text }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="alert alert-warning">No options available for this MCQ.</div>
                                {% endif %}
                            </div>
                            
                            <div class="mt-3 mb-0">
                                <button type="button" class="btn btn-sm btn-outline-primary mark-for-review" data-question="{{ forloop.counter }}">
                                    <i class="bi bi-flag"></i> Mark for Review
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="d-grid gap-2 my-4">
                        <button type="submit" id="submitExamBtn" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle"></i> Submit Examination
                        </button>
                    </div>
                    
                    {% else %}
                    <!-- One question at a time -->
                    <div id="question-container">
                        <!-- Content will be dynamically loaded here -->
                    </div>
                    
                    <div class="d-flex justify-content-between my-4">
                        <button type="button" id="prevQuestionBtn" class="btn btn-secondary" disabled>
                            <i class="bi bi-arrow-left"></i> Previous
                        </button>
                        
                        <div>
                            <button type="button" id="markReviewBtn" class="btn btn-outline-warning me-2">
                                <i class="bi bi-flag"></i> Mark for Review
                            </button>
                            
                            <button type="button" id="submitExamBtn" class="btn btn-primary" style="display: none;">
                                <i class="bi bi-check-circle"></i> Submit Examination
                            </button>
                        </div>
                        
                        <button type="button" id="nextQuestionBtn" class="btn btn-primary">
                            Next <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                    
                    <div class="card mt-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Question Navigator</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-2 justify-content-center" id="questionNav">
                                {% for mcq in mcqs %}
                                <button type="button" class="btn btn-sm btn-outline-secondary question-nav-btn" data-question="{{ forloop.counter }}">
                                    {{ forloop.counter }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="submitConfirmModal" tabindex="-1" aria-labelledby="submitConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="submitConfirmModalLabel"><i class="bi bi-exclamation-triangle"></i> Confirm Submission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to submit your examination?</p>
                <div id="examStats">
                    <p><strong>Answered:</strong> <span id="answeredCount">0</span> of {{ mcqs|length }}</p>
                    <p><strong>Unanswered:</strong> <span id="unansweredCount">{{ mcqs|length }}</span></p>
                    <p><strong>Marked for review:</strong> <span id="reviewCount">0</span></p>
                </div>
                <div class="alert alert-warning">
                    <i class="bi bi-info-circle"></i> Once submitted, you cannot return to the exam.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue Exam</button>
                <button type="button" class="btn btn-warning" id="finalSubmitBtn">Submit Exam</button>
            </div>
        </div>
    </div>
</div>

<!-- Timer Warning Modal -->
<div class="modal fade" id="timerWarningModal" tabindex="-1" aria-labelledby="timerWarningModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="timerWarningModalLabel"><i class="bi bi-alarm"></i> Time Warning</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You have <strong>5 minutes</strong> remaining in this examination.</p>
                <p>Please review your answers and prepare to submit.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue Exam</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Timer functionality
    const timerDisplay = document.getElementById('timerDisplay');
    const timerText = document.getElementById('timerText');
    let timeLimit = {{ time_limit }} * 60; // Convert minutes to seconds
    let timer = timeLimit;
    let timerInterval;
    let warningShown = false;
    
    // Start the timer
    function startTimer() {
        timerInterval = setInterval(function() {
            timer--;
            
            if (timer <= 0) {
                // Time's up, submit the exam
                clearInterval(timerInterval);
                document.getElementById('examForm').submit();
                return;
            }
            
            // Show 5-minute warning
            if (timer === 300 && !warningShown) {
                warningShown = true;
                const warningModal = new bootstrap.Modal(document.getElementById('timerWarningModal'));
                warningModal.show();
            }
            
            // Update timer display
            const minutes = Math.floor(timer / 60);
            const seconds = timer % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timerDisplay) timerDisplay.textContent = display;
            if (timerText) timerText.textContent = display;
            
            // Change color when time is running low
            if (timer < 300) {
                timerDisplay.classList.remove('bg-dark');
                timerDisplay.classList.add('bg-danger');
            }
        }, 1000);
    }
    
    // Start the timer immediately
    startTimer();
    
    // Track exam progress
    const examProgress = document.getElementById('examProgress');
    const totalQuestions = {{ mcqs|length }};
    let answeredQuestions = 0;
    let markedForReview = [];
    
    function updateProgress() {
        // Count answered questions
        answeredQuestions = document.querySelectorAll('input[type="radio"]:checked').length;
        
        // Update progress bar
        const progressPercent = Math.round((answeredQuestions / totalQuestions) * 100);
        examProgress.style.width = `${progressPercent}%`;
        examProgress.setAttribute('aria-valuenow', progressPercent);
        
        // Update stats in confirmation modal
        document.getElementById('answeredCount').textContent = answeredQuestions;
        document.getElementById('unansweredCount').textContent = totalQuestions - answeredQuestions;
        document.getElementById('reviewCount').textContent = markedForReview.length;
    }
    
    // Handle marking questions for review
    const reviewButtons = document.querySelectorAll('.mark-for-review');
    reviewButtons.forEach(button => {
        button.addEventListener('click', function() {
            const questionNum = this.getAttribute('data-question');
            const questionCard = document.getElementById(`question-${questionNum}`);
            
            if (markedForReview.includes(questionNum)) {
                // Remove from review
                markedForReview = markedForReview.filter(q => q !== questionNum);
                questionCard.classList.remove('border-warning');
                this.classList.remove('btn-warning');
                this.classList.add('btn-outline-primary');
                this.innerHTML = '<i class="bi bi-flag"></i> Mark for Review';
            } else {
                // Add to review
                markedForReview.push(questionNum);
                questionCard.classList.add('border-warning');
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-warning');
                this.innerHTML = '<i class="bi bi-flag-fill"></i> Marked for Review';
            }
            
            updateProgress();
        });
    });
    
    // Handle radio button selection
    const radioButtons = document.querySelectorAll('input[type="radio"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            updateProgress();
            
            // Style the selected option
            const allOptions = document.querySelectorAll(`input[name="${this.name}"]`);
            allOptions.forEach(option => {
                const container = option.closest('.option-container');
                if (container) {
                    container.classList.remove('border-primary', 'bg-light');
                }
            });
            
            const selectedContainer = this.closest('.option-container');
            if (selectedContainer) {
                selectedContainer.classList.add('border-primary', 'bg-light');
            }
        });
    });
    
    // Handle one-question-at-a-time mode
    {% if display_options == 'one' %}
    const questionContainer = document.getElementById('question-container');
    const prevBtn = document.getElementById('prevQuestionBtn');
    const nextBtn = document.getElementById('nextQuestionBtn');
    const navButtons = document.querySelectorAll('.question-nav-btn');
    let currentQuestion = 1;
    
    // Question data from server
    const questions = [
        {% for mcq in mcqs %}
        {
            id: {{ mcq.id }},
            number: {{ forloop.counter }},
            text: `{{ mcq.question_text|escapejs }}`,
            options: JSON.parse(`{{ mcq.options|escapejs }}`),
            subspecialty: "{{ mcq.subspecialty|escapejs }}",
            imageUrl: {% if mcq.image_url %}"{{ mcq.image_url }}"{% else %}null{% endif %}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Load a specific question
    function loadQuestion(questionNum) {
        currentQuestion = questionNum;
        const question = questions[questionNum - 1];
        
        // Enable/disable navigation buttons
        prevBtn.disabled = currentQuestion === 1;
        nextBtn.disabled = currentQuestion === questions.length;
        
        // Show submit button on last question
        document.getElementById('submitExamBtn').style.display = 
            currentQuestion === questions.length ? 'block' : 'none';
        
        // Update active nav button
        navButtons.forEach(btn => {
            btn.classList.remove('btn-primary', 'btn-warning', 'btn-success');
            btn.classList.add('btn-outline-secondary');
            
            const btnNum = parseInt(btn.getAttribute('data-question'));
            if (btnNum === currentQuestion) {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-primary');
            } else if (markedForReview.includes(btnNum.toString())) {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-warning');
            } else if (document.querySelector(`input[name="answer-${questions[btnNum-1].id}"]:checked`)) {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
            }
        });
        
        // Build question HTML
        let optionsHtml = '';
        for (const [letter, text] of Object.entries(question.options)) {
            const isChecked = document.querySelector(`input[name="answer-${question.id}"]:checked`)?.value === letter;
            optionsHtml += `
                <div class="form-check mb-2 p-2 border-start border-2 option-container ${isChecked ? 'border-primary bg-light' : ''}">
                    <input class="form-check-input" type="radio" name="answer-${question.id}" 
                        id="answer-${question.id}-${letter}" value="${letter}" ${isChecked ? 'checked' : ''}>
                    <label class="form-check-label" for="answer-${question.id}-${letter}">
                        <strong>${letter}.</strong> ${text}
                    </label>
                </div>
            `;
        }
        
        // Update mark for review button
        const isMarked = markedForReview.includes(question.number.toString());
        const markReviewBtn = document.getElementById('markReviewBtn');
        if (isMarked) {
            markReviewBtn.classList.remove('btn-outline-warning');
            markReviewBtn.classList.add('btn-warning');
            markReviewBtn.innerHTML = '<i class="bi bi-flag-fill"></i> Marked for Review';
        } else {
            markReviewBtn.classList.remove('btn-warning');
            markReviewBtn.classList.add('btn-outline-warning');
            markReviewBtn.innerHTML = '<i class="bi bi-flag"></i> Mark for Review';
        }
        
        // Render the question
        questionContainer.innerHTML = `
            <div class="card question-card ${isMarked ? 'border-warning' : ''}">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Question ${question.number} of ${questions.length}</h5>
                    <span class="badge bg-secondary">${question.subspecialty}</span>
                </div>
                <div class="card-body">
                    <p class="card-text">${question.text}</p>
                    ${question.imageUrl ? `
                    <div class="question-image-container mb-4">
                        <img src="${question.imageUrl}" alt="Question Image" class="img-fluid rounded question-image border shadow-sm" style="max-height: 300px;">
                    </div>
                    ` : ''}
                    <div class="options-container">
                        ${optionsHtml}
                    </div>
                </div>
            </div>
        `;
        
        // Add event listeners to new radio buttons
        document.querySelectorAll(`input[name="answer-${question.id}"]`).forEach(radio => {
            radio.addEventListener('change', function() {
                updateProgress();
                
                // Style the selected option
                const allOptions = document.querySelectorAll(`input[name="${this.name}"]`);
                allOptions.forEach(option => {
                    const container = option.closest('.option-container');
                    if (container) {
                        container.classList.remove('border-primary', 'bg-light');
                    }
                });
                
                const selectedContainer = this.closest('.option-container');
                if (selectedContainer) {
                    selectedContainer.classList.add('border-primary', 'bg-light');
                }
                
                // Update nav button to show answered
                const navBtn = document.querySelector(`.question-nav-btn[data-question="${currentQuestion}"]`);
                if (navBtn) {
                    navBtn.classList.remove('btn-outline-secondary', 'btn-primary', 'btn-warning');
                    navBtn.classList.add('btn-success');
                }
            });
        });
    }
    
    // Load the first question initially
    loadQuestion(1);
    
    // Navigation button event listeners
    prevBtn.addEventListener('click', function() {
        if (currentQuestion > 1) {
            loadQuestion(currentQuestion - 1);
        }
    });
    
    nextBtn.addEventListener('click', function() {
        if (currentQuestion < questions.length) {
            loadQuestion(currentQuestion + 1);
        }
    });
    
    // Question navigator event listeners
    navButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const questionNum = parseInt(this.getAttribute('data-question'));
            loadQuestion(questionNum);
        });
    });
    
    // Mark for review button
    document.getElementById('markReviewBtn').addEventListener('click', function() {
        const questionNum = currentQuestion.toString();
        const questionCard = document.querySelector('.question-card');
        
        if (markedForReview.includes(questionNum)) {
            // Remove from review
            markedForReview = markedForReview.filter(q => q !== questionNum);
            questionCard.classList.remove('border-warning');
            this.classList.remove('btn-warning');
            this.classList.add('btn-outline-warning');
            this.innerHTML = '<i class="bi bi-flag"></i> Mark for Review';
        } else {
            // Add to review
            markedForReview.push(questionNum);
            questionCard.classList.add('border-warning');
            this.classList.remove('btn-outline-warning');
            this.classList.add('btn-warning');
            this.innerHTML = '<i class="bi bi-flag-fill"></i> Marked for Review';
        }
        
        // Update nav button
        const navBtn = document.querySelector(`.question-nav-btn[data-question="${currentQuestion}"]`);
        if (navBtn && !navBtn.classList.contains('btn-success')) {
            navBtn.classList.remove('btn-outline-secondary', 'btn-primary');
            if (markedForReview.includes(questionNum)) {
                navBtn.classList.add('btn-warning');
            } else {
                navBtn.classList.add('btn-primary');
            }
        }
        
        updateProgress();
    });
    {% endif %}
    
    // Exam submission handlers
    const submitBtn = document.getElementById('submitExamBtn');
    const finalSubmitBtn = document.getElementById('finalSubmitBtn');
    
    submitBtn.addEventListener('click', function(e) {
        e.preventDefault();
        updateProgress();
        const confirmModal = new bootstrap.Modal(document.getElementById('submitConfirmModal'));
        confirmModal.show();
    });
    
    finalSubmitBtn.addEventListener('click', function() {
        // Submit the form
        document.getElementById('examForm').submit();
    });
    
    // Initial progress update
    updateProgress();
    
    // Handle beforeunload event to warn about leaving the page
    window.addEventListener('beforeunload', function(e) {
        const message = 'Are you sure you want to leave the exam? Your progress will be lost.';
        e.returnValue = message;
        return message;
    });
});
</script>
{% endblock %}