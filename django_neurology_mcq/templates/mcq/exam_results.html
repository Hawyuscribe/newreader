{% extends "mcq/base.html" %}
{% load static %}

{% block title %}Exam Results - Neurology MCQ Reader{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header {% if passed %}bg-success{% else %}bg-danger{% endif %} text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    {% if passed %}
                    <i class="bi bi-trophy"></i> Examination Passed
                    {% else %}
                    <i class="bi bi-x-octagon"></i> Examination Failed
                    {% endif %}
                </h4>
                <div>
                    <span class="badge bg-light text-dark p-2">{{ score_percentage }}%</span>
                </div>
            </div>
            <div class="card-body p-3">
                <div class="row mb-4">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Exam Summary</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-borderless mb-0">
                                    <tr>
                                        <th>Total Questions:</th>
                                        <td>{{ total_mcqs }}</td>
                                    </tr>
                                    <tr>
                                        <th>Questions Answered:</th>
                                        <td>{{ total_answered }}</td>
                                    </tr>
                                    <tr>
                                        <th>Correct Answers:</th>
                                        <td>{{ correct_count }}</td>
                                    </tr>
                                    <tr>
                                        <th>Score:</th>
                                        <td class="fw-bold {% if passed %}text-success{% else %}text-danger{% endif %}">
                                            {{ score_percentage }}% ({{ correct_count }}/{{ total_mcqs }})
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Time Spent:</th>
                                        <td>
                                            {{ elapsed_time }} minutes of {{ time_limit }} minutes
                                            {% if time_exceeded %}
                                            <span class="badge bg-danger ms-2">Time Exceeded</span>
                                            {% else %}
                                            <span class="badge bg-success ms-2">Within Time Limit</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Status:</th>
                                        <td class="fw-bold {% if passed %}text-success{% else %}text-danger{% endif %}">
                                            {% if passed %}
                                            PASSED (70% required)
                                            {% else %}
                                            FAILED (70% required)
                                            {% endif %}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Subspecialty Performance</h5>
                            </div>
                            <div class="card-body">
                                <div style="height: 250px;">
                                    <canvas id="subspecialtyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
                    <a href="{% url 'dashboard' %}" class="btn btn-primary">
                        <i class="bi bi-house"></i> Return to Dashboard
                    </a>
                    <button type="button" class="btn btn-info" onclick="window.print()">
                        <i class="bi bi-printer"></i> Print Results
                    </button>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Detailed Results</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>Question</th>
                                        <th>Your Answer</th>
                                        <th>Correct Answer</th>
                                        <th>Result</th>
                                        <th class="text-center">Review</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for result in results %}
                                    <tr class="{% if result.is_correct %}table-success{% elif result.is_answered %}table-danger{% else %}table-warning{% endif %}">
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            {{ result.mcq.question_text|truncatechars:80 }}
                                            <div><small class="text-muted">{{ result.mcq.subspecialty }}</small></div>
                                        </td>
                                        <td>
                                            {% if result.is_answered %}
                                            {{ result.user_answer }}
                                            {% else %}
                                            <span class="text-muted">No answer</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ result.correct_answer }}</td>
                                        <td class="align-middle">
                                            {% if result.is_correct %}
                                            <span class="badge bg-success">Correct</span>
                                            {% elif result.is_answered %}
                                            <span class="badge bg-danger">Incorrect</span>
                                            {% else %}
                                            <span class="badge bg-warning text-dark">Unanswered</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <a href="{% url 'view_mcq' mcq_id=result.mcq.id %}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> Review
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Subspecialty performance chart
    const ctx = document.getElementById('subspecialtyChart').getContext('2d');
    
    // Data from Django
    const subspecialtyData = {
        labels: [
            {% for subspecialty, stats in subspecialty_results.items %}
            "{{ subspecialty }}",
            {% endfor %}
        ],
        datasets: [{
            label: 'Score (%)',
            data: [
                {% for subspecialty, stats in subspecialty_results.items %}
                {{ stats.percentage }},
                {% endfor %}
            ],
            backgroundColor: [
                {% for subspecialty, stats in subspecialty_results.items %}
                "{{ stats.percentage|floatformat:0 }}" >= 70 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)',
                {% endfor %}
            ],
            borderColor: [
                {% for subspecialty, stats in subspecialty_results.items %}
                "{{ stats.percentage|floatformat:0 }}" >= 70 ? 'rgb(40, 167, 69)' : 'rgb(220, 53, 69)',
                {% endfor %}
            ],
            borderWidth: 1
        }]
    };
    
    // Create horizontal bar chart
    const subspecialtyChart = new Chart(ctx, {
        type: 'bar',
        data: subspecialtyData,
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const datasetLabel = context.dataset.label || '';
                            const value = context.parsed.x;
                            const total = context.dataset.data[context.dataIndex];
                            return `${datasetLabel}: ${value}%`;
                        },
                        afterLabel: function(context) {
                            const labels = [
                                {% for subspecialty, stats in subspecialty_results.items %}
                                `{{ stats.correct }}/${stats.total }} correct`,
                                {% endfor %}
                            ];
                            return labels[context.dataIndex];
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        display: true
                    }
                },
                y: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}