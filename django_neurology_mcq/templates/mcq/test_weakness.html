{% extends "mcq/base.html" %}
{% load static %}

{% block title %}Test My Weakness - Neurology MCQ Reader{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Test My Weakness</h4>
                <div>
                    <span class="badge bg-light text-dark p-2">Strengthening your knowledge gaps</span>
                </div>
            </div>
            <div class="card-body p-3">
                {% if mcq %}
                <div class="alert alert-warning mb-4">
                    <h5><i class="bi bi-lightbulb"></i> Knowledge Gap Identified</h5>
                    <p>This is a new question designed to test your understanding of a concept you previously struggled with. The original question you answered incorrectly was about:</p>
                    <p class="fw-bold">"{{ original_mcq.question_text|truncatechars:150 }}"</p>
                    <p>You selected <strong>{{ original_answer }}</strong> but the correct answer was <strong>{{ original_mcq.correct_answer }}</strong>.</p>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">New Question</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">{{ mcq.question_text }}</p>
                        
                        <form id="weaknessAnswerForm" action="{% url 'check_weakness_answer' mcq_id=mcq.id %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="original_mcq_id" value="{{ original_mcq.id }}">
                            
                            <div class="options-container">
                                {% if mcq.options %}
                                    {% for option_letter, option_text in mcq.options.items %}
                                    <div class="option form-check mb-2 p-2 border-start border-2">
                                        <input class="form-check-input" type="radio" name="answer" id="answer-{{ option_letter }}" value="{{ option_letter }}">
                                        <label class="form-check-label" for="answer-{{ option_letter }}">
                                            <strong>{{ option_letter }}.</strong> {{ option_text }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="alert alert-warning">No options available for this MCQ.</div>
                                {% endif %}
                            </div>
                            
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" id="checkWeaknessBtn" class="btn btn-danger">
                                    <i class="bi bi-check-circle"></i> Check Answer
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="explanationSection" style="display: none;">
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Explanation</h5>
                        </div>
                        <div class="card-body">
                            <div id="resultAlert" class="alert mb-4"></div>
                            <div id="explanationContent" class="explanation-content"></div>
                            
                            <div class="concept-explanation mt-4">
                                <h5>Understanding the Concept</h5>
                                <div id="conceptExplanation" class="p-3 border rounded bg-light"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                    <a href="{% url 'test_weakness' %}" class="btn btn-outline-danger" id="nextWeaknessBtn" style="display: none;">
                        <i class="bi bi-arrow-right"></i> Test Another Weakness
                    </a>
                </div>
                
                {% else %}
                <div class="py-5 text-center">
                    {% if no_weaknesses %}
                    <div class="mb-4">
                        <i class="bi bi-emoji-smile text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h3>Great job!</h3>
                    <p class="lead text-muted">You don't have any identified knowledge gaps to test.</p>
                    <p>Continue practicing and challenging yourself with new questions.</p>
                    <a href="{% url 'dashboard' %}" class="btn btn-primary mt-3">
                        <i class="bi bi-house"></i> Return to Dashboard
                    </a>
                    {% else %}
                    <div class="mb-4">
                        <div class="spinner-border text-danger" style="width: 4rem; height: 4rem;" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <h3>Generating New Question</h3>
                    <p class="lead text-muted">We're preparing a targeted question based on your previous mistakes.</p>
                    <p>This might take a few moments as our AI generates a meaningful challenge for you.</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const weaknessAnswerForm = document.getElementById('weaknessAnswerForm');
    const checkWeaknessBtn = document.getElementById('checkWeaknessBtn');
    
    if (weaknessAnswerForm && checkWeaknessBtn) {
        weaknessAnswerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Check if an answer is selected
            const selectedAnswer = document.querySelector('input[name="answer"]:checked');
            if (!selectedAnswer) {
                alert('Please select an answer first.');
                return;
            }
            
            // Show loading state
            checkWeaknessBtn.disabled = true;
            checkWeaknessBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
            
            // Get form data and submit
            const formData = new FormData(weaknessAnswerForm);
            
            fetch(weaknessAnswerForm.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Show explanation section
                document.getElementById('explanationSection').style.display = 'block';
                
                // Mark the selected answer
                const options = document.querySelectorAll('.option');
                options.forEach(option => {
                    option.classList.remove('option-correct', 'option-incorrect');
                });
                
                const selectedOption = document.querySelector(`#answer-${selectedAnswer.value}`).closest('.option');
                
                if (data.is_correct) {
                    // Show success message
                    const resultAlert = document.getElementById('resultAlert');
                    resultAlert.className = 'alert alert-success';
                    resultAlert.innerHTML = '<h5><i class="bi bi-check-circle"></i> Correct!</h5><p>Great job! You\'ve mastered this concept.</p>';
                    
                    // Mark option as correct
                    selectedOption.classList.add('option-correct');
                } else {
                    // Show error message
                    const resultAlert = document.getElementById('resultAlert');
                    resultAlert.className = 'alert alert-danger';
                    resultAlert.innerHTML = `<h5><i class="bi bi-x-circle"></i> Incorrect</h5><p>The correct answer is <strong>${data.correct_answer}</strong>.</p>`;
                    
                    // Mark options accordingly
                    selectedOption.classList.add('option-incorrect');
                    const correctOption = document.querySelector(`#answer-${data.correct_answer}`).closest('.option');
                    correctOption.classList.add('option-correct');
                }
                
                // Display explanation
                document.getElementById('explanationContent').innerHTML = data.explanation || 'No explanation available.';
                
                // Display concept explanation
                document.getElementById('conceptExplanation').innerHTML = data.concept_explanation || 'No concept explanation available.';
                
                // Enable the next weakness button
                document.getElementById('nextWeaknessBtn').style.display = 'block';
                
                // Scroll to explanation
                document.getElementById('explanationSection').scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error checking answer:', error);
                alert('An error occurred while checking your answer. Please try again.');
                
                // Reset button state
                checkWeaknessBtn.disabled = false;
                checkWeaknessBtn.innerHTML = '<i class="bi bi-check-circle"></i> Check Answer';
            });
        });
    }
});
</script>
{% endblock %}